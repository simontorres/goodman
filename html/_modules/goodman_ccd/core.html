
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>goodman_ccd.core &#8212; Goodman Pipelines 1.0b1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0b1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for goodman_ccd.core</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">ccdproc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Timer</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;GTK3Agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">CCDData</span><span class="p">,</span> <span class="n">ImageFileCollection</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">EarthLocation</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astroplan</span> <span class="k">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fitting</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;goodmanccd.core&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="convert_time"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.convert_time">[docs]</a><span class="k">def</span> <span class="nf">convert_time</span><span class="p">(</span><span class="n">in_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts time to seconds since epoch</span>

<span class="sd">    Args:</span>
<span class="sd">        in_time (str): time obtained from header&#39;s keyword DATE-OBS</span>

<span class="sd">    Returns:</span>
<span class="sd">        time in seconds since epoch</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">in_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="fix_duplicated_keywords"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.fix_duplicated_keywords">[docs]</a><span class="k">def</span> <span class="nf">fix_duplicated_keywords</span><span class="p">(</span><span class="n">night_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove duplicated keywords</span>

<span class="sd">    There are some cases when the raw data comes with duplicated keywords.</span>
<span class="sd">    The origin has not been tracked down. The solution is to identify the</span>
<span class="sd">    duplicated keywords and the remove all but one from the end backwards.</span>

<span class="sd">    Args:</span>
<span class="sd">        night_dir (str): The full path for the raw data location</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding duplicated keywords&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Files will be overwritten&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">night_dir</span><span class="p">,</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">))</span>
    <span class="c1"># Pick a random file to find duplicated keywords</span>
    <span class="n">random_file</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">random_file</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span>
    <span class="c1"># Put the duplicated keywords in a list</span>
    <span class="n">multiple_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">multiple_keys</span><span class="p">:</span>
                    <span class="n">multiple_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">multiple_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found {:d} duplicated keyword &#39;</span>
                 <span class="s1">&#39;{:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multiple_keys</span><span class="p">),</span>
                               <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing Image File: {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">multiple_keys</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span>
                                          <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overwriting file with duplicated keywords removed&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> overwritten&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="ra_dec_to_deg"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.ra_dec_to_deg">[docs]</a><span class="k">def</span> <span class="nf">ra_dec_to_deg</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">,</span> <span class="n">declination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts right ascension and declination to degrees</span>

<span class="sd">    Args:</span>
<span class="sd">        right_ascension (str): Right ascension in the format hh:mm:ss.sss</span>
<span class="sd">        declination (str): Declination in the format dd:mm:ss.sss</span>

<span class="sd">    Returns:</span>
<span class="sd">        right_ascension_deg (float): Right ascension in degrees</span>
<span class="sd">        declination_deg (float): Declination in degrees</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">right_ascension</span> <span class="o">=</span> <span class="n">right_ascension</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">declination</span> <span class="o">=</span> <span class="n">declination</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

    <span class="c1"># RIGHT ASCENTION conversion</span>
    <span class="n">right_ascension_deg</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                           <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                              <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">*</span> \
                          <span class="p">(</span><span class="mf">360.</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">)</span>

    <span class="c1"># DECLINATION conversion</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">declination_deg</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                              <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                 <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">right_ascension_deg</span><span class="p">,</span> <span class="n">declination_deg</span></div>


<div class="viewcode-block" id="print_spacers"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_spacers">[docs]</a><span class="k">def</span> <span class="nf">print_spacers</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Miscelaneous function to print uniform spacers</span>

<span class="sd">    Prints a spacer of 80 columns with  and 3 rows height. The first and last</span>
<span class="sd">    rows contains the symbol &quot;=&quot; repeated 80 times. The middle row contains the</span>
<span class="sd">    message centered and the extremes has one single &quot;=&quot; symbol.</span>
<span class="sd">    The only functionality of this is aesthetic.</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str): A message to be printed</span>

<span class="sd">    Returns:</span>
<span class="sd">        True (bool): A True value</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">columns</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">bar_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">spacer_bar</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">bar_length</span>
    <span class="n">blanks</span> <span class="o">=</span> <span class="n">bar_length</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">space_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">blanks</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">message_bar</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">space_length</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">space_length</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">spacer_bar</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">message_bar</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">spacer_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="print_progress"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_progress">[docs]</a><span class="k">def</span> <span class="nf">print_progress</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints the percentage of a progress</span>

<span class="sd">    It works for FOR loops, requires to know the full length of the loop.</span>
<span class="sd">    Prints to the standard output.</span>

<span class="sd">    Args:</span>
<span class="sd">        current (int): Current value in the range of the loop.</span>
<span class="sd">        total (int): The length of the loop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Progress {:.2%}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Progress {:.2%}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="get_twilight_time"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_twilight_time">[docs]</a><span class="k">def</span> <span class="nf">get_twilight_time</span><span class="p">(</span><span class="n">date_obs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get end/start time of evening/morning twilight</span>

<span class="sd">    Notes:</span>
<span class="sd">        Taken from David Sanmartim&#39;s development</span>

<span class="sd">    Args:</span>
<span class="sd">        date_obs (list): List of all the dates from data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        twilight_evening (str): Evening twilight time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        twilight_morning (str): Morning twilight time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        sun_set_time (str): Sun set time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        sun_rise_time (str): Sun rise time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># observatory(str): Observatory name.</span>
    <span class="n">observatory</span> <span class="o">=</span> <span class="s1">&#39;SOAR Telescope&#39;</span>
    <span class="n">geodetic_location</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-70d44m01.11s&#39;</span><span class="p">,</span> <span class="s1">&#39;-30d14m16.41s&#39;</span><span class="p">,</span> <span class="mi">2748</span><span class="p">]</span>
    <span class="c1"># longitude (str): Geographic longitude in string format</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># latitude (str): Geographic latitude in string format.</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># elevation (int): Geographic elevation in meters above sea level</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># timezone (str): Time zone.</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
    <span class="c1"># description(str): Observatory description</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Soar Telescope on Cerro Pachon, Chile&#39;</span>

    <span class="n">soar_loc</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span>
                                           <span class="n">latitude</span><span class="p">,</span>
                                           <span class="n">elevation</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                           <span class="n">ellipsoid</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>

    <span class="n">soar</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">observatory</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">soar_loc</span><span class="p">,</span>
                    <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="n">time_first_frame</span><span class="p">,</span> <span class="n">time_last_frame</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">date_obs</span><span class="p">)),</span> <span class="n">Time</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">date_obs</span><span class="p">))</span>

    <span class="n">twilight_evening</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_evening_astronomical</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_first_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">twilight_morning</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_morning_astronomical</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_last_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">sun_set_time</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">sun_set_time</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_first_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">sun_rise_time</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">sun_rise_time</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_last_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sun Set &#39;</span> <span class="o">+</span> <span class="n">sun_set_time</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sun Rise &#39;</span> <span class="o">+</span> <span class="n">sun_rise_time</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">,</span> <span class="n">sun_set_time</span><span class="p">,</span> <span class="n">sun_rise_time</span></div>


<div class="viewcode-block" id="image_overscan"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.image_overscan">[docs]</a><span class="k">def</span> <span class="nf">image_overscan</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">overscan_region</span><span class="p">,</span> <span class="n">add_keyword</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply overscan to data</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance</span>
<span class="sd">        overscan_region (str): The overscan region in the format &#39;[x1:x2,y1:y2]&#39;</span>
<span class="sd">            where x is the spectral axis and y is the spatial axis.</span>
<span class="sd">        add_keyword (bool): Tells ccdproc whether to add a keyword or not.</span>
<span class="sd">            Default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Overscan corrected ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_overscan</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                    <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">fits_section</span><span class="o">=</span><span class="n">overscan_region</span><span class="p">,</span>
                                    <span class="n">add_keyword</span><span class="o">=</span><span class="n">add_keyword</span><span class="p">)</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Applied overscan correction &#39;</span> <span class="o">+</span> <span class="n">overscan_region</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="image_trim"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.image_trim">[docs]</a><span class="k">def</span> <span class="nf">image_trim</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">trim_section</span><span class="p">,</span> <span class="n">add_keyword</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trim image to a given section</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance</span>
<span class="sd">        trim_section (str): The trimming section in the format &#39;[x1:x2,y1:y2]&#39;</span>
<span class="sd">            where x is the spectral axis and y is the spatial axis.</span>
<span class="sd">        add_keyword (bool): Tells ccdproc whether to add a keyword or not.</span>
<span class="sd">            Default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Trimmed ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                             <span class="n">fits_section</span><span class="o">=</span><span class="n">trim_section</span><span class="p">,</span>
                             <span class="n">add_keyword</span><span class="o">=</span><span class="n">add_keyword</span><span class="p">)</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Trimmed image to &#39;</span> <span class="o">+</span> <span class="n">trim_section</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="get_slit_trim_section"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_slit_trim_section">[docs]</a><span class="k">def</span> <span class="nf">get_slit_trim_section</span><span class="p">(</span><span class="n">master_flat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the slit edges to trim all data</span>

<span class="sd">    Using a master flat, ideally good signal to noise ratio, this function will</span>
<span class="sd">    identify the edges of the slit projected into the detector. Having this data</span>
<span class="sd">    will allow to reduce the overall processing time and also reduce the</span>
<span class="sd">    introduction of artifacts due to non-illuminated regions in the detectors,</span>
<span class="sd">    such as NaNs -INF +INF, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">        master_flat (object): A ccdproc.CCDData instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        slit_trim_section (str): Trim section in spatial direction in the format</span>
<span class="sd">            [:,slit_lower_limit:slit_higher_limit]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">master_flat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Using the middle point to make calculations, usually flats have good</span>
    <span class="c1"># illumination already at the middle.</span>
    <span class="n">middle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">ccd_section</span> <span class="o">=</span> <span class="n">master_flat</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">middle</span><span class="p">:</span><span class="n">middle</span> <span class="o">+</span> <span class="mi">200</span><span class="p">]</span>
    <span class="n">ccd_section_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ccd_section</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># spatial_axis = range(len(ccd_section_median))</span>

    <span class="c1"># Spatial half will be used later to constrain the detection of the first</span>
    <span class="c1"># edge before the first half.</span>
    <span class="n">spatial_half</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="c1"># pseudo-derivative to help finding the edges.</span>
    <span class="n">pseudo_derivative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ccd_section_median</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pseudo_derivative</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">pseudo_derivative</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
        <span class="n">pseudo_derivative</span><span class="p">,</span>
        <span class="kc">None</span><span class="p">)</span>

    <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">argrelmax</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">slit_trim_section</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">peaks</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No trim section&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># This is the ideal case, when the two edges of the slit are found.</span>
            <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">peaks</span>
            <span class="n">slit_trim_section</span> <span class="o">=</span> <span class="s1">&#39;[:,{:d}:{:d}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># when only one peak is found it will choose the largest region from</span>
            <span class="c1"># the spatial axis center to one edge.</span>
            <span class="k">if</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">spatial_half</span><span class="p">:</span>
                <span class="n">slit_trim_section</span> <span class="o">=</span> <span class="s1">&#39;[:,{:d}:{:d}]&#39;</span> \
                                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">slit_trim_section</span> <span class="o">=</span> <span class="s1">&#39;[:,{:d}:{:d}]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">slit_trim_section</span></div>


<div class="viewcode-block" id="dcr_cosmicray_rejection"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.dcr_cosmicray_rejection">[docs]</a><span class="k">def</span> <span class="nf">dcr_cosmicray_rejection</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dcr_par_dir</span><span class="p">,</span>
                            <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs an external code for cosmic ray rejection</span>

<span class="sd">    DCR was created by Wojtek Pych and the code can be obtained from</span>
<span class="sd">    http://users.camk.edu.pl/pych/DCR/ and is written in C</span>

<span class="sd">    Args:</span>
<span class="sd">        data_path (str): Data location</span>
<span class="sd">        in_file (str): Name of the file to have its cosmic rays removed</span>
<span class="sd">        prefix (str): Prefix to add to the file with the cosmic rays removed</span>
<span class="sd">        dcr_par_dir (str): Directory of default dcr.par file</span>
<span class="sd">        delete (bool): True for deleting the input and cosmic ray file.</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing cosmic rays using DCR by Wojtek Pych&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;See http://users.camk.edu.pl/pych/DCR/&#39;</span><span class="p">)</span>

    <span class="c1"># add the prefix for the output file</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">in_file</span>

    <span class="c1"># define the name for the cosmic rays file</span>
    <span class="n">cosmic_file</span> <span class="o">=</span> <span class="s1">&#39;cosmic_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># define full path for all the files involved</span>
    <span class="n">full_path_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>
    <span class="n">full_path_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
    <span class="n">full_path_cosmic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">cosmic_file</span><span class="p">)</span>

    <span class="c1"># this is the command for running dcr, all arguments are required</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;dcr {:s} {:s} {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">,</span>
                                          <span class="n">full_path_out</span><span class="p">,</span>
                                          <span class="n">full_path_cosmic</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DCR command:&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="c1"># print(command.split(&#39; &#39;))</span>

    <span class="c1"># get the current working directory to go back to it later in case the</span>
    <span class="c1"># the pipeline has not been called from the same data directory.</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># move to the directory were the data is, dcr is expecting a file dcr.par</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># check if file dcr.par exists</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;dcr.par&#39;</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;File dcr.par does not exist. Copying default one.&#39;</span><span class="p">)</span>
        <span class="n">dcr_par_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dcr_par_dir</span><span class="p">,</span> <span class="s1">&#39;dcr.par&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;dcr.par full path: {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find dcr.par file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;File dcr.par exists.&#39;</span><span class="p">)</span>

    <span class="c1"># call dcr</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">dcr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
                               <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                               <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Your system can not locate the executable file dcr, try &#39;</span>
                 <span class="s1">&#39;moving it to /bin or create a symbolic link</span><span class="se">\n\n\t</span><span class="s1">cd /bin</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;sudo ln -s /full/path/to/dcr&#39;</span><span class="p">)</span>

        <span class="c1"># return False</span>

    <span class="c1"># if the process is taking too long to respond, kill it</span>
    <span class="c1"># kill_process = lambda process: process.kill()</span>
    <span class="k">def</span> <span class="nf">kill_process</span><span class="p">(</span><span class="n">process</span><span class="p">):</span> <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="n">dcr_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">kill_process</span><span class="p">,</span> <span class="p">[</span><span class="n">dcr</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dcr_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">dcr</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">dcr_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="c1"># wait for dcr to terminate</span>
    <span class="c1"># dcr.wait()</span>

    <span class="c1"># go back to the original directory. Could be the same.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># read stdout and stderr</span>
    <span class="c1"># stdout = dcr.stdout.read()</span>
    <span class="c1"># stderr = dcr.stderr.read()</span>

    <span class="c1"># If no error stderr is an empty string</span>
    <span class="k">if</span> <span class="n">stderr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;dcr: not found&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Your system can not locate the executable file dcr, try &#39;</span>
                 <span class="s1">&#39;moving it to /bin or create a symbolic link</span><span class="se">\n\n\t</span><span class="s1">cd /bin</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;sudo ln -s /full/path/to/dcr&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output_line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output_line</span><span class="p">)</span>

    <span class="c1"># delete extra files only if the execution ended without error</span>
    <span class="k">if</span> <span class="n">delete</span> <span class="ow">and</span> <span class="n">stderr</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="s1">&#39;USAGE:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Removing input file: {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Removing cosmic rays file: {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_cosmic</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">full_path_cosmic</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="cosmicray_rejection"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.cosmicray_rejection">[docs]</a><span class="k">def</span> <span class="nf">cosmicray_rejection</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">mask_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do cosmic ray rejection</span>

<span class="sd">    This function in fact does not apply any correction, it detects the cosmic</span>
<span class="sd">    rays and updates the attribute mask of the ccd object (CCDData instance).</span>
<span class="sd">    The attribute mask is used later as a mask for the pixels hit by cosmic rays</span>

<span class="sd">      Notes:</span>
<span class="sd">          OBS: cosmic ray rejection is working pretty well by defining gain = 1.</span>
<span class="sd">          It&#39;s not working when we use the real gain of the image. In this case</span>
<span class="sd">          the sky level changes by a factor equal the gain.</span>
<span class="sd">          Function to determine the sigfrac and objlim: y = 0.16 * exptime + 1.2</span>

<span class="sd">      Args:</span>
<span class="sd">          ccd (object): CCDData Object</span>
<span class="sd">          mask_only (bool): In some cases you may want to obtain the cosmic</span>
<span class="sd">              rays mask only</span>

<span class="sd">      Returns:</span>
<span class="sd">          ccd (object): A CCDData instance with the mask attribute updated.</span>

<span class="sd">      &quot;&quot;&quot;</span>
    <span class="c1"># TODO (simon): Validate this method</span>
    <span class="k">if</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mf">0.16</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.2</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning cosmic rays... &#39;</span><span class="p">)</span>

        <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">cosmicray_lacosmic</span><span class="p">(</span>
            <span class="n">ccd</span><span class="p">,</span>
            <span class="n">sigclip</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
            <span class="n">sigfrac</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">objlim</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">]),</span>
            <span class="n">readnoise</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]),</span>
            <span class="n">satlevel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="n">sepmed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fsmode</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
            <span class="n">psfmodel</span><span class="o">=</span><span class="s1">&#39;gaussy&#39;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s2">&quot;Cosmic rays rejected with LACosmic&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cosmic rays rejected with LACosmic&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ccd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping cosmic ray rejection for image of datatype: &#39;</span>
                 <span class="s1">&#39;{:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="get_best_flat"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_best_flat">[docs]</a><span class="k">def</span> <span class="nf">get_best_flat</span><span class="p">(</span><span class="n">flat_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look for matching master flat</span>

<span class="sd">    Given a basename for masterflats defined as a combination of key parameters</span>
<span class="sd">    extracted from the header of the image that we want to flatfield, this</span>
<span class="sd">    function will find the name of the files that matches the base name and then</span>
<span class="sd">    will choose the first. Ideally this should go further as to check signal,</span>
<span class="sd">    time gap, etc.</span>
<span class="sd">    After it identifies the file it will load it using ccdproc.CCDData and</span>
<span class="sd">    return it along the filename.</span>
<span class="sd">    In case if fails it will return None instead of master_flat and another</span>
<span class="sd">    None instead of master_flat_name.</span>

<span class="sd">    Args:</span>
<span class="sd">        flat_name (str): Full path of masterflat basename. Ends in &#39;*.fits&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        master_flat (object): A ccdproc.CCDData instance</span>
<span class="sd">        master_flat_name (str): Full path to the chosen masterflat.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flat_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">flat_name</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Flat base name {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flat_name</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Matching master flats found: {:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">master_flat_name</span> <span class="o">=</span> <span class="n">flat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">master_flat_name</span> <span class="o">=</span> <span class="n">flat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># elif any(&#39;dome&#39; in flat for flat in flat_list):</span>
        <span class="c1">#     master_flat_name =</span>

        <span class="n">master_flat</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">master_flat_name</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found suitable master flat: {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master_flat_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">master_flat</span><span class="p">,</span> <span class="n">master_flat_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There is no flat available&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="print_default_args"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_default_args">[docs]</a><span class="k">def</span> <span class="nf">print_default_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print default values of arguments.</span>

<span class="sd">    This is mostly helpful for debug but people not familiar with the software</span>
<span class="sd">    might find it useful as well</span>

<span class="sd">    Notes:</span>
<span class="sd">        This is not dynamically updated so use with caution</span>

<span class="sd">    Args:</span>
<span class="sd">        args (object): An argparse instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;auto_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;--auto-clean&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_cosmic&#39;</span><span class="p">:</span> <span class="s1">&#39;-c, --cosmic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;debug_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;flat_normalize&#39;</span><span class="p">:</span> <span class="s1">&#39;--flat-normalize&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ignore_bias&#39;</span><span class="p">:</span> <span class="s1">&#39;--ignore-bias&#39;</span><span class="p">,</span>
                <span class="s1">&#39;log_to_file&#39;</span><span class="p">:</span> <span class="s1">&#39;--log-to-file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;norm_order&#39;</span><span class="p">:</span> <span class="s1">&#39;--flat-norm-order&#39;</span><span class="p">,</span>
                <span class="s1">&#39;raw_path&#39;</span><span class="p">:</span> <span class="s1">&#39;--raw-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;red_path&#39;</span><span class="p">:</span> <span class="s1">&#39;--red-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;saturation_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;--saturation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;destiny&#39;</span><span class="p">:</span> <span class="s1">&#39;-d --proc-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;interactive_ws&#39;</span><span class="p">:</span> <span class="s1">&#39;-i --interactive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lamp_all_night&#39;</span><span class="p">:</span> <span class="s1">&#39;-r --reference-lamp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lamp_file&#39;</span><span class="p">:</span> <span class="s1">&#39;-l --lamp-file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;output_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;-o --output-prefix&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;-s --search-pattern&#39;</span><span class="p">,</span>
                <span class="s1">&#39;procmode&#39;</span><span class="p">:</span> <span class="s1">&#39;-m --proc-mode&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reference_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;-R --reference-files&#39;</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;-p --data-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;save_plots&#39;</span><span class="p">:</span> <span class="s1">&#39;--save-plots&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dcr_par_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;--dcr-par-dir&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Default value for {:s} is {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arg_name</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                                         <span class="nb">str</span><span class="p">(</span>
                                                             <span class="n">args</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span>
                                                                 <span class="n">key</span><span class="p">))))</span></div>


<div class="viewcode-block" id="normalize_master_flat"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.normalize_master_flat">[docs]</a><span class="k">def</span> <span class="nf">normalize_master_flat</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Master flat normalization method</span>

<span class="sd">    This function normalize a master flat in three possible ways:</span>
<span class="sd">     _mean_: simply divide the data by its mean</span>

<span class="sd">     _simple_: Calculates the median along the spatial axis in order to obtain</span>
<span class="sd">     the dispersion profile. Then fits a Chebyshev1D model and apply this to all</span>
<span class="sd">     the data.</span>

<span class="sd">     _full_: This is for experimental purposes only because it takes a lot of</span>
<span class="sd">     time to process. It will fit a model to each line along the dispersion axis</span>
<span class="sd">     and then divide it by the fitted model. I do not recommend this method</span>
<span class="sd">     unless you have a good reason as well as a powerful computer.</span>

<span class="sd">    Args:</span>
<span class="sd">        master (object): Master flat. Has to be a ccdproc.CCDData instance</span>
<span class="sd">        name (str): Full path of master flat prior to normalization</span>
<span class="sd">        method (str): Normalization method, &#39;mean&#39;, &#39;simple&#39; or &#39;full&#39;</span>
<span class="sd">        order (int): Order of the polinomial to be fitted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        master (object):  The normalized master flat. ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>

    <span class="c1"># define new name, base path and full new name</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;norm_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">norm_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Normalizing by mean&#39;</span><span class="p">)</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by Mean&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Normalizing flat by {:s} model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="c1"># Initialize Fitting models and fitter</span>
        <span class="n">model_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

        <span class="c1"># get data shape</span>
        <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="c1"># get profile along dispersion axis to fit a model to use for</span>
            <span class="c1"># normalization</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># do the actual fit</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model_init</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>

            <span class="c1"># convert fit into an array</span>
            <span class="n">fit_array</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>

            <span class="c1"># pythonic way to divide an array by a vector</span>
            <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">fit_array</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by simple model&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This part of the code was left here for experimental &#39;</span>
                        <span class="s1">&#39;purposes only&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;This procedure takes a lot to process, you might want to&#39;</span>
                     <span class="s1">&#39;see other method such as simple or mean.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_size</span><span class="p">):</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model_init</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">fit</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
            <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by full model&#39;</span><span class="p">)</span>

    <span class="c1"># write normalized flat to a file</span>
    <span class="n">master</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">norm_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">master</span></div>


<div class="viewcode-block" id="get_central_wavelength"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_central_wavelength">[docs]</a><span class="k">def</span> <span class="nf">get_central_wavelength</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">grt_ang</span><span class="p">,</span> <span class="n">cam_ang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the central wavelength for a given spectroscopic mode</span>

<span class="sd">    The equation used to calculate the central wavelength is the following</span>


<span class="sd">    $$\lambda_{central} = \frac{1e6}{GRAT}</span>
<span class="sd">    \sin\left(\frac{\alpha \pi}{180}\right) +</span>
<span class="sd">    \sin\left(\frac{\beta \pi}{180}\right)$$</span>

<span class="sd">    Args:</span>
<span class="sd">        grating:</span>
<span class="sd">        grt_ang:</span>
<span class="sd">        cam_ang:</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grating_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grating</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grt_ang</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cam_ang</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">grt_ang</span><span class="p">)</span>

    <span class="n">central_wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">e6</span> <span class="o">/</span> <span class="n">grating_frequency</span><span class="p">)</span> <span class="o">*</span> \
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">))</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found {:.3f} as central wavelength&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">central_wavelength</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">central_wavelength</span></div>


<span class="c1"># spectroscopy specific functions</span>

<div class="viewcode-block" id="classify_spectroscopic_data"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.classify_spectroscopic_data">[docs]</a><span class="k">def</span> <span class="nf">classify_spectroscopic_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">search_pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classify data by grouping them as pandas.DataFrame instances</span>

<span class="sd">    This functions uses ImageFileCollection from ccdproc. First it creates a</span>
<span class="sd">    collection of information regarding the images located in _path_ that match</span>
<span class="sd">    the pattern _search_pattern_</span>
<span class="sd">    The information obtained are all keywords listed in the list _keywords_</span>
<span class="sd">    The ImageFileCollection is translated into pandas.DataFrame and then is used</span>
<span class="sd">    much like SQL database to select and filter values and in that way put them</span>
<span class="sd">    in groups that are pandas.DataFrame instances.</span>


<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to data location</span>
<span class="sd">        search_pattern (str): Prefix to match files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_container (object): Instance of NightDataContainer</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">search_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">search_pattern</span> <span class="o">+</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">)</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">search_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_list</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No file found using search pattern &#39;</span>
                  <span class="s1">&#39;&quot;{:s}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_pattern</span><span class="p">))</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Please use the argument --search-pattern to define the &#39;</span>
                 <span class="s1">&#39;common prefix for the files to be processed.&#39;</span><span class="p">)</span>

    <span class="n">data_container</span> <span class="o">=</span> <span class="n">NightDataContainer</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                        <span class="n">instrument</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Red&#39;</span><span class="p">),</span>
                                        <span class="n">technique</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Spectroscopy&#39;</span><span class="p">))</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                <span class="s1">&#39;slit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;date-obs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obstype&#39;</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exptime&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obsra&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obsdec&#39;</span><span class="p">,</span>
                <span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cam_targ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;grt_targ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filter2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rdnoise&#39;</span><span class="p">]</span>

    <span class="n">ifc</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">file_list</span><span class="p">)</span>

    <span class="n">pifc</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

    <span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;radeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;decdeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pifc</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">radeg</span><span class="p">,</span> <span class="n">decdeg</span> <span class="o">=</span> <span class="n">ra_dec_to_deg</span><span class="p">(</span><span class="n">pifc</span><span class="o">.</span><span class="n">obsra</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pifc</span><span class="o">.</span><span class="n">obsdec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">pifc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pifc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;radeg&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;{:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radeg</span><span class="p">)</span>

        <span class="n">pifc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pifc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;decdeg&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;{:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">decdeg</span><span class="p">)</span>
        <span class="c1"># now we can compare using degrees</span>

    <span class="n">confs</span> <span class="o">=</span> <span class="n">pifc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;slit&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;radeg&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;decdeg&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;cam_targ&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;grt_targ&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;filter2&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;rdnoise&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">confs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">spec_group</span> <span class="o">=</span> <span class="n">pifc</span><span class="p">[((</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;slit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;slit&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;radeg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;radeg&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;decdeg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;decdeg&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;grating&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;filter2&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;gain&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;rdnoise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;rdnoise&#39;</span><span class="p">]))]</span>

        <span class="n">data_container</span><span class="o">.</span><span class="n">add_spec_group</span><span class="p">(</span><span class="n">spec_group</span><span class="o">=</span><span class="n">spec_group</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_container</span></div>


<div class="viewcode-block" id="spectroscopic_extraction"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.spectroscopic_extraction">[docs]</a><span class="k">def</span> <span class="nf">spectroscopic_extraction</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">extraction</span><span class="p">,</span>
                             <span class="n">comp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">n_sigma_extract</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function does not do the actual extraction but prepares the data</span>



<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData Instance</span>
<span class="sd">        extraction (str): Extraction type name. _simple_ or _optimal_</span>
<span class="sd">        comp_list (list): List of ccdproc.CCDData instances of COMP lamps data</span>
<span class="sd">        n_sigma_extract (int): Number of sigmas to be used for extraction</span>
<span class="sd">        plots (bool): If plots will be shown or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        extracted (list): List of ccdproc.CCDData instances</span>
<span class="sd">        comp_zones (list): List of ccdproc.CCDData instances</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoTargetException (Exception): A NoTargetException if there is no target</span>
<span class="sd">           found.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>

    <span class="n">comp_zones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">comp_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">iccd</span> <span class="o">=</span> <span class="n">remove_background</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">)</span>

    <span class="n">profile_model</span> <span class="o">=</span> <span class="n">identify_targets</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">iccd</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
    <span class="k">del</span> <span class="p">(</span><span class="n">iccd</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile_model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="n">trace_targets</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
        <span class="c1"># extract(ccd=ccd,</span>
        <span class="c1">#         spatial_profile=profile_model,</span>
        <span class="c1">#         n_sigma_extract=10,</span>
        <span class="c1">#         sampling_step=5)</span>
        <span class="k">if</span> <span class="s1">&#39;CompoundModel&#39;</span> <span class="ow">in</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)):</span>

                <span class="n">submodel_name</span> <span class="o">=</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                <span class="n">nccd</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span>
                    <span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                    <span class="n">trace</span><span class="o">=</span><span class="n">traces</span><span class="p">[</span><span class="n">m</span><span class="p">],</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">[</span><span class="n">submodel_name</span><span class="p">],</span>
                    <span class="n">n_sigma_extract</span><span class="o">=</span><span class="n">n_sigma_extract</span><span class="p">,</span>
                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                    <span class="n">comp_zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                                    <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
                                                    <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
                    <span class="c1"># since a comparison lamp only needs only the relative line</span>
                    <span class="c1"># center in the dispersion direction, therefore the flux is</span>
                    <span class="c1"># not important we are only calculating the median along the</span>
                    <span class="c1"># spatial direction</span>
                    <span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">comp_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_zone</span><span class="p">)</span>

                <span class="n">nccd</span> <span class="o">=</span> <span class="n">remove_background</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">nccd</span><span class="p">,</span>
                                         <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

                <span class="n">extracted_ccd</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">nccd</span><span class="p">,</span>
                                        <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
                                        <span class="n">spatial_profile</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                        <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                        <span class="n">sampling_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                        <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
                <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_ccd</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nccd</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">nccd</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span>
                <span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                <span class="n">trace</span><span class="o">=</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span>
                <span class="n">n_sigma_extract</span><span class="o">=</span><span class="n">n_sigma_extract</span><span class="p">,</span>
                <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="n">comp_zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                                <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                                <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
                                                <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                                <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

                <span class="c1"># since a comparison lamp only needs the relative line</span>
                <span class="c1"># center in the dispersion direction, therefore the flux is not</span>
                <span class="c1"># important we are only calculating the median along the spatial</span>
                <span class="c1"># direction</span>
                <span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">comp_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_zone</span><span class="p">)</span>

            <span class="n">nccd</span> <span class="o">=</span> <span class="n">remove_background</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">nccd</span><span class="p">,</span>
                                     <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

            <span class="n">extracted_ccd</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">nccd</span><span class="p">,</span>
                                    <span class="n">trace</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span>
                                    <span class="n">spatial_profile</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                    <span class="n">sampling_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

            <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_ccd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nccd</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># print(extracted)</span>
        <span class="c1"># print(comp_zones)</span>
        <span class="k">return</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">comp_zones</span>

    <span class="k">elif</span> <span class="n">profile_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t receive identified targets &quot;</span>
                    <span class="s2">&quot;from {:s}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">NoTargetException</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got wrong input&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="identify_targets"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.identify_targets">[docs]</a><span class="k">def</span> <span class="nf">identify_targets</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify targets cross correlating spatial profile with a gaussian model</span>

<span class="sd">    The method of cross-correlating a gaussian model to the spatial profile was</span>
<span class="sd">    mentioned in Marsh 1989, then I created my own implementation. The spatial</span>
<span class="sd">    profile is obtained by finding the median across the full dispersion axis.</span>
<span class="sd">    For goodman the spectrum and ccd are very well aligned, there is a slight</span>
<span class="sd">    variation from one configuration to another but in general is acceptable.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): a ccdproc.CCDData instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        profile_model (object): an astropy.modeling.Model instance, it could be</span>
<span class="sd">            a Gaussian1D or CompoundModel (several Gaussian1D). Each of them</span>
<span class="sd">            represent a point source spectrum found.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">):</span>
        <span class="n">slit_size</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z&quot;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">])</span>
        <span class="n">serial_binning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CCDSUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># order will be used for finding the peaks later but also as an initial</span>
        <span class="c1"># estimate for stddev of gaussian</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">slit_size</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">*</span> <span class="n">serial_binning</span><span class="p">)))</span>
        <span class="c1"># averaging overall spectral dimension because in goodman the spectra is</span>
        <span class="c1"># deviated very little</span>
        <span class="n">profile_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Gaussian has to be defined at the middle for it to work</span>
        <span class="n">gaussian</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">profile_median</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                     <span class="n">mean</span><span class="o">=</span><span class="n">profile_median</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                     <span class="n">stddev</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Gaussian&#39;</span><span class="p">)</span>

        <span class="c1"># do cross correlation of data with gaussian</span>
        <span class="c1"># this is useful for cases with low signal to noise ratio</span>
        <span class="n">cross_corr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">in1</span><span class="o">=</span><span class="n">profile_median</span><span class="p">,</span>
                                      <span class="n">in2</span><span class="o">=</span><span class="n">gaussian</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">profile_median</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span>
                                      <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="c1"># filter cross correlation data</span>
        <span class="n">filt_cross_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cross_corr</span> <span class="o">&gt;</span> <span class="n">cross_corr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                                          <span class="o">+</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">cross_corr</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                                   <span class="n">cross_corr</span><span class="p">,</span>
                                   <span class="kc">None</span><span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">argrelmax</span><span class="p">(</span><span class="n">filt_cross_corr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">profile_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)):</span>
            <span class="n">low_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">])</span>
            <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">profile_median</span><span class="o">.</span><span class="n">size</span><span class="p">])</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">profile_median</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span> <span class="n">hig_lim</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span>
                                         <span class="n">mean</span><span class="o">=</span><span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                         <span class="n">stddev</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Gaussian_&#39;</span>
                                                              <span class="s1">&#39;{:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">profile_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">profile_model</span> <span class="o">+=</span> <span class="n">gaussian</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">profile_model</span> <span class="o">=</span> <span class="n">gaussian</span>
        <span class="c1"># plt.axvline(peaks[i])</span>
        <span class="c1"># print(profile_model)</span>

        <span class="c1"># fit model to profile</span>
        <span class="n">fit_gaussian</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">profile_model</span> <span class="o">=</span> <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span>
                                     <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">profile_median</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                                     <span class="n">y</span><span class="o">=</span><span class="n">profile_median</span><span class="p">)</span>
        <span class="c1"># print(fit_gaussian.fit_info)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="c1"># plt.plot(cross_corr, label=&#39;Cross Correlation&#39;, linestyle=&#39;--&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile_model</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">profile_median</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted Model&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile_median</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Profile (median)&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># print(profile_model)</span>
        <span class="k">if</span> <span class="n">fit_gaussian</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;ierr&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;There is some problem with the fitting.&#39;</span>
                        <span class="s1">&#39;Returning None.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">profile_model</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Not a ccdproc.CCDData instance&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="trace_targets"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.trace_targets">[docs]</a><span class="k">def</span> <span class="nf">trace_targets</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">sampling_step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pol_deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the trace of the target&#39;s spectrum on the image</span>

<span class="sd">    This function defines a low order polynomial that trace the location of the</span>
<span class="sd">    spectrum. The attributes pol_deg and sampling_step define the polynomial</span>
<span class="sd">    degree and the spacing in pixels for the samples. For every sample a</span>
<span class="sd">    gaussian model is fitted and the center (mean) is recorded and since</span>
<span class="sd">    spectrum traces vary smoothly this value is used as a new center for the</span>
<span class="sd">    base model used to fit the spectrum profile.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This doesn&#39;t work for extended sources.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData</span>
<span class="sd">        profile (object): Instance of astropy.modeling.Model, contains the</span>
<span class="sd">            spatial profile of the 2D spectrum.</span>
<span class="sd">        sampling_step (int): Frequency of sampling in pixels</span>
<span class="sd">        pol_deg (int): Polynomial degree for fitting the trace</span>
<span class="sd">        plots (bool): If True will show plots (debugging)</span>

<span class="sd">    Returns:</span>
<span class="sd">        all_traces (list): List that contains traces that are</span>
<span class="sd">            astropy.modeling.Model instance</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># added two assert for debugging purposes</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

    <span class="c1"># Get image dimensions</span>
    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Initialize model fitter</span>
    <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># Initialize the model to fit the traces</span>
    <span class="n">trace_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">pol_deg</span><span class="p">)</span>

    <span class="c1"># Will store the arrays for the fitted location of the target obtained</span>
    <span class="c1"># in the fitting</span>
    <span class="n">trace_points</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># List that will contain all the Model instances corresponding to traced</span>
    <span class="c1"># targets</span>
    <span class="n">all_traces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Array defining the points to be sampled</span>
    <span class="n">sampling_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">dispersion_length</span> <span class="o">//</span> <span class="n">sampling_step</span> <span class="o">*</span> <span class="n">sampling_step</span><span class="p">,</span>
                          <span class="n">sampling_step</span><span class="p">)</span>

    <span class="c1"># Loop to go through all the sampling points and gather the points</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sampling_axis</span><span class="p">:</span>
        <span class="c1"># Fit the inital model to the data</span>
        <span class="n">fitted_profile</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span>
                                      <span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                                      <span class="n">y</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Profile fitted&#39;</span><span class="p">)</span>

        <span class="c1"># if plots or log.isEnabledFor(logging.DEBUG):</span>
        <span class="c1">#     # print(fitted_profile)</span>
        <span class="c1">#     x_axis = range(ccd.data[:, i].size)</span>
        <span class="c1">#     plt.ion()</span>
        <span class="c1">#     plt.title(&#39;Column {:d}&#39;.format(i))</span>
        <span class="c1">#     plt.plot(ccd.data[:, i], label=&#39;Data&#39;)</span>
        <span class="c1">#     plt.plot(x_axis, fitted_profile(x_axis), label=&#39;Model&#39;)</span>
        <span class="c1">#     plt.legend(loc=&#39;best&#39;)</span>
        <span class="c1">#     # if model_fitter.fit_info[&#39;ierr&#39;] == 1:</span>
        <span class="c1">#     #     # print(model_fitter.fit_info)</span>
        <span class="c1">#     #     plt.ioff()</span>
        <span class="c1">#     #     plt.show()</span>
        <span class="c1">#     #     plt.ion()</span>
        <span class="c1">#     plt.draw()</span>
        <span class="c1">#     plt.pause(.5)</span>
        <span class="c1">#     plt.clf()</span>
        <span class="c1">#     plt.ioff()</span>

        <span class="k">if</span> <span class="n">model_fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;ierr&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Fitting did not work, fit_info[&#39;ierr&#39;] = </span><span class="se">\</span>
<span class="s2">                {:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;ierr&#39;</span><span class="p">]))</span>

        <span class="c1"># alternatively could use fitted_profile.param_names</span>
        <span class="c1"># the mean_keys is another way to tell how many submodels are in the</span>
        <span class="c1"># model that was parsed.</span>
        <span class="n">mean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">fitted_profile</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

        <span class="c1"># Since traces are assumed to vary smoothly with wavelength I change the</span>
        <span class="c1"># previously found mean to the profile model used to fit the profile</span>
        <span class="c1"># data</span>
        <span class="k">for</span> <span class="n">mean_key</span> <span class="ow">in</span> <span class="n">mean_keys</span><span class="p">:</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">mean_key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> \
                <span class="n">fitted_profile</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">mean_key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>

        <span class="k">if</span> <span class="n">trace_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trace_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_keys</span><span class="p">),</span>
                                       <span class="n">dispersion_length</span> <span class="o">//</span> <span class="n">sampling_step</span><span class="p">))</span>

        <span class="c1"># store the corresponding value in the proper array for later fitting</span>
        <span class="c1"># a low order polynomial</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Median Trace&#39;</span>
                      <span class="s1">&#39; {:d}: {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">trace_points</span><span class="p">[</span><span class="n">e</span><span class="p">])))</span>

            <span class="n">trace_points</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">i</span> <span class="o">//</span> <span class="n">sampling_step</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">fitted_profile</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">mean_keys</span><span class="p">[</span><span class="n">e</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># fit a low order polynomial for the trace</span>
    <span class="k">for</span> <span class="n">trace_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">trace_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="n">fitted_trace</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">trace_model</span><span class="p">,</span>
                                    <span class="n">x</span><span class="o">=</span><span class="n">sampling_axis</span><span class="p">,</span>
                                    <span class="n">y</span><span class="o">=</span><span class="n">trace_points</span><span class="p">[</span><span class="n">trace_num</span><span class="p">])</span>

        <span class="n">fitted_trace</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;Trace_{:d}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trace_num</span><span class="p">))</span>

        <span class="c1"># TODO (simon): Validate which kind of errors are represented here</span>
        <span class="k">if</span> <span class="n">model_fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;ierr&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">model_fitter</span><span class="o">.</span><span class="n">fit_info</span><span class="p">[</span><span class="s1">&#39;ierr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># RMS Error calculation</span>
            <span class="n">rms_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fitted_trace</span><span class="p">(</span><span class="n">sampling_axis</span><span class="p">)</span> <span class="o">-</span>
                                 <span class="n">trace_points</span><span class="p">[</span><span class="n">trace_num</span><span class="p">]])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trace Fit RMSE: {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms_error</span><span class="p">))</span>

            <span class="c1"># append for returning</span>
            <span class="k">if</span> <span class="n">all_traces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_traces</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitted_trace</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted_trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampling_axis</span><span class="p">,</span>
                     <span class="n">trace_points</span><span class="p">[</span><span class="n">trace_num</span><span class="p">],</span>
                     <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data Points&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitted_trace</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dispersion_length</span><span class="p">)),</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model RMSE: {:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms_error</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Targets Trace&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion Axis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial Axis&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">trace_points</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampling_axis</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="c1"># print(trace)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">all_traces</span></div>


<div class="viewcode-block" id="get_extraction_zone"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_extraction_zone">[docs]</a><span class="k">def</span> <span class="nf">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span>
                        <span class="n">extraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">n_sigma_extract</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the minimum rectangular CCD zone that fully contains the spectrum</span>

<span class="sd">    In this context, _fully contained_ means the spectrum plus some region for</span>
<span class="sd">    background subtraction.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For Goodman HTS the alignment of the spectrum with the detector lines</span>
<span class="sd">        is quite good, that&#39;s why this function does not consider the trace.</span>
<span class="sd">        Also because the `model` argument is based on the median throughout all</span>
<span class="sd">        the detector along the dispersion axis, so if there is a strong</span>
<span class="sd">        misalignment it will result in a wider Gaussian Profile</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance, the image from which the zone</span>
<span class="sd">            will be extracted</span>
<span class="sd">        extraction (str): Extraction type, &#39;simple&#39; or &#39;optimal&#39;</span>
<span class="sd">        trace (object): An astropy.modeling.Model instance that correspond to</span>
<span class="sd">            the trace of the spectrum</span>
<span class="sd">        model (object): An astropy.modeling.Model instance that was previously</span>
<span class="sd">            fitted to the spatial profile.</span>
<span class="sd">        n_sigma_extract (int): Total number of sigmas to be extracted.</span>
<span class="sd">        plots (bool): If True will show plots, similar to a debugging mode.</span>
<span class="sd">        zone (list): Low and high limits to extract</span>

<span class="sd">    Returns:</span>
<span class="sd">        nccd (object): Instance of ccdproc.CCDData that contains only the region</span>
<span class="sd">            extracted from the full image. The header is updated with a new HISTORY</span>
<span class="sd">            keyword that contain the region of the original image extracted.</span>
<span class="sd">        model (object): Instance of astropy.modeling.Model with an updated mean</span>
<span class="sd">            to match the new center in pixel units.</span>
<span class="sd">        zone (list): Low and high limits of extraction zone</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n_sigma_extract</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting zone centered at: {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># get maximum variation in spatial direction</span>
        <span class="n">trace_array</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dispersion_length</span><span class="p">))</span>
        <span class="n">trace_inclination</span> <span class="o">=</span> <span class="n">trace_array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">trace_array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trace Min-Max difference: {:.3f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trace_inclination</span><span class="p">))</span>

        <span class="c1"># m_mean = model.mean.value</span>
        <span class="n">m_stddev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="n">extract_width</span> <span class="o">=</span> <span class="n">n_sigma_extract</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m_stddev</span>

        <span class="n">low_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace_array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">extract_width</span><span class="p">)])</span>

        <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">trace_array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">extract_width</span><span class="p">),</span>
                          <span class="n">spatial_length</span><span class="p">])</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="p">[</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">]</span>

        <span class="c1"># this is necessary since we are cutting a piece of the full ccd.</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">value</span> <span class="o">-=</span> <span class="n">low_lim</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Changing attribute c0 from trace, this is to adjust it to &#39;</span>
                 <span class="s1">&#39;the new extraction zone which is smaller that the full CCD.&#39;</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Changing attribute mean of profile model&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">extract_width</span>

        <span class="n">nccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trimming mask&#39;</span><span class="p">)</span>
            <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Subsection of CCD &#39;</span> \
                                 <span class="s1">&#39;[{:d}:{:d}, :]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">nccd</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">zone</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">zone</span>

        <span class="n">nccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trimming mask&#39;</span><span class="p">)</span>
            <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Subsection of CCD &#39;</span> \
                                 <span class="s1">&#39;[{:d}:{:d}, :]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nccd</span></div>


<div class="viewcode-block" id="add_wcs_keys"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.add_wcs_keys">[docs]</a><span class="k">def</span> <span class="nf">add_wcs_keys</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds generic keyword to the header</span>

<span class="sd">    Linear wavelength solutions require a set of standard fits keywords. Later</span>
<span class="sd">    on they will be updated accordingly</span>
<span class="sd">    The main goal of putting them here is to have consistent and nicely ordered</span>
<span class="sd">    headers</span>

<span class="sd">    Notes:</span>
<span class="sd">        This does NOT add a WCS solution, just the keywords</span>

<span class="sd">    Args:</span>
<span class="sd">        header (object): New header without WCS entries</span>

<span class="sd">    Returns:</span>
<span class="sd">        header (object): Modified header with added WCS keywords</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BANDID1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spectrum - background none, weights none, clean no&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;APNUM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1 1 0 0&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSDIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LINEAR&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;LTM1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAT0_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;system=equispec&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAT1_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wtype=linear label=Wavelength units=angstroms&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DC-FLAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DCLOG1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;REFSPEC1 = non set&#39;</span>
        <span class="k">return</span> <span class="n">header</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add wcs keywords to header&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_background"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.remove_background">[docs]</a><span class="k">def</span> <span class="nf">remove_background</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove Background of a ccd spectrum image</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): The modified</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ccd_copia = ccd.copy()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># x, y = ccd.data.shape</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">-=</span> <span class="n">median</span>
    <span class="n">data</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>

    <span class="c1"># ccd.write(&#39;/user/simon/dummy_{:d}.fits&#39;.format(g), clobber=True)</span>
    <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="extract"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.extract">[docs]</a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span>
            <span class="n">trace</span><span class="p">,</span>
            <span class="n">spatial_profile</span><span class="p">,</span>
            <span class="n">extraction</span><span class="p">,</span>
            <span class="n">sampling_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs spectrum extraction</span>

<span class="sd">    This function is designed to perform two types of spectrum extraction, a</span>
<span class="sd">    simple sum in the spatial direction and an optimal extraction.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For the beta release the optimal extraction is not implemented.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData containing a 2D spectrum</span>
<span class="sd">        trace (object): Instance of astropy.modeling.Model, a low order</span>
<span class="sd">            polynomial that defines the trace of the spectrum in the ccd object.</span>
<span class="sd">        spatial_profile (object): Instance of astropy.modeling.Model, a Gaussian</span>
<span class="sd">            model previously fitted to the spatial profile of the 2D spectrum</span>
<span class="sd">            contained in the ccd object.</span>
<span class="sd">        extraction (str): Extraction type, can be &#39;simple&#39; or &#39;optimal&#39; for the</span>
<span class="sd">            beta release the optimal extraction is not implemented yet.</span>
<span class="sd">        sampling_step (int): The optimal extraction needs to sample the spatial</span>
<span class="sd">            profile, this value defines the intervals at which get such</span>
<span class="sd">            sampling.</span>
<span class="sd">        plots (bool): Determines whether display plots or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData containing a 1D spectrum. The</span>
<span class="sd">            attribute &#39;data&#39; is replaced by the 1D array resulted from the</span>
<span class="sd">            extraction process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: When &#39;extraction&#39; is optimal, this is valid for the</span>
<span class="sd">            beta release</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># create variance model</span>
    <span class="n">rdnoise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">])</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Original Name {:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]))</span>

    <span class="n">variance_2d</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdnoise</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">gain</span><span class="p">)</span> <span class="o">/</span> <span class="n">gain</span>
    <span class="k">if</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finding cosmic rays to create mask&#39;</span><span class="p">)</span>
        <span class="n">cr_mask</span> <span class="o">=</span> <span class="n">cosmicray_rejection</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span> <span class="n">mask_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cr_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">cr_mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only OBSTYPE == OBJECT get cosmic ray rejection.&#39;</span><span class="p">)</span>
        <span class="n">cr_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cosmic ray mask already exists.&#39;</span><span class="p">)</span>
        <span class="n">cr_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># print(spatial_profile.mean.value)</span>
    <span class="c1"># print(trace.c0.value)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_profile</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">):</span>
        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span>
                                      <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
                                      <span class="n">stddev</span><span class="o">=</span><span class="n">stddev</span><span class="p">)</span>
        <span class="c1"># print(&#39;Fixed &#39;, new_model.mean.fixed)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ccd.data is a masked array: &#39;</span>
              <span class="s1">&#39;{:s}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">))))</span>

    <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># print(np.ma.isMaskedArray(ccd.data))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extraction</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>

        <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cr_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># print(indexes)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># print(np.ma.isMaskedArray(ccd.data))</span>
        <span class="n">to_sum</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">cr_mask</span>
        <span class="n">simple_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">to_sum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">simple_sum</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Simple Extraction&#39;</span><span class="p">)</span>
            <span class="c1"># ax = fig.add_subplot(111)</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion Axis (Pixels)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (Counts)&#39;</span><span class="p">)</span>
            <span class="c1"># plt.plot(simple_sum, label=&#39;Simple Sum&#39;, color=&#39;k&#39;, alpha=0.5)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simple Extracted&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">extraction</span> <span class="o">==</span> <span class="s1">&#39;optimal&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c1"># out_spectrum = np.empty(dispersion_length)</span>
        <span class="c1"># for i in range(0, dispersion_length, sampling_step):</span>
        <span class="c1">#     # force the model to follow the trace</span>
        <span class="c1">#     new_model.mean.value = trace(i)</span>
        <span class="c1">#</span>
        <span class="c1">#     # warn if the difference of the spectrum position in the trace at the</span>
        <span class="c1">#     # extremes of the sampling range is larger than 1 pixel.</span>
        <span class="c1">#     if np.abs(trace(i) - trace(i + sampling_step)) &gt; 1:</span>
        <span class="c1">#         log.warning(&#39;Sampling step might be too large&#39;)</span>
        <span class="c1">#</span>
        <span class="c1">#     sample = np.median(ccd.data[:, i:i + sampling_step], axis=1)</span>
        <span class="c1">#     fitted_profile = model_fitter(model=new_model,</span>
        <span class="c1">#                                   x=range(len(sample)),</span>
        <span class="c1">#                                   y=sample)</span>
        <span class="c1">#</span>
        <span class="c1">#     profile = fitted_profile(range(sample.size))</span>
        <span class="c1">#</span>
        <span class="c1">#     # enforce positivity</span>
        <span class="c1">#     pos_profile = np.array([np.max([0, x]) for x in profile])</span>
        <span class="c1">#</span>
        <span class="c1">#     # enforce normalization</span>
        <span class="c1">#     nor_profile = np.array([x / pos_profile.sum() for x in pos_profile])</span>
        <span class="c1">#</span>
        <span class="c1">#     if sampling_step &gt; 1:</span>
        <span class="c1">#         # TODO (simon): Simplify to Pythonic way</span>
        <span class="c1">#         right = min((i + sampling_step), dispersion_length)</span>
        <span class="c1">#</span>
        <span class="c1">#         for e in range(i, right, 1):</span>
        <span class="c1">#             mask = cr_mask[:, e]</span>
        <span class="c1">#             data = ma.masked_invalid(ccd.data[:, e])</span>
        <span class="c1">#             # print(ma.isMaskedArray(data))</span>
        <span class="c1">#             V = variance_2d[:, e]</span>
        <span class="c1">#             P = nor_profile</span>
        <span class="c1">#             a = [(P[z] / V[z]) / np.sum(P ** 2 / V) for z in</span>
        <span class="c1">#                  range(P.size)]</span>
        <span class="c1">#             weights = (nor_profile / variance_2d[:, e]) / np.sum(</span>
        <span class="c1">#                 nor_profile ** 2 / variance_2d[:, e])</span>
        <span class="c1">#             # print(&#39;SUMN &#39;, np.sum(a), np.sum(weights), np.sum(nor_profile), np.sum(P * weights))</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#             # if e in range(5, 4001, 500):</span>
        <span class="c1">#             #     plt.plot(nor_profile * data.max()/ nor_profile.max(), label=str(e))</span>
        <span class="c1">#             #     plt.plot(data, label=&#39;Data&#39;)</span>
        <span class="c1">#             #     plt.legend(loc=&#39;best&#39;)</span>
        <span class="c1">#             #     plt.show()</span>
        <span class="c1">#</span>
        <span class="c1">#             out_spectrum[e] = np.sum(data * mask * nor_profile)</span>
        <span class="c1"># ccd.data = out_spectrum</span>
        <span class="c1"># if plots:</span>
        <span class="c1">#     fig = plt.figure()</span>
        <span class="c1">#     fig.canvas.set_window_title(&#39;Optimal Extraction&#39;)</span>
        <span class="c1">#     # ax = fig.add_subplot(111)</span>
        <span class="c1">#     manager = plt.get_current_fig_manager()</span>
        <span class="c1">#     manager.window.maximize()</span>
        <span class="c1">#</span>
        <span class="c1">#     plt.title(ccd.header[&#39;OBJECT&#39;])</span>
        <span class="c1">#     plt.xlabel(&#39;Dispersion Axis (Pixels)&#39;)</span>
        <span class="c1">#     plt.ylabel(&#39;Intensity (Counts)&#39;)</span>
        <span class="c1">#     # plt.plot(simple_sum, label=&#39;Simple Sum&#39;, color=&#39;k&#39;, alpha=0.5)</span>
        <span class="c1">#     plt.plot(ccd.data, color=&#39;k&#39;,</span>
        <span class="c1">#              label=&#39;Optimal Extracted&#39;)</span>
        <span class="c1">#     plt.xlim((0, len(ccd.data)))</span>
        <span class="c1">#     plt.legend(loc=&#39;best&#39;)</span>
        <span class="c1">#     if plt.isinteractive():</span>
        <span class="c1">#         plt.draw()</span>
        <span class="c1">#         plt.pause(1)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         plt.show()</span>

    <span class="c1"># ccd.data = out_spectrum</span>
    <span class="k">return</span> <span class="n">ccd</span></div>


<span class="c1"># classes definition</span>

<div class="viewcode-block" id="NightDataContainer"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer">[docs]</a><span class="k">class</span> <span class="nc">NightDataContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is designed to be the organized data container. It doesn&#39;t</span>
<span class="sd">    store image data but list of pandas.DataFrame objects. Also it stores</span>
<span class="sd">    critical variables such as sunrise and sunset times.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes all the variables for the class</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Full path to the directory where raw data is located</span>
<span class="sd">            instrument (str): &#39;Red&#39; or &#39;Blue&#39; stating whether the data was taken</span>
<span class="sd">                using the Red or Blue Goodman Camera.</span>
<span class="sd">            technique (str): &#39;Spectroscopy&#39; or &#39;Imaging&#39; stating what kind of</span>
<span class="sd">                data was taken.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">technique</span> <span class="o">=</span> <span class="n">technique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dome_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># time reference points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_set_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_rise_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evening_twilight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">morning_twilight</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="NightDataContainer.add_bias"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_bias">[docs]</a>    <span class="k">def</span> <span class="nf">add_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a bias group</span>

<span class="sd">        Args:</span>
<span class="sd">            bias_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias_group</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">technique</span> <span class="o">==</span> <span class="s1">&#39;Imaging&#39;</span><span class="p">:</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Imaging mode needs BIAS to work properly. &#39;</span>
                          <span class="s1">&#39;Go find some.&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;BIAS are needed for optimal results.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="p">[</span><span class="n">bias_group</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_day_flats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_day_flats">[docs]</a>    <span class="k">def</span> <span class="nf">add_day_flats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_flats</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Adds a daytime flat group</span>

<span class="sd">        Args:</span>
<span class="sd">            day_flats (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="o">=</span> <span class="p">[</span><span class="n">day_flats</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_flats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_data_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_data_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a data group</span>

<span class="sd">        Args:</span>
<span class="sd">            data_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_spec_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_spec_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_spec_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a data group</span>

<span class="sd">        Args:</span>
<span class="sd">            spec_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.set_sun_times"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.set_sun_times">[docs]</a>    <span class="k">def</span> <span class="nf">set_sun_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sun_set</span><span class="p">,</span> <span class="n">sun_rise</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets values for sunset and sunrise</span>

<span class="sd">        Args:</span>
<span class="sd">            sun_set (str): Sun set time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">            sun_rise (str):Sun rise time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sun_set_time</span> <span class="o">=</span> <span class="n">sun_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_rise_time</span> <span class="o">=</span> <span class="n">sun_rise</span></div>

<div class="viewcode-block" id="NightDataContainer.set_twilight_times"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.set_twilight_times">[docs]</a>    <span class="k">def</span> <span class="nf">set_twilight_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evening</span><span class="p">,</span> <span class="n">morning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets values for evening and morning twilight</span>

<span class="sd">        Args:</span>
<span class="sd">            evening (str): Evening twilight time in the format</span>
<span class="sd">                &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">            morning (str): Morning twilight time in the format</span>
<span class="sd">                &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evening_twilight</span> <span class="o">=</span> <span class="n">evening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">morning_twilight</span> <span class="o">=</span> <span class="n">morning</span></div></div>


<div class="viewcode-block" id="NoTargetException"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NoTargetException">[docs]</a><span class="k">class</span> <span class="nc">NoTargetException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;No targets identified.&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon Torres.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.2.
    </div>
  </body>
</html>