<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>goodman_ccd.core &#8212; Goodman Pipelines 1.0b1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0b1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for goodman_ccd.core</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">ccdproc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Timer</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Qt4Agg&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">CCDData</span><span class="p">,</span> <span class="n">ImageFileCollection</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">EarthLocation</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astroplan</span> <span class="k">import</span> <span class="n">Observer</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">fitting</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>

<span class="n">log_ccd</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;goodmanccd.core&#39;</span><span class="p">)</span>
<span class="n">log_spec</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;redspec.core&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="convert_time"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.convert_time">[docs]</a><span class="k">def</span> <span class="nf">convert_time</span><span class="p">(</span><span class="n">in_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts time to seconds since epoch</span>

<span class="sd">    Args:</span>
<span class="sd">        in_time (str): time obtained from header&#39;s keyword DATE-OBS</span>

<span class="sd">    Returns:</span>
<span class="sd">        time in seconds since epoch</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">in_time</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="fix_duplicated_keywords"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.fix_duplicated_keywords">[docs]</a><span class="k">def</span> <span class="nf">fix_duplicated_keywords</span><span class="p">(</span><span class="n">night_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove duplicated keywords</span>

<span class="sd">    There are some cases when the raw data comes with duplicated keywords.</span>
<span class="sd">    The origin has not been tracked down. The solution is to identify the</span>
<span class="sd">    duplicated keywords and the remove all but one from the end backwards.</span>

<span class="sd">    Args:</span>
<span class="sd">        night_dir (str): The full path for the raw data location</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding duplicated keywords&#39;</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Files will be overwritten&#39;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">night_dir</span><span class="p">,</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">))</span>
    <span class="c1"># Pick a random file to find duplicated keywords</span>
    <span class="n">random_file</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">random_file</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span>
    <span class="c1"># Put the duplicated keywords in a list</span>
    <span class="n">multiple_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">multiple_keys</span><span class="p">:</span>
                    <span class="n">multiple_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">multiple_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{:d}</span><span class="s1"> duplicated keyword &#39;</span>
                 <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">multiple_keys</span><span class="p">),</span>
                               <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multiple_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing Image File: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_file</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">multiple_keys</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span>
                                          <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Overwriting file with duplicated keywords removed&#39;</span><span class="p">)</span>
                <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> overwritten&#39;</span><span class="p">,</span> <span class="n">image_file</span><span class="p">)</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_file</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="ra_dec_to_deg"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.ra_dec_to_deg">[docs]</a><span class="k">def</span> <span class="nf">ra_dec_to_deg</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">,</span> <span class="n">declination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts right ascension and declination to degrees</span>

<span class="sd">    Args:</span>
<span class="sd">        right_ascension (str): Right ascension in the format hh:mm:ss.sss</span>
<span class="sd">        declination (str): Declination in the format dd:mm:ss.sss</span>

<span class="sd">    Returns:</span>
<span class="sd">        right_ascension_deg (float): Right ascension in degrees</span>
<span class="sd">        declination_deg (float): Declination in degrees</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">right_ascension</span> <span class="o">=</span> <span class="n">right_ascension</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="n">declination</span> <span class="o">=</span> <span class="n">declination</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

    <span class="c1"># RIGHT ASCENTION conversion</span>
    <span class="n">right_ascension_deg</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                           <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                              <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">right_ascension</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span> <span class="o">*</span> \
                          <span class="p">(</span><span class="mf">360.</span> <span class="o">/</span> <span class="mf">24.</span><span class="p">)</span>

    <span class="c1"># DECLINATION conversion</span>
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">declination_deg</span> <span class="o">=</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                              <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                 <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">declination</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">))</span> <span class="o">/</span> <span class="mf">60.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">right_ascension_deg</span><span class="p">,</span> <span class="n">declination_deg</span></div>


<div class="viewcode-block" id="print_spacers"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_spacers">[docs]</a><span class="k">def</span> <span class="nf">print_spacers</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Miscellaneous function to print uniform spacers</span>

<span class="sd">    Prints a spacer of 80 columns with  and 3 rows height. The first and last</span>
<span class="sd">    rows contains the symbol &quot;=&quot; repeated 80 times. The middle row contains the</span>
<span class="sd">    message centered and the extremes has one single &quot;=&quot; symbol.</span>
<span class="sd">    The only functionality of this is aesthetic.</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str): A message to be printed</span>

<span class="sd">    Returns:</span>
<span class="sd">        True (bool): A True value</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define the width of the message</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>

    <span class="n">bar_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># compose bars top and bottom</span>
    <span class="n">spacer_bar</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">bar_length</span>

    <span class="n">blanks</span> <span class="o">=</span> <span class="n">bar_length</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="n">space_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">blanks</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># compose the message</span>
    <span class="n">message_bar</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">space_length</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">space_length</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">spacer_bar</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message_bar</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">spacer_bar</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="print_progress"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_progress">[docs]</a><span class="k">def</span> <span class="nf">print_progress</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints the percentage of a progress</span>

<span class="sd">    It works for FOR loops, requires to know the full length of the loop.</span>
<span class="sd">    Prints to the standard output.</span>

<span class="sd">    Args:</span>
<span class="sd">        current (int): Current value in the range of the loop.</span>
<span class="sd">        total (int): The length of the loop.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="n">total</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Progress </span><span class="si">{:.2%}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Progress </span><span class="si">{:.2%}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="get_twilight_time"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_twilight_time">[docs]</a><span class="k">def</span> <span class="nf">get_twilight_time</span><span class="p">(</span><span class="n">date_obs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get end/start time of evening/morning twilight</span>

<span class="sd">    Notes:</span>
<span class="sd">        Taken from David Sanmartim&#39;s development</span>

<span class="sd">    Args:</span>
<span class="sd">        date_obs (list): List of all the dates from data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        twilight_evening (str): Evening twilight time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        twilight_morning (str): Morning twilight time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        sun_set_time (str): Sun set time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">        sun_rise_time (str): Sun rise time in the format</span>
<span class="sd">            &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># observatory(str): Observatory name.</span>
    <span class="n">observatory</span> <span class="o">=</span> <span class="s1">&#39;SOAR Telescope&#39;</span>
    <span class="n">geodetic_location</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-70d44m01.11s&#39;</span><span class="p">,</span> <span class="s1">&#39;-30d14m16.41s&#39;</span><span class="p">,</span> <span class="mi">2748</span><span class="p">]</span>

    <span class="c1"># longitude (str): Geographic longitude in string format</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># latitude (str): Geographic latitude in string format.</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># elevation (int): Geographic elevation in meters above sea level</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="n">geodetic_location</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># timezone (str): Time zone.</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>

    <span class="c1"># description(str): Observatory description</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Soar Telescope on Cerro Pachon, Chile&#39;</span>

    <span class="n">soar_loc</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span>
                                           <span class="n">latitude</span><span class="p">,</span>
                                           <span class="n">elevation</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                                           <span class="n">ellipsoid</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>

    <span class="n">soar</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">observatory</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">soar_loc</span><span class="p">,</span>
                    <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="n">time_first_frame</span><span class="p">,</span> <span class="n">time_last_frame</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">date_obs</span><span class="p">)),</span> <span class="n">Time</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">date_obs</span><span class="p">))</span>

    <span class="n">twilight_evening</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_evening_astronomical</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_first_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">twilight_morning</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_morning_astronomical</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_last_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">sun_set_time</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">sun_set_time</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_first_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">sun_rise_time</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">sun_rise_time</span><span class="p">(</span>
        <span class="n">Time</span><span class="p">(</span><span class="n">time_last_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sun Set &#39;</span> <span class="o">+</span> <span class="n">sun_set_time</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sun Rise &#39;</span> <span class="o">+</span> <span class="n">sun_rise_time</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">,</span> <span class="n">sun_set_time</span><span class="p">,</span> <span class="n">sun_rise_time</span></div>


<div class="viewcode-block" id="image_overscan"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.image_overscan">[docs]</a><span class="k">def</span> <span class="nf">image_overscan</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">overscan_region</span><span class="p">,</span> <span class="n">add_keyword</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply overscan to data</span>

<span class="sd">    Uses ccdproc.subtract_overscan to perform the task.</span>

<span class="sd">    Notes:</span>
<span class="sd">        The overscan_region argument uses FITS convention, just like IRAF,</span>
<span class="sd">        therefore is 1 based. i.e. t starts in 1 not 0.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance</span>
<span class="sd">        overscan_region (str): The overscan region in the format &#39;[x1:x2,y1:y2]&#39;</span>
<span class="sd">            where x is the spectral axis and y is the spatial axis.</span>
<span class="sd">        add_keyword (bool): Tells ccdproc whether to add a keyword or not.</span>
<span class="sd">            Default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Overscan corrected ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Applying overscan Correction: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overscan_region</span><span class="p">))</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_overscan</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                    <span class="n">median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">fits_section</span><span class="o">=</span><span class="n">overscan_region</span><span class="p">,</span>
                                    <span class="n">add_keyword</span><span class="o">=</span><span class="n">add_keyword</span><span class="p">)</span>

    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Applied overscan correction &#39;</span> <span class="o">+</span> <span class="n">overscan_region</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="image_trim"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.image_trim">[docs]</a><span class="k">def</span> <span class="nf">image_trim</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">trim_section</span><span class="p">,</span> <span class="n">add_keyword</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trim image to a given section</span>

<span class="sd">    Notes:</span>
<span class="sd">        The overscan_region argument uses FITS convention, just like IRAF,</span>
<span class="sd">        therefore is 1 based. i.e. t starts in 1 not 0.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance</span>
<span class="sd">        trim_section (str): The trimming section in the format &#39;[x1:x2,y1:y2]&#39;</span>
<span class="sd">            where x is the spectral axis and y is the spatial axis.</span>
<span class="sd">        add_keyword (bool): Tells ccdproc whether to add a keyword or not.</span>
<span class="sd">            Default False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Trimmed ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                             <span class="n">fits_section</span><span class="o">=</span><span class="n">trim_section</span><span class="p">,</span>
                             <span class="n">add_keyword</span><span class="o">=</span><span class="n">add_keyword</span><span class="p">)</span>
    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Trimmed image to &#39;</span> <span class="o">+</span> <span class="n">trim_section</span><span class="p">)</span>

    <span class="c1"># if ccd.header[&#39;OBSTYPE&#39;] == &#39;OBJECT&#39;:</span>
    <span class="c1">#     mg = plt.get_current_fig_manager()</span>
    <span class="c1">#     mg.window.showMaximized()</span>
    <span class="c1">#     plt.imshow(ccd.data, clim=(50,800))</span>
    <span class="c1">#     plt.show()</span>

    <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="get_slit_trim_section"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_slit_trim_section">[docs]</a><span class="k">def</span> <span class="nf">get_slit_trim_section</span><span class="p">(</span><span class="n">master_flat</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the slit edges to trim all data</span>

<span class="sd">    Using a master flat, ideally good signal to noise ratio, this function will</span>
<span class="sd">    identify the edges of the slit projected into the detector. Having this data</span>
<span class="sd">    will allow to reduce the overall processing time and also reduce the</span>
<span class="sd">    introduction of artifacts due to non-illuminated regions in the detectors,</span>
<span class="sd">    such as NaNs -INF +INF, etc.</span>

<span class="sd">    Args:</span>
<span class="sd">        master_flat (object): A ccdproc.CCDData instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        slit_trim_section (str): Trim section in spatial direction in the format</span>
<span class="sd">            [:,slit_lower_limit:slit_higher_limit]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">master_flat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Using the middle point to make calculations, usually flats have good</span>
    <span class="c1"># illumination already at the middle.</span>
    <span class="n">middle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">ccd_section</span> <span class="o">=</span> <span class="n">master_flat</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">middle</span><span class="p">:</span><span class="n">middle</span> <span class="o">+</span> <span class="mi">200</span><span class="p">]</span>
    <span class="n">ccd_section_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ccd_section</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spatial_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">))</span>

    <span class="c1"># set values for initial box model definition</span>
    <span class="n">box_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span>
    <span class="n">box_center</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">box_width</span> <span class="o">=</span> <span class="o">.</span><span class="mi">75</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span>

    <span class="c1"># box model definition</span>
    <span class="n">box_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Box1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">box_max</span><span class="p">,</span> <span class="n">x_0</span><span class="o">=</span><span class="n">box_center</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">box_width</span><span class="p">)</span>

    <span class="n">box_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">SimplexLSQFitter</span><span class="p">()</span>

    <span class="n">fitted_box</span> <span class="o">=</span> <span class="n">box_fitter</span><span class="p">(</span><span class="n">box_model</span><span class="p">,</span> <span class="n">spatial_axis</span><span class="p">,</span> <span class="n">ccd_section_median</span><span class="p">)</span>

    <span class="c1"># the number of pixels that will be removed from the detected edge of the</span>
    <span class="c1"># image on each side</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c1"># this defines a preliminary set of slit limit</span>
    <span class="n">l_lim</span> <span class="o">=</span> <span class="n">fitted_box</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">fitted_box</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">offset</span>

    <span class="n">h_lim</span> <span class="o">=</span> <span class="n">fitted_box</span><span class="o">.</span><span class="n">x_0</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">fitted_box</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">-</span> <span class="n">offset</span>

    <span class="c1"># Here we force the slit limits within the boundaries of the data (image)</span>
    <span class="n">low_lim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">l_lim</span><span class="p">]))</span>

    <span class="n">high_lim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">h_lim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">]))</span>

    <span class="c1"># define the slit trim section as (IRA</span>
    <span class="n">slit_trim_section</span> <span class="o">=</span> <span class="s1">&#39;[:,</span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">high_lim</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
        <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Slit Edge Detection&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">box_model</span><span class="p">(</span><span class="n">spatial_axis</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Box1D&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitted_box</span><span class="p">(</span><span class="n">spatial_axis</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fitted Box1D&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ccd_section_median</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median Along Disp.&#39;</span><span class="p">)</span>
        <span class="c1"># plt.plot(pseudo_derivative, color=&#39;g&#39;, label=&#39;Pseudo Derivative&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Detected Edges&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">high_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="c1"># for peak in peaks:</span>
        <span class="c1">#     plt.axvline(peak, color=&#39;r&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># plt.imshow(master_flat.data[low_lim:high_lim, :])</span>
    <span class="c1"># plt.axvline(low_lim, color=&#39;r&#39;)</span>
    <span class="c1"># plt.axvline(high_lim, color=&#39;r&#39;)</span>
    <span class="c1"># plt.show()</span>

    <span class="k">return</span> <span class="n">slit_trim_section</span></div>


<div class="viewcode-block" id="dcr_cosmicray_rejection"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.dcr_cosmicray_rejection">[docs]</a><span class="k">def</span> <span class="nf">dcr_cosmicray_rejection</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dcr_par_dir</span><span class="p">,</span>
                            <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs an external code for cosmic ray rejection</span>

<span class="sd">    DCR was created by Wojtek Pych and the code can be obtained from</span>
<span class="sd">    http://users.camk.edu.pl/pych/DCR/ and is written in C. Contrary to</span>
<span class="sd">    ccdproc&#39;s LACosmic it actually applies the correction, and also doesn&#39;t</span>
<span class="sd">    update the mask attribute since it doesn&#39;t work with CCDData instances.</span>

<span class="sd">    The binary takes three positional arguments, they are: 1. input image,</span>
<span class="sd">    2. output image and 3. cosmic rays images. Also it needs that a dcr.par file</span>
<span class="sd">    is located in the directory. All this is implemented in this function if</span>
<span class="sd">    delete is True it will remove the original image and the cosmic rays image.</span>
<span class="sd">    The removal of the original image is absolutely safe when used in the</span>
<span class="sd">    context of the goodman pipeline, however if you want to implement it</span>
<span class="sd">    somewhere else, be careful.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This function operates an external code therefore it doesn&#39;t return</span>
<span class="sd">        anything, instead it creates a new image.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_path (str): Data location</span>
<span class="sd">        in_file (str): Name of the file to have its cosmic rays removed</span>
<span class="sd">        prefix (str): Prefix to add to the file with the cosmic rays removed</span>
<span class="sd">        dcr_par_dir (str): Directory of default dcr.par file</span>
<span class="sd">        delete (bool): True for deleting the input and cosmic ray file.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing cosmic rays using DCR by Wojtek Pych&#39;</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;See http://users.camk.edu.pl/pych/DCR/&#39;</span><span class="p">)</span>

    <span class="c1"># add the prefix for the output file</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">in_file</span>

    <span class="c1"># define the name for the cosmic rays file</span>
    <span class="n">cosmic_file</span> <span class="o">=</span> <span class="s1">&#39;cosmic_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># define full path for all the files involved</span>
    <span class="n">full_path_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>
    <span class="n">full_path_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
    <span class="n">full_path_cosmic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">cosmic_file</span><span class="p">)</span>

    <span class="c1"># this is the command for running dcr, all arguments are required</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;dcr </span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1"> </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">,</span>
                                          <span class="n">full_path_out</span><span class="p">,</span>
                                          <span class="n">full_path_cosmic</span><span class="p">)</span>

    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DCR command:&#39;</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="c1"># print(command.split(&#39; &#39;))</span>

    <span class="c1"># get the current working directory to go back to it later in case the</span>
    <span class="c1"># the pipeline has not been called from the same data directory.</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c1"># move to the directory were the data is, dcr is expecting a file dcr.par</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>

    <span class="c1"># check if file dcr.par exists</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;dcr.par&#39;</span><span class="p">):</span>

        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File dcr.par does not exist. Copying default one.&#39;</span><span class="p">)</span>
        <span class="n">dcr_par_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dcr_par_dir</span><span class="p">,</span> <span class="s1">&#39;dcr.par&#39;</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;dcr.par full path: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">dcr_par_path</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find dcr.par file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;File dcr.par exists.&#39;</span><span class="p">)</span>

    <span class="c1"># call dcr</span>
    <span class="k">try</span><span class="p">:</span>

        <span class="n">dcr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
                               <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                               <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Your system can not locate the executable file dcr, try &#39;</span>
                 <span class="s1">&#39;moving it to /bin or create a symbolic link</span><span class="se">\n\n\t</span><span class="s1">cd /bin</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                 <span class="s1">&#39;sudo ln -s /full/path/to/dcr&#39;</span><span class="p">)</span>

        <span class="c1"># return False</span>

    <span class="c1"># if the process is taking too long to respond, kill it</span>
    <span class="c1"># kill_process = lambda process: process.kill()</span>
    <span class="k">def</span> <span class="nf">kill_process</span><span class="p">(</span><span class="n">process</span><span class="p">):</span> <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

    <span class="n">dcr_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">kill_process</span><span class="p">,</span> <span class="p">[</span><span class="n">dcr</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dcr_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">dcr</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">dcr_timer</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="c1"># wait for dcr to terminate</span>
    <span class="c1"># dcr.wait()</span>

    <span class="c1"># go back to the original directory. Could be the same.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># If no error stderr is an empty string</span>
    <span class="k">if</span> <span class="n">stderr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;dcr: not found&#39;</span> <span class="ow">in</span> <span class="n">stderr</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Your system can not locate the executable file dcr, try &#39;</span>
                 <span class="s1">&#39;moving it to /bin or create a symbolic link</span><span class="se">\n\n\t</span><span class="s1">cd /bin</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;sudo ln -s /full/path/to/dcr&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output_line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">output_line</span><span class="p">)</span>

    <span class="c1"># delete extra files only if the execution ended without error</span>
    <span class="k">if</span> <span class="n">delete</span> <span class="ow">and</span> <span class="n">stderr</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="s1">&#39;USAGE:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Removing input file: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">full_path_in</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Removing cosmic rays file: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path_cosmic</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">full_path_cosmic</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="lacosmic_cosmicray_rejection"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.lacosmic_cosmicray_rejection">[docs]</a><span class="k">def</span> <span class="nf">lacosmic_cosmicray_rejection</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">mask_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do cosmic ray rejection using ccdproc.LACosmic</span>

<span class="sd">    This function in fact does not apply any correction, it detects the cosmic</span>
<span class="sd">    rays and updates the attribute mask of the ccd object (CCDData instance).</span>
<span class="sd">    The attribute mask is used later as a mask for the pixels hit by cosmic rays</span>

<span class="sd">      Notes:</span>
<span class="sd">          OBS: cosmic ray rejection is working pretty well by defining gain = 1.</span>
<span class="sd">          It&#39;s not working when we use the real gain of the image. In this case</span>
<span class="sd">          the sky level changes by a factor equal the gain.</span>
<span class="sd">          Function to determine the sigfrac and objlim: y = 0.16 * exptime + 1.2</span>

<span class="sd">      Args:</span>
<span class="sd">          ccd (object): CCDData Object</span>
<span class="sd">          mask_only (bool): In some cases you may want to obtain the cosmic</span>
<span class="sd">              rays mask only</span>

<span class="sd">      Returns:</span>
<span class="sd">          ccd (object): A CCDData instance with the mask attribute updated.</span>

<span class="sd">      &quot;&quot;&quot;</span>
    <span class="c1"># TODO (simon): Validate this method</span>
    <span class="k">if</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mf">0.16</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.2</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning cosmic rays... &#39;</span><span class="p">)</span>

        <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">cosmicray_lacosmic</span><span class="p">(</span>
            <span class="n">ccd</span><span class="p">,</span>
            <span class="n">sigclip</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>
            <span class="n">sigfrac</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">objlim</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="n">gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">]),</span>
            <span class="n">readnoise</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]),</span>
            <span class="n">satlevel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
            <span class="n">sepmed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">fsmode</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
            <span class="n">psfmodel</span><span class="o">=</span><span class="s1">&#39;gaussy&#39;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s2">&quot;Cosmic rays rejected with LACosmic&quot;</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cosmic rays rejected with LACosmic&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ccd</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ccd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping cosmic ray rejection for image of datatype: &#39;</span>
                 <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBSTYPE&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ccd</span></div>


<div class="viewcode-block" id="call_cosmic_rejection"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.call_cosmic_rejection">[docs]</a><span class="k">def</span> <span class="nf">call_cosmic_rejection</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">science_image</span><span class="p">,</span> <span class="n">out_prefix</span><span class="p">,</span> <span class="n">red_path</span><span class="p">,</span>
                          <span class="n">dcr_par</span><span class="p">,</span> <span class="n">keep_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;dcr&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;dcr&#39;</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;DCR does apply the correction to images if you want &#39;</span>
                        <span class="s1">&#39;the mask use --keep-cosmic-files&#39;</span><span class="p">)</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">red_path</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="n">science_image</span><span class="p">)</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving image: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>

        <span class="n">in_file</span> <span class="o">=</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="n">science_image</span>

        <span class="n">dcr_cosmicray_rejection</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="n">red_path</span><span class="p">,</span>
                                <span class="n">in_file</span><span class="o">=</span><span class="n">in_file</span><span class="p">,</span>
                                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                                <span class="n">dcr_par_dir</span><span class="o">=</span><span class="n">dcr_par</span><span class="p">,</span>
                                <span class="n">delete</span><span class="o">=</span><span class="n">keep_files</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lacosmic&#39;</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;LACosmic does not apply the correction to images &#39;</span>
                        <span class="s1">&#39;instead it updates the mask attribute for CCDData &#39;</span>
                        <span class="s1">&#39;objects. For saved files the mask is a fits extension&#39;</span><span class="p">)</span>

        <span class="n">ccd</span> <span class="o">=</span> <span class="n">lacosmic_cosmicray_rejection</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">)</span>

        <span class="n">out_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">out_prefix</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">red_path</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="n">science_image</span><span class="p">)</span>

        <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving image: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">red_path</span><span class="p">,</span> <span class="n">out_prefix</span> <span class="o">+</span> <span class="n">science_image</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;--cosmic set to &#39;none&#39;&quot;</span><span class="p">)</span>
        <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving image: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unrecognized Cosmic Method </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>



<div class="viewcode-block" id="get_best_flat"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_best_flat">[docs]</a><span class="k">def</span> <span class="nf">get_best_flat</span><span class="p">(</span><span class="n">flat_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look for matching master flat</span>

<span class="sd">    Given a basename for masterflats defined as a combination of key parameters</span>
<span class="sd">    extracted from the header of the image that we want to flatfield, this</span>
<span class="sd">    function will find the name of the files that matches the base name and then</span>
<span class="sd">    will choose the first. Ideally this should go further as to check signal,</span>
<span class="sd">    time gap, etc.</span>
<span class="sd">    After it identifies the file it will load it using ccdproc.CCDData and</span>
<span class="sd">    return it along the filename.</span>
<span class="sd">    In case if fails it will return None instead of master_flat and another</span>
<span class="sd">    None instead of master_flat_name.</span>

<span class="sd">    Args:</span>
<span class="sd">        flat_name (str): Full path of masterflat basename. Ends in &#39;*.fits&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        master_flat (object): A ccdproc.CCDData instance</span>
<span class="sd">        master_flat_name (str): Full path to the chosen masterflat.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flat_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">flat_name</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Flat base name </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flat_name</span><span class="p">))</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Matching master flats found: </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">master_flat_name</span> <span class="o">=</span> <span class="n">flat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">master_flat_name</span> <span class="o">=</span> <span class="n">flat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># elif any(&#39;dome&#39; in flat for flat in flat_list):</span>
        <span class="c1">#     master_flat_name =</span>

        <span class="n">master_flat</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">master_flat_name</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found suitable master flat: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">master_flat_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">master_flat</span><span class="p">,</span> <span class="n">master_flat_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There is no flat available&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="print_default_args"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.print_default_args">[docs]</a><span class="k">def</span> <span class="nf">print_default_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print default values of arguments.</span>

<span class="sd">    This is mostly helpful for debug but people not familiar with the software</span>
<span class="sd">    might find it useful as well</span>

<span class="sd">    Notes:</span>
<span class="sd">        This is not dynamically updated so use with caution</span>

<span class="sd">    Args:</span>
<span class="sd">        args (object): An argparse instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arg_name</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;auto_clean&#39;</span><span class="p">:</span> <span class="s1">&#39;--auto-clean&#39;</span><span class="p">,</span>
                <span class="s1">&#39;clean_cosmic&#39;</span><span class="p">:</span> <span class="s1">&#39;-c, --cosmic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;debug_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;flat_normalize&#39;</span><span class="p">:</span> <span class="s1">&#39;--flat-normalize&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ignore_bias&#39;</span><span class="p">:</span> <span class="s1">&#39;--ignore-bias&#39;</span><span class="p">,</span>
                <span class="s1">&#39;log_to_file&#39;</span><span class="p">:</span> <span class="s1">&#39;--log-to-file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;norm_order&#39;</span><span class="p">:</span> <span class="s1">&#39;--flat-norm-order&#39;</span><span class="p">,</span>
                <span class="s1">&#39;raw_path&#39;</span><span class="p">:</span> <span class="s1">&#39;--raw-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;red_path&#39;</span><span class="p">:</span> <span class="s1">&#39;--red-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;saturation_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;--saturation&#39;</span><span class="p">,</span>
                <span class="s1">&#39;destiny&#39;</span><span class="p">:</span> <span class="s1">&#39;-d --proc-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;interactive_ws&#39;</span><span class="p">:</span> <span class="s1">&#39;-i --interactive&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lamp_all_night&#39;</span><span class="p">:</span> <span class="s1">&#39;-r --reference-lamp&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lamp_file&#39;</span><span class="p">:</span> <span class="s1">&#39;-l --lamp-file&#39;</span><span class="p">,</span>
                <span class="s1">&#39;output_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;-o --output-prefix&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;-s --search-pattern&#39;</span><span class="p">,</span>
                <span class="s1">&#39;procmode&#39;</span><span class="p">:</span> <span class="s1">&#39;-m --proc-mode&#39;</span><span class="p">,</span>
                <span class="s1">&#39;reference_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;-R --reference-files&#39;</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;-p --data-path&#39;</span><span class="p">,</span>
                <span class="s1">&#39;save_plots&#39;</span><span class="p">:</span> <span class="s1">&#39;--save-plots&#39;</span><span class="p">,</span>
                <span class="s1">&#39;dcr_par_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;--dcr-par-dir&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Default value for </span><span class="si">{:s}</span><span class="s1"> is </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">arg_name</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">))))</span></div>


<div class="viewcode-block" id="normalize_master_flat"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.normalize_master_flat">[docs]</a><span class="k">def</span> <span class="nf">normalize_master_flat</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Master flat normalization method</span>

<span class="sd">    This function normalize a master flat in three possible ways:</span>
<span class="sd">     *mean*: simply divide the data by its mean</span>

<span class="sd">     *simple*: Calculates the median along the spatial axis in order to obtain</span>
<span class="sd">     the dispersion profile. Then fits a Chebyshev1D model and apply this to all</span>
<span class="sd">     the data.</span>

<span class="sd">     *full*: This is for experimental purposes only because it takes a lot of</span>
<span class="sd">     time to process. It will fit a model to each line along the dispersion axis</span>
<span class="sd">     and then divide it by the fitted model. I do not recommend this method</span>
<span class="sd">     unless you have a good reason as well as a powerful computer..</span>

<span class="sd">    Args:</span>
<span class="sd">        master (object): Master flat. Has to be a ccdproc.CCDData instance</span>
<span class="sd">        name (str): Full path of master flat prior to normalization</span>
<span class="sd">        method (str): Normalization method, &#39;mean&#39;, &#39;simple&#39; or &#39;full&#39;</span>
<span class="sd">        order (int): Order of the polinomial to be fitted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        master (object):  The normalized master flat. ccdproc.CCDData instance</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>

    <span class="c1"># define new name, base path and full new name</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="s1">&#39;norm_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">norm_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Normalizing by mean&#39;</span><span class="p">)</span>
        <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by Mean&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Normalizing flat by </span><span class="si">{:s}</span><span class="s1"> model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="c1"># Initialize Fitting models and fitter</span>
        <span class="n">model_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

        <span class="c1"># get data shape</span>
        <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">y_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>
            <span class="c1"># get profile along dispersion axis to fit a model to use for</span>
            <span class="c1"># normalization</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># do the actual fit</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model_init</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>

            <span class="c1"># convert fit into an array</span>
            <span class="n">fit_array</span> <span class="o">=</span> <span class="n">fit</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>

            <span class="c1"># pythonic way to divide an array by a vector</span>
            <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">fit_array</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by simple model&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This part of the code was left here for experimental &#39;</span>
                        <span class="s1">&#39;purposes only&#39;</span><span class="p">)</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This procedure takes a lot to process, you might want to&#39;</span>
                     <span class="s1">&#39;see other method such as simple or mean.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_size</span><span class="p">):</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">model_fitter</span><span class="p">(</span><span class="n">model_init</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">fit</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>
            <span class="n">master</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Flat Normalized by full model&#39;</span><span class="p">)</span>

    <span class="c1"># write normalized flat to a file</span>
    <span class="n">master</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">norm_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">master</span></div>


<div class="viewcode-block" id="get_central_wavelength"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_central_wavelength">[docs]</a><span class="k">def</span> <span class="nf">get_central_wavelength</span><span class="p">(</span><span class="n">grating</span><span class="p">,</span> <span class="n">grt_ang</span><span class="p">,</span> <span class="n">cam_ang</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the central wavelength for a given spectroscopic mode</span>

<span class="sd">    The equation used to calculate the central wavelength is the following</span>


<span class="sd">    .. math::</span>
<span class="sd">        \\lambda_{central} = \\frac{1e6}{GRAT}</span>
<span class="sd">        \\sin\\left(\\frac{\\alpha \\pi}{180}\\right) +</span>
<span class="sd">        \\sin\\left(\\frac{\\beta \\pi}{180}\\right)</span>


<span class="sd">    Args:</span>
<span class="sd">        grating (str): Grating frequency as a string. Example &#39;400&#39;.</span>
<span class="sd">        grt_ang (str): Grating Angle as a string. Example &#39;12.0&#39;.</span>
<span class="sd">        cam_ang (str): Camera Angle as a string. Example &#39;20.0&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        central_wavelength (float): Central wavelength as a float value.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grating_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grating</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grt_ang</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cam_ang</span><span class="p">)</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">grt_ang</span><span class="p">)</span>

    <span class="n">central_wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">e6</span> <span class="o">/</span> <span class="n">grating_frequency</span><span class="p">)</span> <span class="o">*</span> \
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">))</span>

    <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{:.3f}</span><span class="s1"> as central wavelength&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">central_wavelength</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">central_wavelength</span></div>


<div class="viewcode-block" id="remove_conflictive_keywords"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.remove_conflictive_keywords">[docs]</a><span class="k">def</span> <span class="nf">remove_conflictive_keywords</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes problematic keywords</span>

<span class="sd">    The blue camera has a set of keywords whose comments contain non-ascii</span>
<span class="sd">    characters, in particular the degree symbol. Those keywords are not</span>
<span class="sd">    needed in any stage of the data reduction therefore they are removed.</span>
<span class="sd">    The data will be overwritten with the keywords removed. The user will</span>
<span class="sd">    need to have backups of raw data.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to the folder containing the files</span>
<span class="sd">        file_list (list): List of files to remove keywords</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removing conflictive keywords in Blue Camera Headers&#39;</span><span class="p">)</span>
    <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Files will be overwritten&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">blue_file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">blue_file</span><span class="p">)</span>
        <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing file </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blue_file</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span>
                                        <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PARAM0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;PARAM61&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;PARAM62&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;PARAM63&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Modified file to be 2D instead of 3D &#39;</span>
                          <span class="s1">&#39;(problematic)&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                <span class="n">header</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>

                <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Removed conflictive keyword &#39;</span>
                          <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keyword</span><span class="p">))</span>

            <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updated headers&#39;</span><span class="p">)</span>

            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">,</span>
                         <span class="n">header</span><span class="p">,</span>
                         <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">log_ccd</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>


<span class="c1"># spectroscopy specific functions</span>

<div class="viewcode-block" id="classify_spectroscopic_data"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.classify_spectroscopic_data">[docs]</a><span class="k">def</span> <span class="nf">classify_spectroscopic_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">search_pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Classify data by grouping them as pandas.DataFrame instances</span>

<span class="sd">    This functions uses ImageFileCollection from ccdproc. First it creates a</span>
<span class="sd">    collection of information regarding the images located in *path* that match</span>
<span class="sd">    the pattern *search_pattern*</span>
<span class="sd">    The information obtained are all keywords listed in the list *keywords*</span>
<span class="sd">    The ImageFileCollection is translated into pandas.DataFrame and then is used</span>
<span class="sd">    much like an SQL database to select and filter values and in that way put</span>
<span class="sd">    them in groups that are pandas.DataFrame instances.</span>


<span class="sd">    Args:</span>
<span class="sd">        path (str): Path to data location</span>
<span class="sd">        search_pattern (str): Prefix to match files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        data_container (object): Instance of NightDataContainer</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">search_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">search_pattern</span> <span class="o">+</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">)</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">search_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file_list</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No file found using search pattern &#39;</span>
                  <span class="s1">&#39;&quot;</span><span class="si">{:s}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_pattern</span><span class="p">))</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Please use the argument --search-pattern to define the &#39;</span>
                 <span class="s1">&#39;common prefix for the files to be processed.&#39;</span><span class="p">)</span>

    <span class="n">data_container</span> <span class="o">=</span> <span class="n">NightDataContainer</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                        <span class="n">instrument</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Red&#39;</span><span class="p">),</span>
                                        <span class="n">technique</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Spectroscopy&#39;</span><span class="p">))</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span>
                <span class="s1">&#39;slit&#39;</span><span class="p">,</span>
                <span class="s1">&#39;date-obs&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obstype&#39;</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exptime&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obsra&#39;</span><span class="p">,</span>
                <span class="s1">&#39;obsdec&#39;</span><span class="p">,</span>
                <span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                <span class="s1">&#39;cam_targ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;grt_targ&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                <span class="s1">&#39;filter2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rdnoise&#39;</span><span class="p">]</span>

    <span class="n">ifc</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span> <span class="n">filenames</span><span class="o">=</span><span class="n">file_list</span><span class="p">)</span>

    <span class="n">pifc</span> <span class="o">=</span> <span class="n">ifc</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

    <span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;radeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;decdeg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pifc</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">radeg</span><span class="p">,</span> <span class="n">decdeg</span> <span class="o">=</span> <span class="n">ra_dec_to_deg</span><span class="p">(</span><span class="n">pifc</span><span class="o">.</span><span class="n">obsra</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pifc</span><span class="o">.</span><span class="n">obsdec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">pifc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pifc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;radeg&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radeg</span><span class="p">)</span>

        <span class="n">pifc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">pifc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;decdeg&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">decdeg</span><span class="p">)</span>
        <span class="c1"># now we can compare using degrees</span>

    <span class="n">confs</span> <span class="o">=</span> <span class="n">pifc</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;slit&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;radeg&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;decdeg&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;cam_targ&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;grt_targ&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;filter2&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;gain&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;rdnoise&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">confs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">spec_group</span> <span class="o">=</span> <span class="n">pifc</span><span class="p">[((</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;slit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;slit&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;radeg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;radeg&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;decdeg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;decdeg&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;grating&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;filter2&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;gain&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">pifc</span><span class="p">[</span><span class="s1">&#39;rdnoise&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;rdnoise&#39;</span><span class="p">]))]</span>

        <span class="n">group_obstype</span> <span class="o">=</span> <span class="n">spec_group</span><span class="o">.</span><span class="n">obstype</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;COMP&#39;</span> <span class="ow">in</span> <span class="n">group_obstype</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_obstype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding COMP group&#39;</span><span class="p">)</span>
            <span class="n">data_container</span><span class="o">.</span><span class="n">add_comp_group</span><span class="p">(</span><span class="n">comp_group</span><span class="o">=</span><span class="n">spec_group</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;OBJECT&#39;</span> <span class="ow">in</span> <span class="n">group_obstype</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_obstype</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding OBJECT group&#39;</span><span class="p">)</span>
            <span class="n">data_container</span><span class="o">.</span><span class="n">add_object_group</span><span class="p">(</span><span class="n">object_group</span><span class="o">=</span><span class="n">spec_group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding OBJECT-COMP group&#39;</span><span class="p">)</span>
            <span class="n">data_container</span><span class="o">.</span><span class="n">add_spec_group</span><span class="p">(</span><span class="n">spec_group</span><span class="o">=</span><span class="n">spec_group</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_container</span></div>


<div class="viewcode-block" id="search_comp_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.search_comp_group">[docs]</a><span class="k">def</span> <span class="nf">search_comp_group</span><span class="p">(</span><span class="n">object_group</span><span class="p">,</span> <span class="n">comp_groups</span><span class="p">):</span>

    <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding a suitable comparison lamp group&#39;</span><span class="p">)</span>

    <span class="n">object_confs</span> <span class="o">=</span> <span class="n">object_group</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;slit&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;cam_targ&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;grt_targ&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;filter&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;filter2&#39;</span><span class="p">]</span>
                                        <span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="c1"># .rename(columns={0: &#39;count&#39;})</span>

    <span class="k">for</span> <span class="n">comp_group</span> <span class="ow">in</span> <span class="n">comp_groups</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;slit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;slit&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grating&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grt_targ&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">comp_group</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_confs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filter2&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found a matching comparison lamp group&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">comp_group</span>

    <span class="k">raise</span> <span class="n">NoMatchFound</span></div>


<div class="viewcode-block" id="spectroscopic_extraction"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.spectroscopic_extraction">[docs]</a><span class="k">def</span> <span class="nf">spectroscopic_extraction</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">extraction</span><span class="p">,</span>
                             <span class="n">comp_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">nfind</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                             <span class="n">n_sigma_extract</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                             <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function does not do the actual extraction but prepares the data</span>



<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData Instance</span>
<span class="sd">        extraction (str): Extraction type name. _simple_ or _optimal_</span>
<span class="sd">        comp_list (list): List of ccdproc.CCDData instances of COMP lamps data</span>
<span class="sd">        nfind (int): Maximum number of targets to be returned</span>
<span class="sd">        n_sigma_extract (int): Number of sigmas to be used for extraction</span>
<span class="sd">        plots (bool): If plots will be shown or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        extracted (list): List of ccdproc.CCDData instances</span>
<span class="sd">        comp_zones (list): List of ccdproc.CCDData instances</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoTargetException (Exception): A NoTargetException if there is no target</span>
<span class="sd">           found.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>

    <span class="n">comp_zones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">comp_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># print(comp_list)</span>

    <span class="n">iccd</span> <span class="o">=</span> <span class="n">remove_background_by_median</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">)</span>

    <span class="n">profile_model</span> <span class="o">=</span> <span class="n">identify_targets</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">iccd</span><span class="p">,</span> <span class="n">nfind</span><span class="o">=</span><span class="n">nfind</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
    <span class="k">del</span> <span class="p">(</span><span class="n">iccd</span><span class="p">)</span>

    <span class="n">background_image</span> <span class="o">=</span> <span class="n">create_background_image</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                               <span class="n">profile_model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span>
                                               <span class="n">nsigma</span><span class="o">=</span><span class="n">n_sigma_extract</span><span class="p">,</span>
                                               <span class="n">separation</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile_model</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="n">trace_targets</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
        <span class="c1"># extract(ccd=ccd,</span>
        <span class="c1">#         spatial_profile=profile_model,</span>
        <span class="c1">#         n_sigma_extract=10,</span>
        <span class="c1">#         sampling_step=5)</span>
        <span class="k">if</span> <span class="s1">&#39;CompoundModel&#39;</span> <span class="ow">in</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)):</span>
                <span class="n">submodel_name</span> <span class="o">=</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

                <span class="n">ntrace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">profile_model</span><span class="p">[</span><span class="n">submodel_name</span><span class="p">]</span>

                <span class="n">zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span>
                    <span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                    <span class="n">trace</span><span class="o">=</span><span class="n">ntrace</span><span class="p">,</span>
                    <span class="n">trace_index</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">[</span><span class="n">submodel_name</span><span class="p">],</span>
                    <span class="n">n_sigma_extract</span><span class="o">=</span><span class="n">n_sigma_extract</span><span class="p">,</span>
                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                    <span class="n">comp_zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                                    <span class="n">trace</span><span class="o">=</span><span class="n">ntrace</span><span class="p">,</span>
                                                    <span class="n">trace_index</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
                                                    <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
                    <span class="c1"># since a comparison lamp only needs only the relative line</span>
                    <span class="c1"># center in the dispersion direction, therefore the flux is</span>
                    <span class="c1"># not important we are only calculating the median along the</span>
                    <span class="c1"># spatial direction</span>
                    <span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">comp_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_zone</span><span class="p">)</span>

                <span class="n">background_level</span> <span class="o">=</span> <span class="n">get_background_value</span><span class="p">(</span>
                    <span class="n">background_image</span><span class="o">=</span><span class="n">background_image</span><span class="p">,</span>
                    <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">)</span>

                <span class="n">extracted_ccd</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                        <span class="n">trace</span><span class="o">=</span><span class="n">ntrace</span><span class="p">,</span>
                                        <span class="n">spatial_profile</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                        <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                        <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                        <span class="n">background_level</span><span class="o">=</span><span class="n">background_level</span><span class="p">,</span>
                                        <span class="n">sampling_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                        <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>
                <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_ccd</span><span class="p">)</span>

                <span class="c1"># if plots:</span>
                <span class="c1">#     plt.imshow(nccd.data)</span>
                <span class="c1">#     plt.show()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">ntrace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span>
                <span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                <span class="n">trace</span><span class="o">=</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">trace_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span>
                <span class="n">n_sigma_extract</span><span class="o">=</span><span class="n">n_sigma_extract</span><span class="p">,</span>
                <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
                <span class="n">comp_zone</span> <span class="o">=</span> <span class="n">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                                                <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                                <span class="n">trace</span><span class="o">=</span><span class="n">ntrace</span><span class="p">,</span>
                                                <span class="n">trace_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                                <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

                <span class="c1"># since a comparison lamp only needs the relative line</span>
                <span class="c1"># center in the dispersion direction, therefore the flux is not</span>
                <span class="c1"># important we are only calculating the median along the spatial</span>
                <span class="c1"># direction</span>
                <span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">comp_zone</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">comp_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_zone</span><span class="p">)</span>

            <span class="n">background_level</span> <span class="o">=</span> <span class="n">get_background_value</span><span class="p">(</span>
                <span class="n">background_image</span><span class="o">=</span><span class="n">background_image</span><span class="p">,</span>
                <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">)</span>

            <span class="n">extracted_ccd</span> <span class="o">=</span> <span class="n">extract</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                    <span class="n">trace</span><span class="o">=</span><span class="n">ntrace</span><span class="p">,</span>
                                    <span class="n">spatial_profile</span><span class="o">=</span><span class="n">profile_model</span><span class="p">,</span>
                                    <span class="n">extraction</span><span class="o">=</span><span class="n">extraction</span><span class="p">,</span>
                                    <span class="n">zone</span><span class="o">=</span><span class="n">zone</span><span class="p">,</span>
                                    <span class="n">background_level</span><span class="o">=</span><span class="n">background_level</span><span class="p">,</span>
                                    <span class="n">sampling_step</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                    <span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">)</span>

            <span class="n">extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_ccd</span><span class="p">)</span>

            <span class="c1"># if plots:</span>
            <span class="c1">#     plt.imshow(nccd.data)</span>
            <span class="c1">#     plt.show()</span>

        <span class="c1"># print(extracted)</span>
        <span class="c1"># print(comp_zones)</span>
        <span class="k">return</span> <span class="n">extracted</span><span class="p">,</span> <span class="n">comp_zones</span>

    <span class="k">elif</span> <span class="n">profile_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t receive identified targets &quot;</span>
                    <span class="s2">&quot;from </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">NoTargetException</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got wrong input&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="identify_targets"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.identify_targets">[docs]</a><span class="k">def</span> <span class="nf">identify_targets</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">nfind</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify targets cross correlating spatial profile with a gaussian model</span>


<span class="sd">    Args:</span>
<span class="sd">        ccd (object): a ccdproc.CCDData instance</span>
<span class="sd">        nfind (int): Maximum number of targets to be returned</span>
<span class="sd">        plots (bool): to show debugging plots</span>

<span class="sd">    Returns:</span>
<span class="sd">        profile_model (object): an astropy.modeling.Model instance, it could be</span>
<span class="sd">            a Gaussian1D or CompoundModel (several Gaussian1D). Each of them</span>
<span class="sd">            represent a point source spectrum found.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">):</span>
        <span class="n">slit_size</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z&quot;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">])</span>
        <span class="n">serial_binning</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CCDSUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># order will be used for finding the peaks later but also as an initial</span>
        <span class="c1"># estimate for stddev of gaussian</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">slit_size</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">*</span> <span class="n">serial_binning</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion Axis (x)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Spatial Axis (y)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">median_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Fitting Background</span>

        <span class="c1"># Before doing the fitting we will do a sigma clipping in order to</span>
        <span class="c1"># remove any feature.</span>
        <span class="n">clipped_profile</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">median_profile</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">linear_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Linear1D</span><span class="p">(</span><span class="n">slope</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">intercept</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">median_profile</span><span class="p">))</span>

        <span class="n">linear_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LinearLSQFitter</span><span class="p">()</span>

        <span class="c1"># the fitters do not support masked arrays so we need to have a new</span>
        <span class="c1"># array without the masked (clipped) elements.</span>
        <span class="n">new_profile</span> <span class="o">=</span> <span class="n">clipped_profile</span><span class="p">[</span><span class="o">~</span><span class="n">clipped_profile</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># also the indexes are different</span>
        <span class="n">new_x_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_profile</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">clipped_profile</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="n">fitted_background</span> <span class="o">=</span> <span class="n">linear_fitter</span><span class="p">(</span><span class="n">linear_model</span><span class="p">,</span> <span class="n">new_x_axis</span><span class="p">,</span> <span class="n">new_profile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Background Fitting Model Defined&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">median_profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">linear_model</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Background Fitted Model&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">median_profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitted_background</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Removing Background</span>
        <span class="c1"># Remove the background and set negative values to zero</span>

        <span class="c1"># build an array of the same dimensions of the profile</span>
        <span class="n">background_array</span> <span class="o">=</span> <span class="n">fitted_background</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">median_profile</span><span class="p">)))</span>

        <span class="n">background_subtracted</span> <span class="o">=</span> <span class="n">median_profile</span> <span class="o">-</span> <span class="n">background_array</span>

        <span class="c1"># set negative values to zero</span>
        <span class="n">background_subtracted</span><span class="p">[</span><span class="n">background_subtracted</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">final_profile</span> <span class="o">=</span> <span class="n">background_subtracted</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># sigma clip and then get some features of the noise.</span>
        <span class="n">clipped_final_profile</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">final_profile</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># define the propper x-axis</span>
        <span class="n">new_x_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_final_profile</span><span class="p">))</span> <span class="k">if</span>
                      <span class="ow">not</span> <span class="n">clipped_final_profile</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="n">clipped_final_profile</span> <span class="o">=</span> <span class="n">clipped_final_profile</span><span class="p">[</span><span class="o">~</span><span class="n">clipped_final_profile</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>



        <span class="n">background_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">clipped_final_profile</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">clipped_final_profile</span><span class="p">))</span>
        <span class="c1"># print(&#39;MEAN: &#39;, np.mean(clipped_final_profile))</span>
        <span class="c1"># print(&#39;MEDIAN: &#39;, np.median(clipped_final_profile))</span>
        <span class="c1"># print(&#39;STDDEV: &#39;, np.std(clipped_final_profile))</span>
        <span class="c1"># print(&#39;RANGE: &#39;, background_level)</span>

        <span class="c1"># TODO (simon): Add information to plots</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># if plt.isinteractive():</span>
            <span class="c1">#     plt.ioff()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Median Along Dispersion Axis (spatial)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">background_subtracted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Background Subtracted Data&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span> <span class="n">clipped_final_profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sigma Clip Data&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">background_level</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Min-Max Difference&#39;</span><span class="p">)</span>
            <span class="c1"># plt.plot(final_profile, color=&#39;r&#39;)</span>
            <span class="c1"># plt.plot(median_profile)</span>
            <span class="c1"># plt.plot(background_array)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Identify targets</span>
        <span class="c1"># Now that the profile is flat it should be easier to identify targets.</span>

        <span class="n">filtered_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">final_profile</span> <span class="o">&gt;</span> <span class="n">final_profile</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">final_profile</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">final_profile</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">)</span>

        <span class="n">_upper_limit</span> <span class="o">=</span> <span class="n">final_profile</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">final_profile</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="c1"># print(_upper_limit)</span>
        <span class="c1"># print(np.median(final_profile))</span>

        <span class="c1"># find the peaks</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">argrelmax</span><span class="p">(</span><span class="n">filtered_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># find profile values for peaks found</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_profile</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>

        <span class="c1"># sort values and reverse the order so that larger values are first</span>
        <span class="n">sorted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">values</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># pick nfind top values</span>
        <span class="n">n_top_values</span> <span class="o">=</span> <span class="n">sorted_values</span><span class="p">[:</span><span class="n">nfind</span><span class="p">]</span>
        <span class="c1"># print(n_top_values)</span>

        <span class="c1"># retrieve the original index (real location) of the peaks</span>
        <span class="n">selected_peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">n_top_values</span><span class="p">:</span>
            <span class="c1"># discard peaks smaller than twice the level of background</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">background_level</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span> <span class="o">==</span> <span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#     print(index[0])</span>
                <span class="n">selected_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Discarding peak: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">final_profile</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">_upper_limit</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">selected_peaks</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># build the model to return</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">best_stddev</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">profile_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">selected_peaks</span><span class="p">:</span>
            <span class="n">peak_value</span> <span class="o">=</span> <span class="n">median_profile</span><span class="p">[</span><span class="n">peak</span><span class="p">]</span>
            <span class="n">gaussian</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">peak_value</span><span class="p">,</span>
                                         <span class="n">mean</span><span class="o">=</span><span class="n">peak</span><span class="p">,</span>
                                         <span class="n">stddev</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="s1">&#39;Gaussian_</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak</span><span class="p">))</span>

            <span class="c1"># fixes mean and amplitude already found, just finding stddev</span>
            <span class="n">gaussian</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">gaussian</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fitted_gaussian</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span>
                                     <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">median_profile</span><span class="p">)),</span>
                                     <span class="n">median_profile</span><span class="p">)</span>

            <span class="c1"># after being fitted, unfix the parameters and now fix stddev</span>
            <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># manually forcing the use of the best stddev if possitive</span>
            <span class="c1"># this disables the pipeline for extended sources</span>
            <span class="k">if</span> <span class="n">best_stddev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">best_stddev</span> <span class="o">=</span> <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="n">best_stddev</span> <span class="o">&lt;</span> <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">best_stddev</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">best_stddev</span> <span class="o">=</span> <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
            <span class="k">if</span> <span class="n">best_stddev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">best_stddev</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># print(fitted_gaussian.stddev.value)</span>
            <span class="c1"># plt.plot(median_profile, color=&#39;b&#39;)</span>
            <span class="c1"># plt.plot(fitted_gaussian(range(len(median_profile))), color=&#39;r&#39;)</span>
            <span class="c1"># plt.show()</span>

            <span class="c1"># this ensures the profile returned are valid</span>
            <span class="k">if</span> <span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">profile_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">profile_model</span> <span class="o">=</span> <span class="n">fitted_gaussian</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profile_model</span> <span class="o">+=</span> <span class="n">fitted_gaussian</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">median_profile</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">profile_model</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">median_profile</span><span class="p">))),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># plt.imshow(ccd.data, clim=(50, 200), cmap=&#39;gray&#39;)</span>
        <span class="c1"># for peak in selected_peaks:</span>
        <span class="c1">#     plt.axhline(peak, color=&#39;r&#39;)</span>
        <span class="c1"># plt.show()</span>

        <span class="k">if</span> <span class="n">profile_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">profile_model</span></div>


<div class="viewcode-block" id="trace"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.trace">[docs]</a><span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">trace_model</span><span class="p">,</span> <span class="n">fitter</span><span class="p">,</span> <span class="n">sampling_step</span><span class="p">,</span> <span class="n">nsigmas</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the trace of a spectrum</span>

<span class="sd">    This function is called by the `trace_targets` targets, the difference is</span>
<span class="sd">    that it only takes single models only not CompoundModels so this function</span>
<span class="sd">    is called for every single target.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This method forces the trace to go withing a rectangular region of</span>
<span class="sd">        center `model.mean.value` and width `2 * nsigmas`, this is for allowing</span>
<span class="sd">        the trace of low SNR targets. The assumption is valid since the spectra</span>
<span class="sd">        are always well aligned to the detectors&#39;s pixel columns. (dispersion</span>
<span class="sd">        axis)</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance, 2D image.</span>
<span class="sd">        model (object): An astropy.modeling.Model instance that contains</span>
<span class="sd">            information regarding the target to be traced.</span>
<span class="sd">        trace_model (object): An astropy.modeling.Model instance, usually a low</span>
<span class="sd">            order polynomial.</span>
<span class="sd">        fitter (object): An astropy.modeling.fitting.Fitter instance. Will fit</span>
<span class="sd">            the sampled points to construct the trace model</span>
<span class="sd">        sampling_step (int): Step for sampling the spectrum.</span>
<span class="sd">        nsigmas (int): Number of stddev to each side of the mean to be used for</span>
<span class="sd">            searching the trace.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An astropy.modeling.Model instance, that defines the trace of the</span>
<span class="sd">            spectrum.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">sampling_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dispersion_length</span><span class="p">,</span> <span class="n">sampling_step</span><span class="p">)</span>
    <span class="n">sample_values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">model_stddev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
    <span class="n">model_mean</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span>

    <span class="n">sample_center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_mean</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">sampling_axis</span><span class="p">:</span>

        <span class="n">lower_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_center</span> <span class="o">-</span> <span class="n">nsigmas</span> <span class="o">*</span> <span class="n">model_stddev</span><span class="p">)</span>
        <span class="n">upper_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_center</span> <span class="o">+</span> <span class="n">nsigmas</span> <span class="o">*</span> <span class="n">model_stddev</span><span class="p">)</span>

        <span class="c1"># print(sample_center, nsigmas, model_stddev, lower_limit, upper_limit)</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">lower_limit</span><span class="p">:</span><span class="n">upper_limit</span><span class="p">,</span> <span class="n">point</span><span class="p">:</span><span class="n">point</span> <span class="o">+</span> <span class="n">sampling_step</span><span class="p">]</span>
        <span class="n">sample_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sample_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">sample_median</span><span class="p">)</span>
            <span class="c1"># print(sample_peak + lower_limit)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># plt.plot(model(range(spatial_length)))</span>
            <span class="c1"># plt.plot(ccd.data[:,point])</span>
            <span class="c1"># plt.show()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nsigmas &#39;</span><span class="p">,</span> <span class="n">nsigmas</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model Stddev &#39;</span><span class="p">,</span> <span class="n">model_stddev</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample_center &#39;</span><span class="p">,</span> <span class="n">sample_center</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample &#39;</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sample_median &#39;</span><span class="p">,</span> <span class="n">sample_median</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lower_limit &#39;</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;upper_limit &#39;</span><span class="p">,</span> <span class="n">upper_limit</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;point &#39;</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;point + sampling_step &#39;</span><span class="p">,</span> <span class="n">point</span> <span class="o">+</span> <span class="n">sampling_step</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">sample_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_peak</span> <span class="o">+</span> <span class="n">lower_limit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sample_peak</span> <span class="o">+</span> <span class="n">lower_limit</span> <span class="o">-</span> <span class="n">model_mean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nsigmas</span> <span class="o">*</span> <span class="n">model_stddev</span><span class="p">:</span>
            <span class="n">sample_center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_peak</span> <span class="o">+</span> <span class="n">lower_limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(np.abs(sample_peak + lower_limit - model_mean), nsigmas * model_stddev)</span>
            <span class="n">sample_center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">model_mean</span><span class="p">)</span>

    <span class="n">fitted_trace</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">trace_model</span><span class="p">,</span> <span class="n">sampling_axis</span><span class="p">,</span> <span class="n">sample_values</span><span class="p">)</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sampling_axis</span><span class="p">,</span> <span class="n">sample_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">lower_limit</span><span class="p">,</span>
                    <span class="n">upper_limit</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitted_trace</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dispersion_length</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="c1"># plt.plot(model(range(spatial_length)))</span>
        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># print(dispersion_length)</span>
        <span class="c1"># print(sampling_axis)</span>

    <span class="c1"># fitted_trace = None</span>

    <span class="k">return</span> <span class="n">fitted_trace</span></div>


<div class="viewcode-block" id="trace_targets"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.trace_targets">[docs]</a><span class="k">def</span> <span class="nf">trace_targets</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">sampling_step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">pol_deg</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the trace of the target&#39;s spectrum on the image</span>

<span class="sd">    This function defines a low order polynomial that trace the location of the</span>
<span class="sd">    spectrum. The attributes pol_deg and sampling_step define the polynomial</span>
<span class="sd">    degree and the spacing in pixels for the samples. For every sample a</span>
<span class="sd">    gaussian model is fitted and the center (mean) is recorded and since</span>
<span class="sd">    spectrum traces vary smoothly this value is used as a new center for the</span>
<span class="sd">    base model used to fit the spectrum profile.</span>

<span class="sd">    Notes:</span>
<span class="sd">        This doesn&#39;t work for extended sources.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData</span>
<span class="sd">        profile (object): Instance of astropy.modeling.Model, contains the</span>
<span class="sd">            spatial profile of the 2D spectrum.</span>
<span class="sd">        sampling_step (int): Frequency of sampling in pixels</span>
<span class="sd">        pol_deg (int): Polynomial degree for fitting the trace</span>
<span class="sd">        plots (bool): If True will show plots (debugging)</span>

<span class="sd">    Returns:</span>
<span class="sd">        all_traces (list): List that contains traces that are</span>
<span class="sd">            astropy.modeling.Model instance</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># added two assert for debugging purposes</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

    <span class="c1"># Initialize model fitter</span>
    <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># Initialize the model to fit the traces</span>
    <span class="n">trace_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Polynomial1D</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">pol_deg</span><span class="p">)</span>

    <span class="c1"># List that will contain all the Model instances corresponding to traced</span>
    <span class="c1"># targets</span>
    <span class="n">all_traces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;CompoundModel&#39;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># TODO (simon): evaluate if targets are too close together.</span>

        <span class="n">stddev_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">_param_names</span> <span class="k">if</span> <span class="s1">&#39;stddev&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

        <span class="n">mean_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">_param_names</span> <span class="k">if</span> <span class="s1">&#39;mean&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]</span>

        <span class="n">stddev_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stddev_keys</span><span class="p">]</span>

        <span class="n">mean_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mean_keys</span><span class="p">]</span>

        <span class="c1"># if len(mean_values) == 1:</span>
        <span class="c1">#     nsigmas = 20</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # get maximum width</span>
        <span class="c1">#     for i in range(len(mean_values)-1):</span>


        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)):</span>
            <span class="n">submodel_name</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="n">submodel_name</span><span class="p">]</span>

            <span class="n">single_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                                 <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                 <span class="n">trace_model</span><span class="o">=</span><span class="n">trace_model</span><span class="p">,</span>
                                 <span class="n">fitter</span><span class="o">=</span><span class="n">model_fitter</span><span class="p">,</span>
                                 <span class="n">sampling_step</span><span class="o">=</span><span class="n">sampling_step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">all_traces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_traces</span> <span class="o">=</span> <span class="p">[</span><span class="n">single_trace</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_trace</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_traces</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">single_trace</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                             <span class="n">model</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span>
                             <span class="n">trace_model</span><span class="o">=</span><span class="n">trace_model</span><span class="p">,</span>
                             <span class="n">fitter</span><span class="o">=</span><span class="n">model_fitter</span><span class="p">,</span>
                             <span class="n">sampling_step</span><span class="o">=</span><span class="n">sampling_step</span><span class="p">,</span>
                             <span class="n">nsigmas</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">single_trace</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_extraction_zone"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_extraction_zone">[docs]</a><span class="k">def</span> <span class="nf">get_extraction_zone</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span>
                        <span class="n">extraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">trace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">trace_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">n_sigma_extract</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">zone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the minimum rectangular CCD zone that fully contains the spectrum</span>

<span class="sd">    In this context, *fully contained* means the spectrum plus some region for</span>
<span class="sd">    background subtraction.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For Goodman HTS the alignment of the spectrum with the detector lines</span>
<span class="sd">        is quite good, that&#39;s why this function does not consider the trace.</span>
<span class="sd">        Also because the `model` argument is based on the median throughout all</span>
<span class="sd">        the detector along the dispersion axis, so if there is a strong</span>
<span class="sd">        misalignment it will result in a wider Gaussian Profile</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance, the image from which the zone</span>
<span class="sd">            will be extracted</span>
<span class="sd">        extraction (str): Extraction type, `simple` or `optimal`</span>
<span class="sd">        trace (object): An astropy.modeling.Model instance that correspond to</span>
<span class="sd">            the trace of the spectrum</span>
<span class="sd">        trace_index (int): The index number of the spectrum. 0 based.</span>
<span class="sd">        model (object): An astropy.modeling.Model instance that was previously</span>
<span class="sd">            fitted to the spatial profile.</span>
<span class="sd">        n_sigma_extract (int): Total number of sigmas to be extracted.</span>
<span class="sd">        plots (bool): If True will show plots, similar to a debugging mode.</span>
<span class="sd">        zone (list): Low and high limits to extract</span>

<span class="sd">    Returns:</span>
<span class="sd">        nccd (object): Instance of ccdproc.CCDData that contains only the region</span>
<span class="sd">            extracted from the full image. The header is updated with a new HISTORY</span>
<span class="sd">            keyword that contain the region of the original image extracted.</span>
<span class="sd">        model (object): Instance of astropy.modeling.Model with an updated mean</span>
<span class="sd">            to match the new center in pixel units.</span>
<span class="sd">        zone (list): Low and high limits of extraction zone</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make a copy of the ccd image</span>
    <span class="n">nccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n_sigma_extract</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Extracting zone centered at: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

        <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># get maximum variation in spatial direction</span>
        <span class="n">trace_array</span> <span class="o">=</span> <span class="n">trace</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dispersion_length</span><span class="p">))</span>
        <span class="n">trace_inclination</span> <span class="o">=</span> <span class="n">trace_array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">trace_array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trace Min-Max difference: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trace_inclination</span><span class="p">))</span>

        <span class="c1"># m_mean = model.mean.value</span>
        <span class="n">m_stddev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="n">extract_width</span> <span class="o">=</span> <span class="n">n_sigma_extract</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m_stddev</span>

        <span class="n">low_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">trace_array</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">extract_width</span><span class="p">)])</span>

        <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">trace_array</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">extract_width</span><span class="p">),</span>
                          <span class="n">spatial_length</span><span class="p">])</span>

        <span class="c1"># in some rare cases the low_lim turns out larger than hig_lim which</span>
        <span class="c1"># creates a series of problems regarding extraction, here I just reverse</span>
        <span class="c1"># them</span>
        <span class="k">if</span> <span class="n">low_lim</span> <span class="o">&gt;</span> <span class="n">hig_lim</span><span class="p">:</span>
            <span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">hig_lim</span><span class="p">,</span> <span class="n">low_lim</span>

        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Zone: low </span><span class="si">{:d}</span><span class="s1">, high </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">))</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="p">[</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">]</span>

        <span class="c1"># This is to define the APNUM1 Keyword for the header.</span>

        <span class="n">apnum_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trace_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                              <span class="mi">1</span><span class="p">,</span>
                                              <span class="n">low_lim</span><span class="p">,</span>
                                              <span class="n">hig_lim</span><span class="p">)</span>

        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;APNUM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apnum_1</span>

        <span class="c1"># this is necessary since we are cutting a piece of the full ccd.</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">c0</span><span class="o">.</span><span class="n">value</span> <span class="o">-=</span> <span class="n">low_lim</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Changing attribute c0 from trace, this is to adjust it to &#39;</span>
                 <span class="s1">&#39;the new extraction zone which is smaller that the full CCD.&#39;</span><span class="p">)</span>

        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Changing attribute mean of profile model&#39;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">extract_width</span>



        <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trimming mask&#39;</span><span class="p">)</span>
            <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Subsection of CCD &#39;</span> \
                                 <span class="s1">&#39;[</span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">, :]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># return nccd, trace, model, zone</span>
        <span class="k">return</span> <span class="n">zone</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span> <span class="o">=</span> <span class="n">zone</span>

        <span class="n">apnum_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trace_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                               <span class="mi">1</span><span class="p">,</span>
                                               <span class="n">low_lim</span><span class="p">,</span>
                                               <span class="n">hig_lim</span><span class="p">)</span>

        <span class="n">nccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;APNUM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apnum_1</span>

        <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Trimming mask&#39;</span><span class="p">)</span>
            <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">hig_lim</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Subsection of CCD &#39;</span> \
                                 <span class="s1">&#39;[</span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">, :]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">low_lim</span><span class="p">,</span> <span class="n">hig_lim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nccd</span></div>


<div class="viewcode-block" id="add_wcs_keys"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.add_wcs_keys">[docs]</a><span class="k">def</span> <span class="nf">add_wcs_keys</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds generic keyword to the header</span>

<span class="sd">    Linear wavelength solutions require a set of standard fits keywords. Later</span>
<span class="sd">    on they will be updated accordingly</span>
<span class="sd">    The main goal of putting them here is to have consistent and nicely ordered</span>
<span class="sd">    headers</span>

<span class="sd">    Notes:</span>
<span class="sd">        This does NOT add a WCS solution, just the keywords</span>

<span class="sd">    Args:</span>
<span class="sd">        header (object): New header without WCS entries</span>

<span class="sd">    Returns:</span>
<span class="sd">        header (object): Modified header with added WCS keywords</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BANDID1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spectrum - background none, weights none, clean no&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;APNUM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1 1 0 0&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSDIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LINEAR&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;LTM1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAT0_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;system=equispec&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAT1_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wtype=linear label=Wavelength units=angstroms&#39;</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DC-FLAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">header</span><span class="p">[</span><span class="s1">&#39;DCLOG1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;REFSPEC1 = non set&#39;</span>
        <span class="k">return</span> <span class="n">header</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t add wcs keywords to header&quot;</span><span class="p">)</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">err</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_background_by_median"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.remove_background_by_median">[docs]</a><span class="k">def</span> <span class="nf">remove_background_by_median</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove Background of a ccd spectrum image</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): A ccdproc.CCDData instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): The modified</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_ccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">new_ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># x, y = ccd.data.shape</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">-=</span> <span class="n">median</span>
    <span class="n">data</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">new_ccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>

    <span class="c1"># ccd.write(&#39;/user/simon/dummy_{:d}.fits&#39;.format(g), clobber=True)</span>
    <span class="k">return</span> <span class="n">new_ccd</span></div>


<div class="viewcode-block" id="get_background_value"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.get_background_value">[docs]</a><span class="k">def</span> <span class="nf">get_background_value</span><span class="p">(</span><span class="n">background_image</span><span class="p">,</span> <span class="n">zone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">background_image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">background_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">background_image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">target_zones_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">background_profile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">target_zones</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_zones_points</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> \
                        <span class="k">if</span>
                        <span class="n">target_zones_points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_zones_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">target_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">target_zones_points</span><span class="p">))</span>
        <span class="n">target_zones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_zones_points</span><span class="p">))</span>
        <span class="n">target_zones</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="c1"># plt.imshow(background_image, clim=(0,60))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">target_zones</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">target_zones</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">target_zones</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>

                <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found valid target zone:&#39;</span>
                               <span class="s1">&#39; </span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_zones</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                   <span class="n">target_zones</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>

                <span class="n">full_zone</span> <span class="o">=</span> <span class="n">target_zones_points</span><span class="p">[</span>
                            <span class="n">target_zones</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">target_zones</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="n">zone</span> <span class="o">=</span> <span class="p">[</span><span class="n">full_zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">full_zone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="c1"># zone_width = len(zone)</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_spec</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Target Zone is too small&#39;</span><span class="p">)</span>

    <span class="c1"># here do the evaluation if background zones are valid.</span>
    <span class="n">first_background</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">second_background</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">background_median</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">zone_width</span> <span class="o">=</span> <span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># first background zone</span>
    <span class="n">back_first_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">zone_width</span><span class="p">)</span>
    <span class="n">back_first_high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">zone_width</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">back_first_low</span> <span class="o">&lt;</span> <span class="n">back_first_high</span><span class="p">:</span>

        <span class="n">first_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">background_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                     <span class="n">back_first_low</span><span class="p">:</span><span class="n">back_first_high</span><span class="p">,</span>
                                     <span class="p">:],</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># print(&#39;First b &#39;, back_first_low, back_first_high)</span>
        <span class="c1"># plt.axhspan(back_first_low,</span>
        <span class="c1">#             back_first_high,</span>
        <span class="c1">#             color=&#39;w&#39;,</span>
        <span class="c1">#             alpha=0.5)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Zone [</span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">] is forbidden&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">back_first_low</span><span class="p">,</span>
            <span class="n">back_first_high</span><span class="p">))</span>

        <span class="c1"># plt.axhspan(back_first_low,</span>
        <span class="c1">#             back_first_high,</span>
        <span class="c1">#             color=&#39;k&#39;,</span>
        <span class="c1">#             alpha=0.5)</span>

    <span class="c1"># second background zone</span>
    <span class="n">back_second_low</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">zone_width</span><span class="p">)</span>
    <span class="n">back_second_high</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">zone_width</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">back_second_low</span> <span class="o">&lt;</span> <span class="n">back_second_high</span> <span class="o">&lt;</span> <span class="n">spatial_length</span><span class="p">:</span>

        <span class="n">second_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">background_image</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                                    <span class="n">back_second_low</span><span class="p">:</span><span class="n">back_second_high</span><span class="p">,</span>
                                    <span class="p">:],</span>
                                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># print(&#39;Second b &#39;, back_second_low, back_second_high)</span>
        <span class="c1"># plt.axhspan(back_second_low,</span>
        <span class="c1">#             back_second_high,</span>
        <span class="c1">#             color=&#39;w&#39;,</span>
        <span class="c1">#             alpha=0.5)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Zone [</span><span class="si">{:d}</span><span class="s1">:</span><span class="si">{:d}</span><span class="s1">] is forbidden&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">back_second_low</span><span class="p">,</span>
            <span class="n">back_second_high</span><span class="p">))</span>
        <span class="c1"># plt.axhspan(back_second_low,</span>
        <span class="c1">#             back_second_high,</span>
        <span class="c1">#             color=&#39;k&#39;,</span>
        <span class="c1">#             alpha=0.5)</span>
    <span class="k">if</span> <span class="n">first_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">second_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">background_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">first_background</span><span class="p">,</span> <span class="n">second_background</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># plt.title(&#39;Background Mean&#39;)</span>
        <span class="c1"># plt.plot(background_mean)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">return</span> <span class="n">background_mean</span>
    <span class="k">elif</span> <span class="n">first_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">second_background</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">first_background</span>
    <span class="k">elif</span> <span class="n">first_background</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">second_background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">second_background</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Not possible to get a background extraction zone&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>



    <span class="c1"># background_mean = np.mean(background_image.data, axis=0)</span>
    <span class="c1"># background_median = np.median(background_image.data, axis=0)</span>
    <span class="c1"># plt.plot(background_mean, color=&#39;b&#39;)</span>
    <span class="c1"># plt.plot(background_median, color=&#39;r&#39;)</span>
    <span class="c1"># plt.show()</span>
    <span class="c1">#</span>
    <span class="c1"># return background_median</span>


<div class="viewcode-block" id="create_background_image"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.create_background_image">[docs]</a><span class="k">def</span> <span class="nf">create_background_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">profile_model</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">separation</span><span class="p">):</span>
    <span class="n">background_ccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">background_ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">target_profiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;CompoundModel&#39;</span> <span class="ow">in</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">)):</span>
            <span class="n">submodel_name</span> <span class="o">=</span> <span class="n">profile_model</span><span class="o">.</span><span class="n">submodel_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

            <span class="n">target_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile_model</span><span class="p">[</span><span class="n">submodel_name</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_profiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">profile_model</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">target_profiles</span><span class="p">:</span>
        <span class="n">target_mean</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span>
        <span class="n">target_stddev</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>

        <span class="n">data_low_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">target_mean</span> <span class="o">-</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">separation</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_stddev</span><span class="p">])</span>

        <span class="n">data_high_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">spatial_length</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">target_mean</span> <span class="o">+</span> <span class="p">(</span><span class="n">nsigma</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">separation</span><span class="p">)</span> <span class="o">*</span> <span class="n">target_stddev</span><span class="p">)])</span>

        <span class="n">background_ccd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">data_low_lim</span><span class="p">:</span><span class="n">data_high_lim</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Background Image&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background_ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">background_ccd</span></div>


<div class="viewcode-block" id="extract"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.extract">[docs]</a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span>
            <span class="n">trace</span><span class="p">,</span>
            <span class="n">spatial_profile</span><span class="p">,</span>
            <span class="n">extraction</span><span class="p">,</span>
            <span class="n">zone</span><span class="p">,</span>
            <span class="n">background_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">sampling_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs spectrum extraction</span>

<span class="sd">    This function is designed to perform two types of spectrum extraction, a</span>
<span class="sd">    simple sum in the spatial direction and an optimal extraction.</span>

<span class="sd">    Notes:</span>
<span class="sd">        For the beta release the optimal extraction is not implemented.</span>

<span class="sd">    Args:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData containing a 2D spectrum</span>
<span class="sd">        trace (object): Instance of astropy.modeling.Model, a low order</span>
<span class="sd">            polynomial that defines the trace of the spectrum in the ccd object.</span>
<span class="sd">        spatial_profile (object): Instance of astropy.modeling.Model, a Gaussian</span>
<span class="sd">            model previously fitted to the spatial profile of the 2D spectrum</span>
<span class="sd">            contained in the ccd object.</span>
<span class="sd">        extraction (str): Extraction type, can be `simple` or `optimal` for the</span>
<span class="sd">            beta release the optimal extraction is not implemented yet.</span>
<span class="sd">        zone (list):</span>
<span class="sd">        background_level (array):</span>
<span class="sd">        sampling_step (int): The optimal extraction needs to sample the spatial</span>
<span class="sd">            profile, this value defines the intervals at which get such</span>
<span class="sd">            sampling.</span>
<span class="sd">        plots (bool): Determines whether display plots or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ccd (object): Instance of ccdproc.CCDData containing a 1D spectrum. The</span>
<span class="sd">            attribute &#39;data&#39; is replaced by the 1D array resulted from the</span>
<span class="sd">            extraction process.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: When `extraction` is optimal, this is valid for the</span>
<span class="sd">            beta release</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span>

    <span class="n">nccd</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">spatial_length</span><span class="p">,</span> <span class="n">dispersion_length</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">apnum1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1"> </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">zone</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zone</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;APNUM1 Keyword: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">apnum1</span><span class="p">))</span>

    <span class="c1"># create variance model</span>
    <span class="n">rdnoise</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">])</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">])</span>
    <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Original Name </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]))</span>

    <span class="n">variance_2d</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdnoise</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">gain</span><span class="p">)</span> <span class="o">/</span> <span class="n">gain</span>
    <span class="n">cr_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># if nccd.mask is None and nccd.header[&#39;OBSTYPE&#39;] == &#39;OBJECT&#39;:</span>
    <span class="c1">#     log_spec.debug(&#39;Finding cosmic rays to create mask&#39;)</span>
    <span class="c1">#     cr_mask = cosmicray_rejection(ccd=ccd, mask_only=True)</span>
    <span class="c1">#     cr_mask = np.log_spec.cal_not(cr_mask).astype(int)</span>
    <span class="c1"># elif nccd.mask is None and nccd.header[&#39;OBSTYPE&#39;] != &#39;OBJECT&#39;:</span>
    <span class="c1">#     log_spec.debug(&#39;Only OBSTYPE == OBJECT get cosmic ray rejection.&#39;)</span>
    <span class="c1">#     cr_mask = np.ones(nccd.data.shape, dtype=int)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     log_spec.debug(&#39;Cosmic ray mask already exists.&#39;)</span>
    <span class="c1">#     cr_mask = np.logical_not(nccd.mask).astype(int)</span>

    <span class="n">model_fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="c1"># print(spatial_profile.mean.value)</span>
    <span class="c1"># print(trace.c0.value)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_profile</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">):</span>
        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">amplitude</span><span class="o">.</span><span class="n">value</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="n">spatial_profile</span><span class="o">.</span><span class="n">stddev</span><span class="o">.</span><span class="n">value</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span>
                                      <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
                                      <span class="n">stddev</span><span class="o">=</span><span class="n">stddev</span><span class="p">)</span>
        <span class="c1"># print(&#39;Fixed &#39;, new_model.mean.fixed)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="n">log_spec</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nccd.data is a masked array: &#39;</span>
              <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">isMaskedArray</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">))))</span>

    <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># print(np.ma.isMaskedArray(nccd.data))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">set_fill_value</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extraction</span> <span class="o">==</span> <span class="s1">&#39;simple&#39;</span><span class="p">:</span>


        <span class="c1"># print(indexes)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cr_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># print(np.ma.isMaskedArray(nccd.data))</span>
        <span class="c1"># spectrum zone limit</span>
        <span class="n">low_lim</span><span class="p">,</span> <span class="n">high_lim</span> <span class="o">=</span> <span class="n">zone</span>
        <span class="n">spectrum_masked</span> <span class="o">=</span> <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">cr_mask</span>
        <span class="n">spectrum_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spectrum_masked</span><span class="p">[</span><span class="n">low_lim</span><span class="p">:</span><span class="n">high_lim</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">background_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">high_lim</span> <span class="o">-</span> <span class="n">low_lim</span><span class="p">)</span> <span class="o">*</span> <span class="n">background_level</span>

        <span class="n">nccd</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">spectrum_sum</span> <span class="o">-</span> <span class="n">background_sum</span>

        <span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;APNUM1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">apnum1</span>

        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Simple Extraction&#39;</span><span class="p">)</span>
            <span class="c1"># ax = fig.add_subplot(111)</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;GTK3Agg&#39;</span><span class="p">:</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;Qt4Agg&#39;</span><span class="p">:</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Dispersion Axis (Pixels)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (Counts)&#39;</span><span class="p">)</span>
            <span class="c1"># plt.plot(simple_sum, label=&#39;Simple Sum&#39;, color=&#39;k&#39;, alpha=0.5)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Simple Extracted&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">background_sum</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Background&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spectrum_sum</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectrum Raw Sum&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nccd</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">extraction</span> <span class="o">==</span> <span class="s1">&#39;optimal&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="c1"># out_spectrum = np.empty(dispersion_length)</span>
        <span class="c1"># for i in range(0, dispersion_length, sampling_step):</span>
        <span class="c1">#     # force the model to follow the trace</span>
        <span class="c1">#     new_model.mean.value = trace(i)</span>
        <span class="c1">#</span>
        <span class="c1">#     # warn if the difference of the spectrum position in the trace at the</span>
        <span class="c1">#     # extremes of the sampling range is larger than 1 pixel.</span>
        <span class="c1">#     if np.abs(trace(i) - trace(i + sampling_step)) &gt; 1:</span>
        <span class="c1">#         log_spec.warning(&#39;Sampling step might be too large&#39;)</span>
        <span class="c1">#</span>
        <span class="c1">#     sample = np.median(nccd.data[:, i:i + sampling_step], axis=1)</span>
        <span class="c1">#     fitted_profile = model_fitter(model=new_model,</span>
        <span class="c1">#                                   x=range(len(sample)),</span>
        <span class="c1">#                                   y=sample)</span>
        <span class="c1">#</span>
        <span class="c1">#     profile = fitted_profile(range(sample.size))</span>
        <span class="c1">#</span>
        <span class="c1">#     # enforce positivity</span>
        <span class="c1">#     pos_profile = np.array([np.max([0, x]) for x in profile])</span>
        <span class="c1">#</span>
        <span class="c1">#     # enforce normalization</span>
        <span class="c1">#     nor_profile = np.array([x / pos_profile.sum() for x in pos_profile])</span>
        <span class="c1">#</span>
        <span class="c1">#     if sampling_step &gt; 1:</span>
        <span class="c1">#         # TODO (simon): Simplify to Pythonic way</span>
        <span class="c1">#         right = min((i + sampling_step), dispersion_length)</span>
        <span class="c1">#</span>
        <span class="c1">#         for e in range(i, right, 1):</span>
        <span class="c1">#             mask = cr_mask[:, e]</span>
        <span class="c1">#             data = ma.masked_invalid(nccd.data[:, e])</span>
        <span class="c1">#             # print(ma.isMaskedArray(data))</span>
        <span class="c1">#             V = variance_2d[:, e]</span>
        <span class="c1">#             P = nor_profile</span>
        <span class="c1">#             a = [(P[z] / V[z]) / np.sum(P ** 2 / V) for z in</span>
        <span class="c1">#                  range(P.size)]</span>
        <span class="c1">#             weights = (nor_profile / variance_2d[:, e]) / np.sum(</span>
        <span class="c1">#                 nor_profile ** 2 / variance_2d[:, e])</span>
        <span class="c1">#             # print(&#39;SUMN &#39;, np.sum(a), np.sum(weights), np.sum(nor_profile), np.sum(P * weights))</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1">#             # if e in range(5, 4001, 500):</span>
        <span class="c1">#             #     plt.plot(nor_profile * data.max()/ nor_profile.max(), label=str(e))</span>
        <span class="c1">#             #     plt.plot(data, label=&#39;Data&#39;)</span>
        <span class="c1">#             #     plt.legend(loc=&#39;best&#39;)</span>
        <span class="c1">#             #     plt.show()</span>
        <span class="c1">#</span>
        <span class="c1">#             out_spectrum[e] = np.sum(data * mask * nor_profile)</span>
        <span class="c1"># nccd.data = out_spectrum</span>
        <span class="c1"># if plots:</span>
        <span class="c1">#     fig = plt.figure()</span>
        <span class="c1">#     fig.canvas.set_window_title(&#39;Optimal Extraction&#39;)</span>
        <span class="c1">#     # ax = fig.add_subplot(111)</span>
        <span class="c1">#     manager = plt.get_current_fig_manager()</span>
        <span class="c1">#</span>
        <span class="c1">#     if plt.get_backend() == u&#39;GTK3Agg&#39;:</span>
        <span class="c1">#         manager.window.maximize()</span>
        <span class="c1">#     elif plt.get_backend() == u&#39;Qt4Agg&#39;:</span>
        <span class="c1">#         manager.window.showMaximized()</span>
        <span class="c1">#</span>
        <span class="c1">#     plt.title(nccd.header[&#39;OBJECT&#39;])</span>
        <span class="c1">#     plt.xlabel(&#39;Dispersion Axis (Pixels)&#39;)</span>
        <span class="c1">#     plt.ylabel(&#39;Intensity (Counts)&#39;)</span>
        <span class="c1">#     # plt.plot(simple_sum, label=&#39;Simple Sum&#39;, color=&#39;k&#39;, alpha=0.5)</span>
        <span class="c1">#     plt.plot(nccd.data, color=&#39;k&#39;,</span>
        <span class="c1">#              label=&#39;Optimal Extracted&#39;)</span>
        <span class="c1">#     plt.xlim((0, len(nccd.data)))</span>
        <span class="c1">#     plt.legend(loc=&#39;best&#39;)</span>
        <span class="c1">#     if plt.isinteractive():</span>
        <span class="c1">#         plt.draw()</span>
        <span class="c1">#         plt.pause(1)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         plt.show()</span>

    <span class="c1"># nccd.data = out_spectrum</span>
    <span class="k">return</span> <span class="n">nccd</span></div>

<span class="c1"># def save_fits(full_name, clobber=True):</span>
<span class="c1">#     full_path = os.path.join(red_path,</span>
<span class="c1">#                              out_prefix + science_image)</span>
<span class="c1">#     ccd.write(full_path, clobber=True)</span>
<span class="c1">#     log_ccd.debug(&#39;Created science image: {:s}&#39;.format(full_path))</span>

<span class="c1"># classes definition</span>


<div class="viewcode-block" id="NightDataContainer"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer">[docs]</a><span class="k">class</span> <span class="nc">NightDataContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is designed to be the organized data container. It doesn&#39;t</span>
<span class="sd">    store image data but list of pandas.DataFrame objects. Also it stores</span>
<span class="sd">    critical variables such as sunrise and sunset times.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">technique</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes all the variables for the class</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Full path to the directory where raw data is located</span>
<span class="sd">            instrument (str): `Red` or `Blue` stating whether the data was taken</span>
<span class="sd">                using the Red or Blue Goodman Camera.</span>
<span class="sd">            technique (str): `Spectroscopy` or `Imaging` stating what kind of</span>
<span class="sd">                data was taken.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">technique</span> <span class="o">=</span> <span class="n">technique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="sd">&quot;&quot;&quot;For imaging use&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dome_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sky_flats</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;For spectroscopy use&quot;&quot;&quot;</span>

        <span class="c1"># comp_groups will store pandas.DataFrame (groups) that contain only</span>
        <span class="c1"># OBSTYPE == COMP, they should be requested only when needed, for the</span>
        <span class="c1"># science case when for every science target is observed with comparison</span>
        <span class="c1"># lamps and quartz (if)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_groups</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># object_groups will store pandas.DataFrame (groups) with only</span>
        <span class="c1"># OBSTYPE == OBJECT this is the case when the observer takes comparison</span>
        <span class="c1"># lamps only at the beginning or end of the night.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_groups</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># spec_groups will store pandas.DataFrame (groups) with a set of OBJECT</span>
        <span class="c1"># and COMP, this is usually the case for radial velocity studies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="sd">&quot;&quot;&quot;Time reference points&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_set_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_rise_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evening_twilight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">morning_twilight</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="NightDataContainer.add_bias"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_bias">[docs]</a>    <span class="k">def</span> <span class="nf">add_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bias_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a bias group</span>

<span class="sd">        Args:</span>
<span class="sd">            bias_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bias_group</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">technique</span> <span class="o">==</span> <span class="s1">&#39;Imaging&#39;</span><span class="p">:</span>

                <span class="n">log_ccd</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Imaging mode needs BIAS to work properly. &#39;</span>
                          <span class="s1">&#39;Go find some.&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_ccd</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;BIAS are needed for optimal results.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="p">[</span><span class="n">bias_group</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_day_flats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_day_flats">[docs]</a>    <span class="k">def</span> <span class="nf">add_day_flats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_flats</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Adds a daytime flat group</span>

<span class="sd">        Args:</span>
<span class="sd">            day_flats (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="o">=</span> <span class="p">[</span><span class="n">day_flats</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_flats</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">day_flats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_data_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_data_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_data_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a data group</span>

<span class="sd">        Args:</span>
<span class="sd">            data_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_comp_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_comp_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_comp_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a comp-only group</span>

<span class="sd">        Args:</span>
<span class="sd">            comp_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_object_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_object_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_object_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a object-only group</span>

<span class="sd">        Args:</span>
<span class="sd">            object_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">object_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.add_spec_group"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.add_spec_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_spec_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a data group containing object and comp</span>

<span class="sd">        Args:</span>
<span class="sd">            spec_group (pandas.DataFrame): Contains a set of keyword values of</span>
<span class="sd">                grouped image metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec_group</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_empty</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="NightDataContainer.set_sun_times"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.set_sun_times">[docs]</a>    <span class="k">def</span> <span class="nf">set_sun_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sun_set</span><span class="p">,</span> <span class="n">sun_rise</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets values for sunset and sunrise</span>

<span class="sd">        Args:</span>
<span class="sd">            sun_set (str): Sun set time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">            sun_rise (str):Sun rise time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sun_set_time</span> <span class="o">=</span> <span class="n">sun_set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sun_rise_time</span> <span class="o">=</span> <span class="n">sun_rise</span></div>

<div class="viewcode-block" id="NightDataContainer.set_twilight_times"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NightDataContainer.set_twilight_times">[docs]</a>    <span class="k">def</span> <span class="nf">set_twilight_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evening</span><span class="p">,</span> <span class="n">morning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets values for evening and morning twilight</span>

<span class="sd">        Args:</span>
<span class="sd">            evening (str): Evening twilight time in the format</span>
<span class="sd">                &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">            morning (str): Morning twilight time in the format</span>
<span class="sd">                &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evening_twilight</span> <span class="o">=</span> <span class="n">evening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">morning_twilight</span> <span class="o">=</span> <span class="n">morning</span></div></div>


<div class="viewcode-block" id="NoTargetException"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NoTargetException">[docs]</a><span class="k">class</span> <span class="nc">NoTargetException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;No targets identified.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NoMatchFound"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NoMatchFound">[docs]</a><span class="k">class</span> <span class="nc">NoMatchFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Did not find a match&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="NotEnoughLinesDetected"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.NotEnoughLinesDetected">[docs]</a><span class="k">class</span> <span class="nc">NotEnoughLinesDetected</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Not enough lines detected.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CritialError"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.core.CritialError">[docs]</a><span class="k">class</span> <span class="nc">CritialError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon Torres.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>