<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>goodman_spec.wavelength &#8212; Goodman Pipelines 1.0b1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0b1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for goodman_spec.wavelength</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf8 -*-</span>
<span class="sd">&quot;&quot;&quot;Contains the tools to produce a wavelength solution</span>

<span class="sd">This module gets the extracted data to produce a wavelength solution, linearize</span>
<span class="sd">the spectrum and write the solution to the image&#39;s header following the FITS</span>
<span class="sd">standard.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># TODO Reformat file - It is confusing at the moment</span>
<span class="c1"># TODO Reformat _ Re-order imports (first &quot;import ...&quot;, then &quot;from ... import ...&quot; alphabetically)</span>
<span class="c1"># TODO (simon): Discuss this because there are other rules that will probably conflict with this request.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># import matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="k">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="k">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="k">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">Gaussian1DKernel</span><span class="p">,</span> <span class="n">Box1DKernel</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">CCDData</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>

<span class="kn">from</span> <span class="nn">.wsbuilder</span> <span class="k">import</span> <span class="p">(</span><span class="n">ReadWavelengthSolution</span><span class="p">,</span> <span class="n">WavelengthFitter</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.linelist</span> <span class="k">import</span> <span class="n">ReferenceData</span>
<span class="kn">from</span> <span class="nn">goodman_ccd.core</span> <span class="k">import</span> <span class="p">(</span><span class="n">spectroscopic_extraction</span><span class="p">,</span>
                              <span class="n">search_comp_group</span><span class="p">,</span>
                              <span class="n">add_wcs_keys</span><span class="p">,</span>
                              <span class="n">NoTargetException</span><span class="p">,</span>
                              <span class="n">NoMatchFound</span><span class="p">,</span>
                              <span class="n">NotEnoughLinesDetected</span><span class="p">,</span>
                              <span class="n">CritialError</span><span class="p">)</span>



<span class="c1"># FORMAT = &#39;%(levelname)s:%(filename)s:%(module)s: 	%(message)s&#39;</span>
<span class="c1"># log.basicConfig(level=log.INFO, format=FORMAT)</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;redspec.wavelength&#39;</span><span class="p">)</span>

<span class="n">SHOW_PLOTS</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="process_spectroscopy_data"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.process_spectroscopy_data">[docs]</a><span class="k">def</span> <span class="nf">process_spectroscopy_data</span><span class="p">(</span><span class="n">data_container</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">extraction_type</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">        data_container:</span>
<span class="sd">        args:</span>
<span class="sd">        extraction_type:</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">data_container</span><span class="o">.</span><span class="n">is_empty</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">extraction_type</span> <span class="o">==</span> <span class="n">option</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;optimal&#39;</span><span class="p">])</span>
    <span class="c1"># to be returned</span>
    <span class="n">extracted</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">full_path</span> <span class="o">=</span> <span class="n">data_container</span><span class="o">.</span><span class="n">full_path</span>

    <span class="k">for</span> <span class="n">sub_container</span> <span class="ow">in</span> <span class="p">[</span><span class="n">groups</span> <span class="k">for</span> <span class="n">groups</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data_container</span><span class="o">.</span><span class="n">spec_groups</span><span class="p">,</span>
                          <span class="n">data_container</span><span class="o">.</span><span class="n">object_groups</span><span class="p">]</span> <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">sub_container</span><span class="p">:</span>
            <span class="c1"># instantiate WavelengthCalibration here for each group.</span>
            <span class="n">get_wsolution</span> <span class="o">=</span> <span class="n">WavelengthCalibration</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
            <span class="c1"># this will contain only obstype == OBJECT</span>
            <span class="n">object_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">obstype</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>
            <span class="c1"># this has to be initialized here</span>
            <span class="n">comp_group</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">comp_ccd_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;COMP&#39;</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">obstype</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Group has comparison lamps&#39;</span><span class="p">)</span>
                <span class="n">comp_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">obstype</span> <span class="o">==</span> <span class="s1">&#39;COMP&#39;</span><span class="p">]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Adding comparison lamps group to data container&#39;</span><span class="p">)</span>
                <span class="n">data_container</span><span class="o">.</span><span class="n">add_comp_group</span><span class="p">(</span><span class="n">comp_group</span><span class="o">=</span><span class="n">comp_group</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Group does not have comparison lamps&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data_container</span><span class="o">.</span><span class="n">comp_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;There are comparison lamp group candidates&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">comp_group</span> <span class="o">=</span> <span class="n">search_comp_group</span><span class="p">(</span>
                            <span class="n">object_group</span><span class="o">=</span><span class="n">object_group</span><span class="p">,</span>
                            <span class="n">comp_groups</span><span class="o">=</span><span class="n">data_container</span><span class="o">.</span><span class="n">comp_groups</span><span class="p">)</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This comparison lamp might not be optimal &#39;</span>
                                    <span class="s1">&#39;if you are doing radial velocity studies&#39;</span><span class="p">)</span>

                    <span class="k">except</span> <span class="n">NoMatchFound</span><span class="p">:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;It was not possible to find a comparison &#39;</span>
                                  <span class="s1">&#39;group&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Data will be extracted but not calibrated&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">spec_file</span> <span class="ow">in</span> <span class="n">object_group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing Science File: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec_file</span><span class="p">))</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">spec_file</span><span class="p">)</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">add_wcs_keys</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec_file</span><span class="p">,</span> <span class="s1">&#39;Original File Name&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comp_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">comp_ccd_list</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">for</span> <span class="n">comp_file</span> <span class="ow">in</span> <span class="n">comp_group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">comp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">comp_file</span><span class="p">)</span>
                        <span class="n">comp_ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">comp_path</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                        <span class="n">comp_ccd</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">add_wcs_keys</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">comp_ccd</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                        <span class="n">comp_ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp_file</span><span class="p">,</span>
                                                     <span class="s1">&#39;Original File Name&#39;</span><span class="p">)</span>
                        <span class="n">comp_ccd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_ccd</span><span class="p">)</span>
                        <span class="c1"># plt.imshow(comp_ccd.data)</span>
                        <span class="c1"># plt.show()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Comp Group is None or comp list already exist&#39;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">extracted</span><span class="p">,</span> <span class="n">comps</span> <span class="o">=</span> <span class="n">spectroscopic_extraction</span><span class="p">(</span>
                        <span class="n">ccd</span><span class="o">=</span><span class="n">ccd</span><span class="p">,</span>
                        <span class="n">extraction</span><span class="o">=</span><span class="n">extraction_type</span><span class="p">,</span>
                        <span class="n">comp_list</span><span class="o">=</span><span class="n">comp_ccd_list</span><span class="p">,</span>
                        <span class="n">nfind</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_n_targets</span><span class="p">,</span>
                        <span class="n">plots</span><span class="o">=</span><span class="n">SHOW_PLOTS</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Extracted Data&#39;</span><span class="p">)</span>

                        <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;GTK3Agg&#39;</span><span class="p">:</span>
                            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;Qt4Agg&#39;</span><span class="p">:</span>
                            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

                        <span class="k">for</span> <span class="n">edata</span> <span class="ow">in</span> <span class="n">extracted</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">edata</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">edata</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">comps</span> <span class="o">!=</span> <span class="p">[]:</span>
                                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                             <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">():</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                    <span class="n">object_number</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)):</span>
                        <span class="n">extracted_ccd</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                        <span class="c1"># this is for numbering the last file.</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extracted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">object_number</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">object_number</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="n">wsolution_obj</span> <span class="o">=</span> <span class="n">get_wsolution</span><span class="p">(</span><span class="n">ccd</span><span class="o">=</span><span class="n">extracted_ccd</span><span class="p">,</span>
                                                      <span class="n">comp_list</span><span class="o">=</span><span class="n">comps</span><span class="p">,</span>
                                                      <span class="n">object_number</span><span class="o">=</span><span class="n">object_number</span><span class="p">)</span>
                        <span class="c1"># return wsolution_obj</span>
                <span class="k">except</span> <span class="n">NoTargetException</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No target was identified&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="WavelengthCalibration"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration">[docs]</a><span class="k">class</span> <span class="nc">WavelengthCalibration</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wavelength Calibration Class</span>

<span class="sd">    The WavelengthCalibration class is instantiated for each of the science</span>
<span class="sd">    images, which are treated as a &quot;science object&quot;. In this first release it</span>
<span class="sd">    can find a wavelength solution for a given comparison lamp using an</span>
<span class="sd">    interactive GUI based on Matplotlib. Although it works very good, for the</span>
<span class="sd">    next release there is a plan for creating an independent GUI based on QT in</span>
<span class="sd">    order to work better in different screen sizes and other topic such as</span>
<span class="sd">    showing warnings, messages and help.</span>

<span class="sd">    This class takes 1D spectrum with no wavelength calibration and returns fits</span>
<span class="sd">    files with wavelength solutions using the FITS standard for linear</span>
<span class="sd">    solutions. Goodman spectra are slightly non-linear therefore they are</span>
<span class="sd">    linearized and smoothed before they are returned for the user.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wavelength Calibration Class Initialization</span>

<span class="sd">        A WavelengthCalibration class is instantiated for each science target</span>
<span class="sd">        being processed, i.e. every science image.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This class violates some conventions as for length and number of</span>
<span class="sd">            attributes is concerned. Solving this is part of a prioritary plans</span>
<span class="sd">            for next release.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (objects): Runtime arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO - Documentation missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span> <span class="o">=</span> <span class="n">ReferenceData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="c1"># self.science_object = science_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_size</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_search_method</span> <span class="o">=</span> <span class="s1">&#39;derivative&#39;</span>
        <span class="sd">&quot;&quot;&quot;Instrument configuration and spectral characteristics&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">micrometer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_scale</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goodman_focal_length</span> <span class="o">=</span> <span class="mf">377.3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_angle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_binning</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_binning</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_wavelength</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blue_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">red_limit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Interactive wavelength finding&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">click_input_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextual_bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4_plots</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4_com</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax4_rlv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legends</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_raw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filling_value</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.binning = self.lamp_header[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixelcenter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&quot;&quot;&quot;this data must come parsed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">source</span>
        <span class="c1"># self.science_pack = sci_pack</span>
        <span class="c1"># self.sci_filename = self.science_object.file_name</span>
        <span class="c1"># self.history_of_lamps_solutions = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccd</span><span class="p">,</span> <span class="n">comp_list</span><span class="p">,</span> <span class="n">object_number</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wsolution_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call method for the WavelengthSolution Class</span>

<span class="sd">        It takes extracted data and produces wavelength calibrated by means of</span>
<span class="sd">        an interactive mode. The call method takes care of the order and logic</span>
<span class="sd">        needed to call the different methods. A wavelength solution can be</span>
<span class="sd">        recycled for the next science object. In that case, the wavelength</span>
<span class="sd">        solution is parsed as an argument and then there is no need to calculate</span>
<span class="sd">        it again.</span>

<span class="sd">        Args:</span>
<span class="sd">            ccd (object): a CCDData instance</span>
<span class="sd">            comp_list (list):</span>
<span class="sd">            object_number:</span>
<span class="sd">            wsolution_obj (object): Mathematical model of the wavelength</span>
<span class="sd">                solution if exist. If it doesnt is a None</span>

<span class="sd">        Returns:</span>
<span class="sd">            wavelength_solution (object): The mathematical model of the</span>
<span class="sd">                wavelength solution. If it fails to create it will return a</span>
<span class="sd">                None element.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing Science Target: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">comp_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">lamp_ccd</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span> <span class="o">=</span> <span class="n">lamp_ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span> <span class="o">=</span> <span class="n">lamp_ccd</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">))</span>
                <span class="c1"># self.raw_pixel_axis = range(len(self.lamp_data))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span> <span class="o">=</span> <span class="n">lamp_ccd</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing Comparison Lamp: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">data1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)</span>
                <span class="c1"># self.lines_limits = self.get_line_limits()</span>
                <span class="c1"># self.lines_center = self.get_line_centers(self.lines_limits)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lines_in_lamp</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spectral</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_characteristics</span><span class="p">()</span>
                <span class="n">object_name</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">interactive_ws</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interactive_wavelength_solution</span><span class="p">(</span><span class="n">object_name</span><span class="o">=</span><span class="n">object_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Automatic Wavelength Solution might fail to &#39;</span>
                                <span class="s1">&#39;provide accurate solutions&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">automatic_wavelength_solution</span><span class="p">()</span>
                    <span class="c1"># self.wsolution = self.wavelength_solution()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># TODO (simon): plug in a record system</span>
                    <span class="c1"># record = &#39;{:s} {:.3f} {:.3f}&#39;.format(</span>
                    <span class="c1">#     self.lamp_header[&#39;GRATING&#39;],</span>
                    <span class="c1">#     self.lamp_header[&#39;GRT_TARG&#39;],</span>
                    <span class="c1">#     self.lamp_header[&#39;CAM_TARG&#39;])</span>
                    <span class="c1">#</span>
                    <span class="c1"># for par in self.wsolution.parameters:</span>
                    <span class="c1">#     record += &#39; {:.5f}&#39;.format(par)</span>
                    <span class="c1">#</span>
                    <span class="c1"># os.system(&quot;echo \&#39;{:s}\&#39; &gt;&gt; parametros.txt&quot;.format(record))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">linear_lamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearize_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_wavelength_solution</span><span class="p">(</span>
                        <span class="n">new_header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">,</span>
                        <span class="n">spectrum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_lamp</span><span class="p">,</span>
                        <span class="n">original_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">object_number</span><span class="p">)</span>

                    <span class="c1"># print(ccd.header)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">linearized_sci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linearize_spectrum</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_wavelength_solution</span><span class="p">(</span>
                        <span class="n">new_header</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                        <span class="n">spectrum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linearized_sci</span><span class="p">,</span>
                        <span class="n">original_filename</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">],</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">object_number</span><span class="p">)</span>


                    <span class="n">wavelength_solution</span> <span class="o">=</span> <span class="n">WavelengthSolution</span><span class="p">(</span>
                        <span class="n">solution_type</span><span class="o">=</span><span class="s1">&#39;non_linear&#39;</span><span class="p">,</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;chebyshev&#39;</span><span class="p">,</span>
                        <span class="n">model_order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">,</span>
                        <span class="n">ref_lamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span><span class="p">,</span>
                        <span class="n">eval_comment</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_comment</span><span class="p">,</span>
                        <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">plot_results</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span> <span class="ow">or</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                            <span class="c1"># plt.show()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

                        <span class="n">wavelength_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

                        <span class="n">object_name</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>
                        <span class="n">grating</span> <span class="o">=</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GRATING&#39;</span><span class="p">]</span>

                        <span class="n">fig_title</span> <span class="o">=</span> <span class="s1">&#39;Wavelength Calibrated Data : &#39;</span> \
                                    <span class="s1">&#39;</span><span class="si">{:s}</span><span class="se">\n</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="n">grating</span><span class="p">)</span>

                        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">])</span>
                        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
                        <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;GTK3Agg&#39;</span><span class="p">:</span>
                            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>
                        <span class="k">elif</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;Qt4Agg&#39;</span><span class="p">:</span>
                            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fig_title</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstrom)&#39;</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (ADU)&#39;</span><span class="p">)</span>
                        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">wavelength_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wavelength_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength_axis</span><span class="p">,</span>
                                 <span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                 <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

                        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving plots&#39;</span><span class="p">)</span>
                            <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">destiny</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">)</span>
                            <span class="n">plot_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;.png&#39;</span><span class="p">,</span>
                                               <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OFNAME&#39;</span><span class="p">])</span>
                            <span class="n">plot_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_dir</span><span class="p">,</span> <span class="n">plot_name</span><span class="p">)</span>
                            <span class="c1"># print(plot_path)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved plot as </span><span class="si">{:s}</span><span class="s1"> file &#39;</span>
                                     <span class="s1">&#39;DPI=300&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_name</span><span class="p">))</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

                    <span class="k">return</span> <span class="n">wavelength_solution</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;It was not possible to get a wavelength &#39;</span>
                              <span class="s1">&#39;solution from this lamp.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data should be saved anyways&#39;</span><span class="p">)</span>

        <span class="c1"># else:</span>
        <span class="c1">#     self.wsolution = wsolution_obj.wsolution</span>
        <span class="c1">#     self.calibration_lamp = wsolution_obj.reference_lamp</span>
        <span class="c1">#     self.evaluation_comment = wsolution_obj.evaluation_comment</span>
        <span class="c1">#     # print(&#39;wavelengthSolution &#39;, self.wsolution)</span>
        <span class="c1">#     # print(&#39;Evaluation Comment&#39;, self.evaluation_comment)</span>
        <span class="c1">#     # repeat for all sci</span>
        <span class="c1">#     for target_index in range(self.science_object.no_targets):</span>
        <span class="c1">#         log.debug(&#39;Processing target {:d}&#39;.format(target_index + 1))</span>
        <span class="c1">#         new_data = self.science_pack.data[target_index]</span>
        <span class="c1">#         new_header = self.science_pack.headers[target_index]</span>
        <span class="c1">#         if self.science_object.no_targets &gt; 1:</span>
        <span class="c1">#             new_index = target_index + 1</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             new_index = None</span>
        <span class="c1">#         self.linearized_sci = self.linearize_spectrum(new_data)</span>
        <span class="c1">#         self.header = self.add_wavelength_solution(new_header,</span>
        <span class="c1">#                                                    self.linearized_sci,</span>
        <span class="c1">#                                                    self.sci_filename,</span>
        <span class="c1">#                                                    self.evaluation_comment,</span>
        <span class="c1">#                                                    index=new_index)</span>
        <span class="c1">#     return wsolution_obj</span>

<div class="viewcode-block" id="WavelengthCalibration.get_wsolution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.get_wsolution">[docs]</a>    <span class="k">def</span> <span class="nf">get_wsolution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the mathematical model of the wavelength solution</span>

<span class="sd">        The wavelength solution is a callable mathematical function from</span>
<span class="sd">        astropy.modeling.models By obtaining this solution it can be applied to</span>
<span class="sd">        a pixel axis.</span>

<span class="sd">        Returns:</span>
<span class="sd">            wsolution (callable): A callable mathematical function</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Wavelength Solution doesn&#39;t exist!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="WavelengthCalibration.get_calibration_lamp"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.get_calibration_lamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_calibration_lamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the name of the calibration lamp used for obtain the solution</span>

<span class="sd">        The filename of the lamp used to obtain must go to the header for</span>
<span class="sd">        documentation</span>

<span class="sd">        Returns:</span>
<span class="sd">            calibration_lamp (str): Filename of calibration lamp used to obtain</span>
<span class="sd">            wavelength solution</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Wavelength solution has not been calculated yet.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthCalibration.get_lines_in_lamp"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.get_lines_in_lamp">[docs]</a>    <span class="k">def</span> <span class="nf">get_lines_in_lamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccddata_lamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify peaks in a lamp spectrum</span>

<span class="sd">        Uses scipy.signal.argrelmax to find peaks in a spectrum i.e emission</span>
<span class="sd">        lines then it calls the recenter_lines method that will recenter them</span>
<span class="sd">        using a &quot;center of mass&quot;, because, not always the maximum value (peak)</span>
<span class="sd">        is the center of the line.</span>

<span class="sd">        Returns:</span>
<span class="sd">            lines_candidates (list): A common list containing pixel values at</span>
<span class="sd">                approximate location of lines.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ccddata_lamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span>
            <span class="n">lamp_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span>
            <span class="n">raw_pixel_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ccddata_lamp</span><span class="p">,</span> <span class="n">CCDData</span><span class="p">):</span>
            <span class="c1"># print(ccddata_lamp.data.shape)</span>
            <span class="n">lamp_data</span> <span class="o">=</span> <span class="n">ccddata_lamp</span><span class="o">.</span><span class="n">data</span>
            <span class="n">lamp_header</span> <span class="o">=</span> <span class="n">ccddata_lamp</span><span class="o">.</span><span class="n">header</span>
            <span class="n">raw_pixel_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error receiving lamp&#39;</span><span class="p">)</span>

        <span class="n">no_nan_lamp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">lamp_data</span><span class="p">)</span>

        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">no_nan_lamp_data</span> <span class="o">&gt;</span> <span class="n">no_nan_lamp_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span>
                   <span class="mf">0.03</span> <span class="o">*</span> <span class="n">no_nan_lamp_data</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="n">no_nan_lamp_data</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">)</span>

        <span class="n">_upper_limit</span> <span class="o">=</span> <span class="n">no_nan_lamp_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">no_nan_lamp_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">slit_size</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z&quot; ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;slit&#39;</span><span class="p">])</span>

        <span class="n">serial_binning</span><span class="p">,</span> <span class="n">parallel_binning</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;CCDSUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

        <span class="n">new_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">slit_size</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.15</span> <span class="o">*</span> <span class="n">serial_binning</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;New Order:  </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_order</span><span class="p">))</span>

        <span class="c1"># print(round(new_order))</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">argrelmax</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">new_order</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">slit_size</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>

            <span class="n">lines_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recenter_broad_lines</span><span class="p">(</span><span class="n">lamp_data</span><span class="o">=</span><span class="n">no_nan_lamp_data</span><span class="p">,</span>
                                                     <span class="n">lines</span><span class="o">=</span><span class="n">peaks</span><span class="p">,</span>
                                                     <span class="n">slit_size</span><span class="o">=</span><span class="n">slit_size</span><span class="p">,</span>
                                                     <span class="n">order</span><span class="o">=</span><span class="n">new_order</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># lines_center = peaks</span>
            <span class="n">lines_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recenter_lines</span><span class="p">(</span><span class="n">no_nan_lamp_data</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Lines Detected&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Lines detected in Lamp</span><span class="se">\n</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Axis&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (counts)&#39;</span><span class="p">)</span>

            <span class="c1"># Build legends without data to avoid repetitions</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Comparison Lamp Data&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Spectral Line Detected&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">_upper_limit</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

            <span class="c1"># plt.axhline(median + stddev, color=&#39;g&#39;)</span>
            <span class="c1"># for rc_line in lines_center:</span>
            <span class="c1">#     plt.axvline(rc_line, color=&#39;r&#39;)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">raw_pixel_axis</span><span class="p">,</span> <span class="n">no_nan_lamp_data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">lines_center</span></div>

<div class="viewcode-block" id="WavelengthCalibration.recenter_lines"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.recenter_lines">[docs]</a>    <span class="k">def</span> <span class="nf">recenter_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds the centroid of an emission line</span>

<span class="sd">        For every line center (pixel value) it will scan left first until the</span>
<span class="sd">        data stops decreasing, it assumes it is an emission line and then will</span>
<span class="sd">        scan right until it stops decreasing too. Defined those limits it will</span>

<span class="sd">        Args:</span>
<span class="sd">            data:</span>
<span class="sd">            lines:</span>
<span class="sd">            plots:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_center</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># TODO (simon): Check if this definition is valid, so far is not</span>
            <span class="c1"># TODO (cont..): critical</span>
            <span class="n">left_limit</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">right_limit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">left_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">condition</span> <span class="ow">and</span> <span class="n">left_index</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">left_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="n">left_index</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">left_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="n">left_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>

                    <span class="n">condition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">left_limit</span> <span class="o">=</span> <span class="n">left_index</span>

                <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">left_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">median</span><span class="p">:</span>
                    <span class="n">condition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">left_limit</span> <span class="o">=</span> <span class="n">left_index</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left_limit</span> <span class="o">=</span> <span class="n">left_index</span>

                <span class="n">left_index</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="c1"># id right limit</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">right_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">condition</span> <span class="ow">and</span> <span class="n">right_index</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">x_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">right_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="n">right_index</span><span class="p">])</span> <span class="ow">and</span> \
                        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">right_index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="n">right_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>

                    <span class="n">condition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">right_limit</span> <span class="o">=</span> <span class="n">right_index</span>

                <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="n">right_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">median</span><span class="p">:</span>
                    <span class="n">condition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">right_limit</span> <span class="o">=</span> <span class="n">right_index</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">right_limit</span> <span class="o">=</span> <span class="n">right_index</span>
                <span class="n">right_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">index_diff</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="n">left_index</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="n">right_index</span><span class="p">)]</span>

            <span class="n">sub_x_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_diff</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_diff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">sub_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">line</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_diff</span><span class="p">):(</span><span class="n">line</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">index_diff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_x_axis</span> <span class="o">*</span> <span class="n">sub_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_data</span><span class="p">)</span>

            <span class="c1"># checks for asymmetries</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">left_limit</span><span class="p">]),</span>
                           <span class="nb">abs</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">right_limit</span><span class="p">])]</span>

            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">2.</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">new_center</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_center</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centroid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Lines Detected in Lamp&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span><span class="p">,</span>
                     <span class="n">data</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Lamp Data&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;First Detected Center&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">center</span> <span class="ow">in</span> <span class="n">new_center</span><span class="p">:</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">center</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;.-&#39;</span><span class="p">,</span>
                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Center&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_center</span></div>

<div class="viewcode-block" id="WavelengthCalibration.recenter_broad_lines"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.recenter_broad_lines">[docs]</a>    <span class="k">def</span> <span class="nf">recenter_broad_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lamp_data</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">slit_size</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            lamp_data:</span>
<span class="sd">            lines:</span>
<span class="sd">            slit_size:</span>
<span class="sd">            order:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_line_centers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gaussian_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">lamp_data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">lamp_data</span><span class="p">,</span> <span class="n">gaussian_kernel</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">lower_index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span> <span class="o">-</span> <span class="n">order</span><span class="p">))</span>
            <span class="n">upper_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_data</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">order</span><span class="p">))</span>
            <span class="n">lamp_sample</span> <span class="o">=</span> <span class="n">lamp_data</span><span class="p">[</span><span class="n">lower_index</span><span class="p">:</span><span class="n">upper_index</span><span class="p">]</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower_index</span><span class="p">,</span> <span class="n">upper_index</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lamp_sample</span><span class="p">))</span>
            <span class="n">line_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lamp_sample</span><span class="p">)</span>

            <span class="n">gaussian_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">line_max</span><span class="p">,</span>
                                               <span class="n">mean</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
                                               <span class="n">stddev</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

            <span class="n">fit_gaussian</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
            <span class="n">fitted_gaussian</span> <span class="o">=</span> <span class="n">fit_gaussian</span><span class="p">(</span><span class="n">gaussian_model</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">lamp_sample</span><span class="p">)</span>
            <span class="n">new_line_centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fitted_gaussian</span><span class="o">.</span><span class="n">mean</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># if self.args.debug_mode:</span>
            <span class="c1">#     plt.plot(x_axis, lamp_sample)</span>
            <span class="c1">#     plt.plot(x_axis, gaussian_model(x_axis))</span>
            <span class="c1">#     plt.plot(x_axis, fitted_gaussian(x_axis), color=&#39;k&#39;)</span>
            <span class="c1">#     plt.axvline(line)</span>
            <span class="c1">#     plt.show()</span>
        <span class="k">return</span> <span class="n">new_line_centers</span></div>

<div class="viewcode-block" id="WavelengthCalibration.get_spectral_characteristics"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.get_spectral_characteristics">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectral_characteristics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates some Goodman&#39;s specific spectroscopic values.</span>

<span class="sd">        From the Header value for Grating, Grating Angle and Camera Angle it is</span>
<span class="sd">        possible to estimate what are the limits wavelength values and central</span>
<span class="sd">        wavelength. It was necessary to add offsets though, since the formulas</span>
<span class="sd">        provided are slightly off. The values are only an estimate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            spectral_characteristics (dict): Contains the following parameters:</span>
<span class="sd">                center: Center Wavelength</span>
<span class="sd">                blue: Blue limit in Angstrom</span>
<span class="sd">                red: Red limit in Angstrom</span>
<span class="sd">                alpha: Angle</span>
<span class="sd">                beta: Angle</span>
<span class="sd">                pix1: Pixel One</span>
<span class="sd">                pix2: Pixel Two</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO (simon): find a definite solution for this, this only work (a little) for one configuration</span>
        <span class="n">blue_correction_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span>
        <span class="n">red_correction_factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">37</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[A-Za-z_-]&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;GRATING&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">mm</span>

        <span class="c1"># print(&#39;Grating Frequency &#39; + &#39;{:d}&#39;.format(int(self.grating_frequency)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;GRT_ANG&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;CAM_ANG&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">serial_binning</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel_binning</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;CCDSUM&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pixel_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)</span>
        <span class="c1"># Calculations</span>
        <span class="c1"># TODO (simon): Check whether is necessary to remove the self.slit_offset variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">camera_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">center_wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span>

        <span class="n">limit_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pixel_count</span> <span class="o">*</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pixel_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodman_focal_length</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">blue_limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">-</span> <span class="n">limit_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)))</span> <span class="o">/</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span> <span class="o">+</span> \
                          <span class="n">blue_correction_factor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">red_limit</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">+</span>
                                  <span class="n">limit_angle</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">rad</span><span class="p">)))</span> <span class="o">/</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)</span> <span class="o">+</span>\
                         <span class="n">red_correction_factor</span>

        <span class="n">pixel_one</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pixel_two</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Center Wavelength : </span><span class="si">{:.3f}</span><span class="s1"> Blue Limit : &#39;</span>
                  <span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1"> Red Limit : </span><span class="si">{:.3f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_wavelength</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">blue_limit</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">red_limit</span><span class="p">))</span>
        
        <span class="n">spectral_characteristics</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_wavelength</span><span class="p">,</span>
                                    <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">blue_limit</span><span class="p">,</span>
                                    <span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">red_limit</span><span class="p">,</span>
                                    <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                    <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                                    <span class="s1">&#39;pix1&#39;</span><span class="p">:</span> <span class="n">pixel_one</span><span class="p">,</span>
                                    <span class="s1">&#39;pix2&#39;</span><span class="p">:</span> <span class="n">pixel_two</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">spectral_characteristics</span></div>

<div class="viewcode-block" id="WavelengthCalibration.interpolate"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates an interpolated version of the input spectrum</span>

<span class="sd">        This method creates an interpolated version of the input array, it is</span>
<span class="sd">        used mainly for a spectrum but it can also be used with any</span>
<span class="sd">        unidimensional array, assuming you are happy with the interpolation_size</span>
<span class="sd">        attribute defined for this class. The reason for doing interpolation is</span>
<span class="sd">        that it allows to find the lines and its respective center more</span>
<span class="sd">        precisely. The default interpolation size is 200 (two hundred) points.</span>

<span class="sd">        Args:</span>
<span class="sd">            spectrum (array): an uncalibrated spectrum or any unidimensional</span>
<span class="sd">                array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two dimensional array containing x-axis and interpolated array.</span>
<span class="sd">                The x-axis preserves original pixel values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">first_x</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_x</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">new_x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">first_x</span><span class="p">,</span>
                                 <span class="n">last_x</span><span class="p">,</span>
                                 <span class="n">spectrum</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation_size</span><span class="p">)</span>

        <span class="n">tck</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_spectrum</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span> <span class="n">tck</span><span class="p">,</span> <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">new_x_axis</span><span class="p">,</span> <span class="n">new_spectrum</span><span class="p">]</span></div>

<div class="viewcode-block" id="WavelengthCalibration.recenter_line_by_data"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.recenter_line_by_data">[docs]</a>    <span class="k">def</span> <span class="nf">recenter_line_by_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">x_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds a better center for a click-selected line</span>

<span class="sd">        This method is called by another method that handles click events. An</span>
<span class="sd">        argument is parsed that will tell which plot was the clicked and what is</span>
<span class="sd">        the x-value in data coordinates. Then the closest pixel center will be</span>
<span class="sd">        found and from there will extract a 20 pixel wide sample of the data</span>
<span class="sd">        (this could be a future improvement the width of the extraction should</span>
<span class="sd">        depend on the FWHM of the lines). The sample of the data is used to</span>
<span class="sd">        calculate a centroid (center of mass) which is a good approximation but</span>
<span class="sd">        could be influenced by data shape or if the click was too far</span>
<span class="sd">        (unquantified yet). That is why for the reference data, a database of</span>
<span class="sd">        laboratory line center will be</span>
<span class="sd">        used and for raw data the line centers are calculated earlier in the</span>
<span class="sd">        process, independently of any human input.</span>

<span class="sd">        It also will plot the sample, the centroid and the reference line center</span>
<span class="sd">        at the fourth subplot, bottom right corner.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_name (str): &#39;reference&#39; or &#39;raw-data&#39; is where the click was</span>
<span class="sd">            done</span>
<span class="sd">            x_data (float): click x-axis value in data coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            reference_line_value (float): The value the line center that will</span>
<span class="sd">            be used later to do the wavelength fit</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data_name</span> <span class="o">==</span> <span class="s1">&#39;reference&#39;</span><span class="p">:</span>
            <span class="n">pseudo_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_data</span><span class="p">))</span>

            <span class="n">reference_line_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)</span> <span class="o">-</span> <span class="n">x_data</span><span class="p">))</span>

            <span class="n">reference_line_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)[</span><span class="n">reference_line_index</span><span class="p">]</span>

            <span class="n">sub_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>
                    <span class="n">pseudo_center</span> <span class="o">-</span> <span class="mi">10</span><span class="p">:</span> <span class="n">pseudo_center</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>

            <span class="n">sub_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span>
                    <span class="n">pseudo_center</span> <span class="o">-</span> <span class="mi">10</span><span class="p">:</span> <span class="n">pseudo_center</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>

            <span class="n">center_of_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_x</span> <span class="o">*</span> <span class="n">sub_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_y</span><span class="p">)</span>
            <span class="c1"># print &#39;centroid &#39;, center_of_mass</span>
            <span class="c1"># plt.figure(3)</span>
            <span class="c1"># if self.ax4_plots is not None or self.ax4_com is not None or</span>
            <span class="c1"># self.ax4_rlv is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reference Data Clicked Line&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstrom)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (Counts)&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub_x</span><span class="p">,</span>
                                           <span class="n">sub_y</span><span class="p">,</span>
                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_rlv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">reference_line_value</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Line Value&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Centroid&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="c1"># return center_of_mass</span>
            <span class="k">return</span> <span class="n">reference_line_value</span>
        <span class="k">elif</span> <span class="n">data_name</span> <span class="o">==</span> <span class="s1">&#39;raw-data&#39;</span><span class="p">:</span>
            <span class="n">pseudo_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span> <span class="o">-</span> <span class="n">x_data</span><span class="p">))</span>
            <span class="n">raw_line_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span> <span class="o">-</span> <span class="n">x_data</span><span class="p">))</span>
            <span class="n">raw_line_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">[</span><span class="n">raw_line_index</span><span class="p">]</span>
            <span class="c1"># print(raw_line_value)</span>
            <span class="n">sub_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span><span class="p">[</span><span class="n">pseudo_center</span> <span class="o">-</span> <span class="mi">10</span><span class="p">:</span> <span class="n">pseudo_center</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>
            <span class="n">sub_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">[</span><span class="n">pseudo_center</span> <span class="o">-</span> <span class="mi">10</span><span class="p">:</span> <span class="n">pseudo_center</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span>
            <span class="n">center_of_mass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_x</span> <span class="o">*</span> <span class="n">sub_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub_y</span><span class="p">)</span>
            <span class="c1"># print &#39;centroid &#39;, center_of_mass</span>
            <span class="c1"># plt.figure(3)</span>
            <span class="c1"># if self.ax4_plots is not None or self.ax4_com is not None or</span>
            <span class="c1"># self.ax4_rlv is not None:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Raw Data Clicked Line&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Axis&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (Counts)&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub_x</span><span class="p">,</span>
                                           <span class="n">sub_y</span><span class="p">,</span>
                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_rlv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">raw_line_value</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Line Center&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4_com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">center_of_mass</span><span class="p">,</span>
                                            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                                            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Centroid&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="c1"># return center_of_mass</span>
            <span class="k">return</span> <span class="n">raw_line_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unrecognized data name&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthCalibration.predicted_wavelength"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.predicted_wavelength">[docs]</a>    <span class="k">def</span> <span class="nf">predicted_wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixel</span><span class="p">):</span>
        <span class="c1"># TODO (simon): Update with bruno&#39;s new calculations</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>
        <span class="c1"># pixel_count = self.pixel_count</span>
        <span class="n">binning</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_binning</span>

        <span class="n">grating_frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating_frequency</span>

        <span class="n">wavelength</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="n">e6</span> <span class="o">/</span> <span class="n">grating_frequency</span><span class="p">)</span> <span class="o">*</span> \
                     <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">((</span><span class="n">pixel</span> <span class="o">*</span> <span class="n">binning</span> <span class="o">-</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">*</span>
                                       <span class="mf">0.015</span> <span class="o">/</span> <span class="mf">377.2</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">wavelength</span></div>

<div class="viewcode-block" id="WavelengthCalibration.automatic_wavelength_solution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.automatic_wavelength_solution">[docs]</a>    <span class="k">def</span> <span class="nf">automatic_wavelength_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds a Wavelength Solution Automatically</span>

<span class="sd">        The pipeline includes a set of comparison lamps already wavelength</span>
<span class="sd">        calibrated that will be used as templates for cross-matching incoming</span>
<span class="sd">        comparison lamps taken in the same conditions (i.e. same elements,</span>
<span class="sd">        grating, mode and ideally slit).</span>

<span class="sd">        It will first find the suitable comparison lamp and if it succeeds it</span>
<span class="sd">        will load its wavelength solution creating a wavelength axis. Then it</span>
<span class="sd">        will identify the lines in the lamp we want to calibrate, there is no</span>
<span class="sd">        need to load this lamp since is an attribute of the class and has been</span>
<span class="sd">        already extracted. For each identified line will cut sub-samples of the</span>
<span class="sd">        template reference lamp and the new lamp and then will do a cross</span>
<span class="sd">        correlation to find the shift in pixels. The line&#39;s pixel value will be</span>
<span class="sd">        stored as well as the wavelength value of pixel_value +</span>
<span class="sd">        cross_correlation_value using the mathematical model of the template</span>
<span class="sd">        comparison lamp. The cross correlation value will also be stored and</span>
<span class="sd">        will be used as a first order filter by doing a sigma clip discarding</span>
<span class="sd">        large mismatch but this is not enough since there are some cases where</span>
<span class="sd">        the cross correlation collection does not have a clear distribution and</span>
<span class="sd">        sigma clip does not work so after this first order filtering it will</span>
<span class="sd">        create a wavelength solution. Using the new wavelength solution a new</span>
<span class="sd">        list of the difference in Angstrom will be created as the difference of</span>
<span class="sd">        the reference Angstrom value minus the Angstrom value corresponding to</span>
<span class="sd">        the line center using the mathematical model of the first solution.</span>
<span class="sd">        This will be sigma clipped once more and the values left out removed</span>
<span class="sd">        and finally a new solution will be calculated.</span>


<span class="sd">        Returns:</span>
<span class="sd">            None: In case it is not possible to find a suitable template lamp.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># reference_lamp_file = self.reference_data.get_best_reference_lamp(</span>
            <span class="c1">#     header=self.lamp_header)</span>
            <span class="n">reference_lamp_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_exact_lamp</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">)</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found reference lamp: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference_lamp_file</span><span class="p">))</span>

            <span class="n">reference_lamp_data</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reference_lamp_file</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;This configuration is not supported in &#39;</span>
                        <span class="s1">&#39;automatic mode.&#39;</span><span class="p">)</span>

            <span class="c1"># TODO (simon): Evaluate if send this to interactive mode</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">read_wsolution</span> <span class="o">=</span> <span class="n">ReadWavelengthSolution</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">reference_lamp_wav_axis</span><span class="p">,</span> <span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">read_wsolution</span><span class="p">()</span>
        <span class="n">reference_lamp_copy</span> <span class="o">=</span> <span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># if float(re.sub(&#39;[A-Za-z&quot; ]&#39;, &#39;&#39;,self.lamp_header[&#39;SLIT&#39;])) &gt; 3:</span>
        <span class="c1"># plt.plot(self.lamp_data, color=&#39;b&#39;)</span>
        <span class="c1"># plt.plot(reference_lamp_copy.data, color=&#39;k&#39;)</span>
        <span class="c1"># # plt.plot(test, color=&#39;r&#39;)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">box_kernel</span> <span class="o">=</span> <span class="n">Box1DKernel</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">33</span><span class="p">)</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference_lamp_copy</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">box_kernel</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaussian_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">3.</span><span class="p">)</span>

            <span class="n">reference_lamp_copy</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference_lamp_copy</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                <span class="n">gaussian_kernel</span><span class="p">)</span>

            <span class="c1"># ref_lamp_lines_pixel_full = self.get_lines_in_lamp(</span>
            <span class="c1">#     ccddata_lamp=reference_lamp_copy)</span>


        <span class="c1"># Initialize wavelength builder class</span>
        <span class="n">wavelength_solution</span> <span class="o">=</span> <span class="n">WavelengthFitter</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;chebyshev&#39;</span><span class="p">,</span>
                                               <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span><span class="p">)</span>
        <span class="c1"># self.wsolution = wavelength_solution.ws_fit(pixel, auto_angs)</span>

        <span class="sd">&#39;&#39;&#39;detect lines in comparison lamp (not reference)&#39;&#39;&#39;</span>
        <span class="n">lamp_lines_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lines_in_lamp</span><span class="p">()</span>
        <span class="n">lamp_lines_angst</span> <span class="o">=</span> <span class="n">read_wsolution</span><span class="o">.</span><span class="n">math_model</span><span class="p">(</span><span class="n">lamp_lines_pixel</span><span class="p">)</span>

        <span class="n">pixel_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angstrom_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">correlation_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">angstrom_differences</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Length </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;NLines </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_lines_pixel</span><span class="p">)))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Length / NLines </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_lines_pixel</span><span class="p">))))</span>

        <span class="n">half_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)</span> <span class="o">/</span>
                          <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_lines_pixel</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_lines_pixel</span><span class="p">)):</span>
            <span class="n">line_value_pixel</span> <span class="o">=</span> <span class="n">lamp_lines_pixel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">line_value_angst</span> <span class="o">=</span> <span class="n">lamp_lines_angst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># half_width = 100</span>

            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">line_value_pixel</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">)))</span>

            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">line_value_pixel</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">),</span>
                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">xmin</span> <span class="o">&gt;=</span> <span class="n">xmax</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># print(xmin, xmax, self.lamp_data.size)</span>
            <span class="c1"># TODO (simon): Convolve to match wider lines such as those from</span>
            <span class="c1"># TODO (cont): the slit of 5 arseconds</span>
            <span class="n">ref_sample</span> <span class="o">=</span> <span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
            <span class="n">ref_wavele</span> <span class="o">=</span> <span class="n">reference_lamp_wav_axis</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>
            <span class="n">lamp_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span>

            <span class="n">correlation_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_correlation</span><span class="p">(</span><span class="n">ref_sample</span><span class="p">,</span> <span class="n">lamp_sample</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cross correlation value &#39;</span>
                      <span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">correlation_value</span><span class="p">)))</span>

            <span class="sd">&quot;&quot;&quot;record value for reference wavelength&quot;&quot;&quot;</span>
            <span class="n">angstrom_value_model</span> <span class="o">=</span> <span class="n">read_wsolution</span><span class="o">.</span><span class="n">math_model</span><span class="p">(</span>
                <span class="n">line_value_pixel</span> <span class="o">+</span> <span class="n">correlation_value</span><span class="p">)</span>

            <span class="c1"># log.debug(&#39;Model - Original - Pixel&#39;,</span>
            <span class="c1">#           angstrom_value_model,</span>
            <span class="c1">#           line_value_angst,</span>
            <span class="c1">#           line_value_pixel)</span>

            <span class="n">correlation_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">correlation_value</span><span class="p">)</span>
            <span class="n">angstrom_differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angstrom_value_model</span> <span class="o">-</span> <span class="n">line_value_angst</span><span class="p">)</span>
            <span class="n">angstrom_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angstrom_value_model</span><span class="p">)</span>
            <span class="n">pixel_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_value_pixel</span><span class="p">)</span>

            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Samples after cross correlation&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Axis&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ref_sample</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Sample&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span> <span class="o">+</span> <span class="n">correlation_value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                          <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lamp_sample</span><span class="p">))],</span>
                         <span class="n">lamp_sample</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Lamp Sample&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>

        <span class="c1"># This is good and necessary as a first approach for some very wrong</span>
        <span class="c1"># correlation results</span>
        <span class="n">clipped_values</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">correlation_values</span><span class="p">,</span>
                                    <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                    <span class="n">iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">cenfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">clipped_values</span><span class="p">):</span>
            <span class="n">_pixel_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">)</span>
            <span class="n">_angstrom_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">angstrom_values</span><span class="p">)</span>
            <span class="n">pixel_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">angstrom_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_values</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">clipped_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                    <span class="n">pixel_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pixel_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">angstrom_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_angstrom_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Create a wavelength solution</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating Wavelength Solution&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="n">wavelength_solution</span><span class="o">.</span><span class="n">ws_fit</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">,</span>
                                                    <span class="n">angstrom_values</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to find wavelength solution using reference &#39;</span>
                      <span class="s1">&#39;file: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1">#  finding differences in order to improve the wavelength solution</span>
        <span class="n">wavelength_differences</span> <span class="o">=</span> <span class="p">[</span><span class="n">angstrom_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">))]</span>

        <span class="n">clipped_differences</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">wavelength_differences</span><span class="p">,</span>
                                         <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                         <span class="n">iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">cenfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">):</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Cleaning pixel to angstrom match to improve wavelength &#39;</span>
                      <span class="s1">&#39;solution&#39;</span><span class="p">)</span>

            <span class="n">_pixel_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">)</span>
            <span class="n">_angstrom_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">angstrom_values</span><span class="p">)</span>
            <span class="n">pixel_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">angstrom_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">clipped_differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                    <span class="n">pixel_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pixel_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">angstrom_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_angstrom_values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Re-fitting wavelength solution&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="n">wavelength_solution</span><span class="o">.</span><span class="n">ws_fit</span><span class="p">(</span><span class="n">pixel_values</span><span class="p">,</span>
                                                        <span class="n">angstrom_values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">plot_results</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s1">&#39;Qt4Agg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span>
                    <span class="s1">&#39;Automatic Wavelength Solution&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                <span class="c1"># plt.show()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;GTK3Agg&#39;</span><span class="p">:</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;Qt4Agg&#39;</span><span class="p">:</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Angstrom&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pixel_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">angstrom_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="c1"># print(&#39;Blue &#39; +</span>
            <span class="c1">#       str(self.spectral[&#39;blue&#39;].value) +</span>
            <span class="c1">#       &#39; Red &#39; +</span>
            <span class="c1">#       str(self.spectral[&#39;red&#39;].value))</span>

            <span class="c1"># self.ax1.axvline(self.spectral[&#39;blue&#39;].value, color=&#39;b&#39;)</span>
            <span class="c1"># self.ax1.axvline(self.spectral[&#39;red&#39;].value, color=&#39;r&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">reference_lamp_wav_axis</span><span class="p">,</span>
                          <span class="n">reference_lamp_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span><span class="p">),</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Last Solution&#39;</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

            <span class="c1"># self.ax1.plot(lamp_axis_pixel,</span>
            <span class="c1">#               self.lamp_data,</span>
            <span class="c1">#               label=&#39;Last Solution&#39;,</span>
            <span class="c1">#               color=&#39;r&#39;,</span>
            <span class="c1">#               alpha=0.7)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">wavmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="n">wavmode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># print(self.rms_error, wavmode, self.lamp_header[&#39;OBJECT&#39;], &#39;\n&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstrom)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (ADU)&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Automatic Wavelength Solution</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>
                               <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">wavmode</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="o">+</span> <span class="s1">&#39;RMS Error: </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="n">out_file_name</span> <span class="o">=</span> <span class="s1">&#39;automatic-solution_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">]</span>

            <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">destiny</span><span class="p">,</span>
                                                    <span class="n">out_file_name</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)))</span>

            <span class="n">out_file_name</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">{:04d}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_count</span><span class="p">)</span>
            <span class="n">pdf_pages</span> <span class="o">=</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">destiny</span><span class="p">,</span> <span class="n">out_file_name</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pdf_pages</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
            <span class="n">pdf_pages</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">save_plots</span><span class="p">:</span>
                <span class="n">plots_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">destiny</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plots_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">plots_path</span><span class="p">)</span>
                <span class="n">plot_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plots_path</span><span class="p">,</span> <span class="n">out_file_name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
                <span class="c1"># plt.close(self.i_fig)</span>

<div class="viewcode-block" id="WavelengthCalibration.cross_correlation"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.cross_correlation">[docs]</a>    <span class="k">def</span> <span class="nf">cross_correlation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">new_array</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do cross correlation to two arrays</span>

<span class="sd">        Args:</span>
<span class="sd">            reference (Numpy.Array): Reference array.</span>
<span class="sd">            new_array (Numpy.Array): Array to be matched.</span>
<span class="sd">            mode (str): Correlation mode for `scipy.signal.correlate`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            correlation_value (int): Shift value in pixels.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(reference, new_array)</span>
        <span class="n">cyaxis2</span> <span class="o">=</span> <span class="n">new_array</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[A-Za-z&quot; ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>

            <span class="n">box_width</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[A-Za-z&quot; ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="mf">0.15</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;BOX WIDTH: </span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">box_width</span><span class="p">))</span>
            <span class="n">box_kernel</span> <span class="o">=</span> <span class="n">Box1DKernel</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">box_width</span><span class="p">)</span>
            <span class="n">max_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
            <span class="n">cyaxis1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">box_kernel</span><span class="p">)</span>
            <span class="n">max_after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cyaxis1</span><span class="p">)</span>
            <span class="n">cyaxis1</span> <span class="o">*=</span> <span class="n">max_before</span> <span class="o">/</span> <span class="n">max_after</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaussian_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">cyaxis1</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">gaussian_kernel</span><span class="p">)</span>
            <span class="n">cyaxis2</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">new_array</span><span class="p">,</span> <span class="n">gaussian_kernel</span><span class="p">)</span>
        <span class="c1"># plt.plot(cyaxis1, color=&#39;k&#39;, label=&#39;Reference&#39;)</span>
        <span class="c1"># plt.plot(cyaxis2, color=&#39;r&#39;, label=&#39;New Array&#39;)</span>
        <span class="c1"># plt.plot(reference, color=&#39;g&#39;)</span>
        <span class="c1"># plt.show()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ccorr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">cyaxis1</span><span class="p">,</span> <span class="n">cyaxis2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cyaxis1</span><span class="p">,</span> <span class="n">cyaxis2</span><span class="p">)</span>
        <span class="c1"># print(&#39;Corr &#39;, ccorr)</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ccorr</span><span class="p">)</span>

        <span class="n">x_ccorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccorr</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
                              <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccorr</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">ccorr</span><span class="p">))</span>

        <span class="n">correlation_value</span> <span class="o">=</span> <span class="n">x_ccorr</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cross Correlation&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Lag Value&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation Value&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_ccorr</span><span class="p">,</span> <span class="n">ccorr</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">correlation_value</span></div>

<div class="viewcode-block" id="WavelengthCalibration.interactive_wavelength_solution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.interactive_wavelength_solution">[docs]</a>    <span class="k">def</span> <span class="nf">interactive_wavelength_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the wavelength solution interactively</span>

<span class="sd">        Using matplotlib graphical interface we developed an interactive method</span>
<span class="sd">        to find the wavelength solution. It is capable of tracing the slight</span>
<span class="sd">        deviation from linearity of the data. It uses a combination of</span>
<span class="sd">        previously wavelength calibrated comparison lamp and laboratory line</span>
<span class="sd">        centers. Those two are combined in a single plot, bottom left, to help</span>
<span class="sd">        to visually identify their counterparts in the raw data and viceversa.</span>
<span class="sd">        In the other hand, raw data is previously processed to find the lines</span>
<span class="sd">        present. They are stored as a list and used as the correct center of</span>
<span class="sd">        the line. Once you select a line, the centroid will be calculated and</span>
<span class="sd">        the closest line will be returned.</span>

<span class="sd">        This method generates a GUI like plot using matplolib, capable of</span>
<span class="sd">        handling keyboard and click events. The window consist of four plots:</span>

<span class="sd">        In the top left side will be a wide plot named raw data. This is the</span>
<span class="sd">        uncalibrated comparison lamp associated to the science image that is</span>
<span class="sd">        being processed.</span>

<span class="sd">        Then in the bottom left, there is the reference plot, where a previously</span>
<span class="sd">        calibrated lamp is displayed along with the reference line values.</span>

<span class="sd">        In the top right side there is a permanent help text with the basic</span>
<span class="sd">        functions plus a short description.</span>

<span class="sd">        And finally in the bottom right side you will find a more dynamic plot.</span>
<span class="sd">        It will show a zoomed line when you mark one with a click, a scatter</span>
<span class="sd">        plot when you do a fit to the recorded marks and also will show warnings</span>
<span class="sd">        in case something is going wrong.</span>

<span class="sd">        For future release there is the plan to put all this method as a new</span>
<span class="sd">        class even with an indepentend QT GUI.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method uses the Qt4Agg backend, it will not work with other.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">switch_backend</span><span class="p">(</span><span class="s1">&#39;Qt4Agg&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">reference_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_best_reference_lamp</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_header</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="n">reference_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Could not find a comparison lamp in the reference.&#39;</span><span class="p">)</span>

        <span class="c1"># reference_file = self.reference_data.get_reference_lamps_by_name(</span>
        <span class="c1">#     self.lamp_name)</span>

        <span class="k">if</span> <span class="n">reference_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using reference file: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reference_file</span><span class="p">))</span>
            <span class="n">reference_plots_enabled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ref_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">reference_file</span><span class="p">)</span>
            <span class="n">ref_header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">reference_file</span><span class="p">)</span>
            <span class="n">fits_ws_reader</span> <span class="o">=</span> <span class="n">ReadWavelengthSolution</span><span class="p">(</span><span class="n">ref_header</span><span class="p">,</span> <span class="n">ref_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span> <span class="o">=</span> <span class="n">fits_ws_reader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference_plots_enabled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Please Check the OBJECT Keyword of your reference data&#39;</span><span class="p">)</span>

        <span class="c1"># ------- Plots -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="p">,</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="p">))</span> <span class="o">=</span> \
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
                         <span class="mi">2</span><span class="p">,</span>
                         <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Science Target: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">object_name</span><span class="p">))</span>

        <span class="n">manager</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_current_fig_manager</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;GTK3Agg&#39;</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">maximize</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">u&#39;Qt4Agg&#39;</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">showMaximized</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Raw Data - </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (counts)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Detected Lines&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">idline</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Raw Data&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Update y limits to have an extra 5% to top and bottom</span>
        <span class="n">ax1_ylim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax1_y_range</span> <span class="o">=</span> <span class="n">ax1_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax1_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ax1_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">ax1_y_range</span><span class="p">,</span>
                           <span class="n">ax1_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">ax1_y_range</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Reference Data - </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstrom)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (counts)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">blue_limit</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">red_limit</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">FormatStrFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.1e</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span>
                      <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span>
                      <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                      <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Line Values&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">rline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rline</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reference_plots_enabled</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">reference_solution</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference Lamp Data&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Update y limits to have an extra 5% to top and bottom</span>
        <span class="n">ax3_ylim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax3_y_range</span> <span class="o">=</span> <span class="n">ax3_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax3_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ax3_ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">ax3_y_range</span><span class="p">,</span>
                           <span class="n">ax3_ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">ax3_y_range</span><span class="p">))</span>
        <span class="c1"># print(ax3_ylim)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">display_help_text</span><span class="p">()</span>

        <span class="c1"># zoomed plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span><span class="s1">&#39;Use middle button click to select a &#39;</span>
                                      <span class="s1">&#39;line&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                            <span class="n">right</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
                            <span class="n">top</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span>
                            <span class="n">bottom</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span>
                            <span class="n">wspace</span><span class="o">=</span><span class="mf">0.11</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contextual_bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>

        <span class="c1"># if self.click_input_enabled:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_click</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_pressed</span><span class="p">)</span>
        <span class="c1"># print self.wsolution</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WavelengthCalibration.on_click"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.on_click">[docs]</a>    <span class="k">def</span> <span class="nf">on_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handles Click events for Interactive Mode</span>

<span class="sd">        Calls the method register_mark</span>

<span class="sd">        Args:</span>
<span class="sd">            event (object): Click event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_mark</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>
        <span class="c1"># else:</span>
        <span class="c1">#     print(event.button)</span>
        <span class="c1"># elif event.button == 3:</span>
        <span class="c1">#     if len(self.reference_marks_x) == len(self.raw_data_marks_x):</span>
        <span class="c1">#         self.click_input_enabled = False</span>
        <span class="c1">#         log.info(&#39;Leaving interactive mode&#39;)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         if len(self.reference_marks_x) &lt; len(self.raw_data_marks_x):</span>
        <span class="c1">#             log.info(&#39;There is {:d} click missing in the &#39;</span>
        <span class="c1">#                      &#39;Reference plot&#39;.format(</span>
        <span class="c1">#                 len(self.raw_data_marks_x) -</span>
        <span class="c1">#                 len(self.reference_marks_x)))</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             log.info(&#39;There is {:d} click missing in the &#39;</span>
        <span class="c1">#                      &#39;New Data plot&#39;.format(</span>
        <span class="c1">#                 len(self.reference_marks_x) -</span>
        <span class="c1">#                 len(self.raw_data_marks_x)))</span>

<div class="viewcode-block" id="WavelengthCalibration.key_pressed"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.key_pressed">[docs]</a>    <span class="k">def</span> <span class="nf">key_pressed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Key event handler</span>

<span class="sd">        There are several key events that need to be taken care of.</span>
<span class="sd">        See a brief description of each one of them below:</span>

<span class="sd">        F1 or ?: Prints a help message</span>
<span class="sd">        F2 or f: Fit wavelength solution model.</span>
<span class="sd">        F3 or a: Find new lines.</span>
<span class="sd">        F4: Evaluate solution</span>
<span class="sd">        F6 or l: Linearize data although this is done automatically after the</span>
<span class="sd">        wavelength function is fit</span>
<span class="sd">        d: deletes closest point</span>
<span class="sd">        ctrl+d: deletes all recorded marks</span>
<span class="sd">        ctrl+z: Reverts the action of F3 or a.</span>
<span class="sd">        Middle Button Click or m: records data location.</span>
<span class="sd">        Enter: Close figure and apply solution if exists.</span>
<span class="sd">        Shift+Enter: Close the program with sys.exit(0)</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method must be simplified</span>

<span class="sd">        Args:</span>
<span class="sd">            event (object): Key pressed event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f1&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Print help regarding interactive mode&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F1 or ?: Prints Help.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F2 or f: Fit wavelength solution model.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F3 or a: Find new lines.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F4: Evaluate solution&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;F6 or l: Linearize data (for testing not definitive)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;d: deletes closest point&quot;</span><span class="p">)</span>
            <span class="c1"># print(&quot;l : resample spectrum to a linear dispersion axis&quot;)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ctrl+d: deletes all recorded marks&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ctrl+z: Go back to previous solution &quot;</span>
                  <span class="s2">&quot;(deletes automatic added points&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Middle Button Click: records data location.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter: Close figure and apply solution if exists.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f2&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Calling function to fit wavelength Solution&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_pixel_to_wavelength</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_raw_over_reference</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f3&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">find_more_lines</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f4&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="c1"># TODO (simon): simplify this code.</span>

            <span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_bb</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting raw point&#39;</span><span class="p">)</span>
                <span class="c1"># print abs(self.raw_data_marks_x - event.xdata) a[:] =</span>

                <span class="n">closer_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">list_val</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span> <span class="k">for</span> <span class="n">list_val</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">]))</span>

                <span class="c1"># print &#39;Index &#39;, closer_index</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">closer_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_bb</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting reference point&#39;</span><span class="p">)</span>
                <span class="c1"># print &#39;reference &#39;, self.reference_marks_x, self.re</span>
                <span class="c1"># print self.reference_marks_x</span>
                <span class="c1"># print abs(self.reference_marks_x - event.xdata)</span>

                <span class="n">closer_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">list_val</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span> <span class="k">for</span> <span class="n">list_val</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">]))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">closer_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closer_index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">contextual_bb</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Can&#39;t delete points from here because points &quot;</span>
                            <span class="s2">&quot;represent each detected line in the raw data.&quot;</span><span class="p">)</span>
                <span class="c1"># closer_index_ref = int(np.argmin(</span>
                <span class="c1">#     [abs(list_val - event.ydata) for list_val in</span>
                <span class="c1">#      self.reference_marks_x]))</span>
                <span class="c1">#</span>
                <span class="c1"># closer_index_raw = int(np.argmin(</span>
                <span class="c1">#     [abs(list_val - event.xdata) for list_val in</span>
                <span class="c1">#      self.raw_data_marks_x]))</span>
                <span class="c1">#</span>
                <span class="c1"># log.debug(&#39;Raw Index {:d}, Ref Index {:d}&#39;.format(</span>
                <span class="c1">#     closer_index_raw,</span>
                <span class="c1">#     closer_index_ref))</span>
                <span class="c1"># self.raw_data_marks_x.pop(closer_index_raw)</span>
                <span class="c1"># self.raw_data_marks_y.pop(closer_index_raw)</span>
                <span class="c1"># self.reference_marks_x.pop(closer_index_raw)</span>
                <span class="c1"># self.reference_marks_y.pop(closer_index_raw)</span>
                <span class="c1"># self.update_marks_plot(&#39;reference&#39;)</span>
                <span class="c1"># self.update_marks_plot(&#39;raw_data&#39;)</span>
                <span class="c1"># self.update_marks_plot(&#39;eval_plots&#39;)</span>
        <span class="c1"># elif event.key == &#39;i&#39;:</span>
        <span class="c1">#     figure_x, figure_y = self.i_fig.transFigure.inverted().transform(</span>
        <span class="c1">#         (event.x, event.y))</span>
        <span class="c1">#     if self.contextual_bb.contains(figure_x, figure_y):</span>
        <span class="c1">#         log.debug(&quot;Trying to identify point.&quot;)</span>
        <span class="c1">#</span>
        <span class="c1">#         closer_x_index = int(np.argmin(</span>
        <span class="c1">#             [abs(list_val - event.xdata) for list_val in</span>
        <span class="c1">#              self.raw_data_marks_x]))</span>
        <span class="c1">#         print(self.raw_data_marks_x[closer_x_index])</span>
        <span class="c1">#         print(self.reference_marks_x[closer_x_index])</span>


        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;f6&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Linearize and smoothing spectrum&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linearize_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ctrl+z&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting automatic added points. If exist.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]</span> <span class="ow">and</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">[]:</span>

                <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)):</span>
                    <span class="c1"># print self.raw_data_marks[i], self.filling_value</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">filling_value</span><span class="p">:</span>
                        <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="c1"># print to_remove</span>
                <span class="n">to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">to_remove</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
                    <span class="c1"># else:</span>
                    <span class="c1"># print self.raw_click_plot, self.ref_click_plot, &#39;mmm&#39;</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ctrl+d&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting all recording Clicks&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s1">&#39;All points deleted&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_raw_over_reference</span><span class="p">(</span><span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All points deleted!&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No points deleted&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;enter&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Closing figure&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;There is still no wavelength solution!&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_mark</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;ctrl+q&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pressed Ctrl+q. Closing the program&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No action for key pressed: </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="WavelengthCalibration.register_mark"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.register_mark">[docs]</a>    <span class="k">def</span> <span class="nf">register_mark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Marks a line</span>

<span class="sd">        Detects where the click was done or m-key was pressed and calls the</span>
<span class="sd">        corresponding method. It handles the middle button click and m-key being</span>
<span class="sd">        pressed. There are two regions of interest as for where a click was</span>
<span class="sd">        done. The raw and reference data respectively. For any of such regions</span>
<span class="sd">        it will call the method that recenter the line and once the desired</span>
<span class="sd">        value is returned it will be appended to the list that contains all the</span>
<span class="sd">        correspondent line positions, raw (pixels) and reference (angstrom)</span>

<span class="sd">        Args:</span>
<span class="sd">            event (object): Click or m-key pressed event</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">transFigure</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">((</span><span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_bb</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span><span class="p">):</span>
                <span class="c1"># self.reference_marks.append([event.xdata, event.ydata])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recenter_line_by_data</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_bb</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span> <span class="n">figure_y</span><span class="p">):</span>
                <span class="c1"># self.raw_data_marks.append([event.xdata, event.ydata])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recenter_line_by_data</span><span class="p">(</span><span class="s1">&#39;raw-data&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_marks_plot</span><span class="p">(</span><span class="s1">&#39;raw_data&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1"> </span><span class="si">{:f}</span><span class="s1"> Are not contained&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">figure_x</span><span class="p">,</span>
                                                               <span class="n">figure_y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Clicked Region is out of boundaries&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthCalibration.find_more_lines"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.find_more_lines">[docs]</a>    <span class="k">def</span> <span class="nf">find_more_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to add more lines given that a wavelength solution already</span>
<span class="sd">        exists</span>

<span class="sd">        This method is part of the interactive wavelength solution mechanism.</span>
<span class="sd">        If a wavelength solution exist it uses the line centers in pixels to</span>
<span class="sd">        estimate their respective wavelength and then search for the closest</span>
<span class="sd">        value in the list of reference lines for the elements in the comparison</span>
<span class="sd">        lamp. Then it filters the worst of them by doing sigma clipping.</span>
<span class="sd">        Finally it adds them to the class&#39; attributes that contains the list of</span>
<span class="sd">        reference points.</span>

<span class="sd">        Better results are obtained if the solution is already decent. Visual</span>
<span class="sd">        inspection also improves final result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_physical</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_wavelength</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">square_differences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wlines</span><span class="p">)):</span>
                <span class="c1"># [abs(list_val - wlines[i]) for list_val in \</span>
                <span class="c1"># self.reference_data.get_line_list_by_name(self.lamp_name)]</span>

                <span class="n">closer_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)</span> <span class="o">-</span> <span class="n">wlines</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

                <span class="n">rline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)[</span><span class="n">closer_index</span><span class="p">]</span>

                <span class="n">rw_difference</span> <span class="o">=</span> <span class="n">wlines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rline</span>
                <span class="c1"># print(&#39;Difference w - r &#39;, rw_difference, rline)</span>
                <span class="n">square_differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rw_difference</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">new_physical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">new_wavelength</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rline</span><span class="p">)</span>
            <span class="n">clipped_differences</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">square_differences</span><span class="p">,</span>
                                             <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                             <span class="n">iters</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_wavelength</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_physical</span><span class="p">)</span> <span class="o">==</span> \
                    <span class="nb">len</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">):</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_wavelength</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">clipped_differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="ow">and</span> <span class="n">new_wavelength</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">:</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_wavelength</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filling_value</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_physical</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filling_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WavelengthCalibration.update_marks_plot"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.update_marks_plot">[docs]</a>    <span class="k">def</span> <span class="nf">update_marks_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the points that represent marks on lamp plots</span>

<span class="sd">        When you mark a line a red dot marks the position of the line at the</span>
<span class="sd">        exact y location of the click, for the x location it will use the value</span>
<span class="sd">        obtained by means of the recentering method. There are three possible</span>
<span class="sd">        actions: Update the reference plot&#39;s click, the raw data marks or</span>
<span class="sd">        delete them all.</span>

<span class="sd">        Args:</span>
<span class="sd">            action (str): A string that could be &#39;reference&#39;, &#39;raw_data&#39; or</span>
<span class="sd">            &#39;delete&#39; depending on the action desired</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(type(action), type(pixel_axis), type(differences))</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;reference&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_y</span><span class="p">,</span>
                                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                                             <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;raw_data&#39;</span><span class="p">:</span>
            <span class="c1"># print self.points_raw</span>
            <span class="c1"># print dir(self.points_raw)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_y</span><span class="p">,</span>
                                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
                                             <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                                             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">points_raw</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax1</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">points_ref</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown Action </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span></div>

<div class="viewcode-block" id="WavelengthCalibration.plot_raw_over_reference"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.plot_raw_over_reference">[docs]</a>    <span class="k">def</span> <span class="nf">plot_raw_over_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overplot raw data over reference lamp using current wavelength</span>
<span class="sd">        solution model</span>

<span class="sd">        Once the wavelength solution is obtained this method is called to apply</span>
<span class="sd">        the already mentioned solution to the raw data and then overplot it on</span>
<span class="sd">        the reference lamp plot. This is very useful to have a visual idea of</span>
<span class="sd">        how far or close the solution is.</span>

<span class="sd">        Args:</span>
<span class="sd">            remove (bool): True or False depending whether you want to remove</span>
<span class="sd">            the overplotted lamp or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_raw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">line_raw</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">remove</span><span class="p">:</span>
                <span class="c1"># TODO(simon): catch TypeError Exception and correct what is</span>
                <span class="c1"># TODO (cont): causing it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line_raw</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_pixel_axis</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lamp_data</span><span class="p">,</span>
                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;New Wavelength Solution&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

<div class="viewcode-block" id="WavelengthCalibration.evaluate_solution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.evaluate_solution">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the Root Mean Square Error of the solution</span>

<span class="sd">        Once the wavelength solution is obtained it has to be evaluated. The</span>
<span class="sd">        line centers found for the raw comparison lamp will be converted to,</span>
<span class="sd">        according to the new solution, angstrom. Then for each line the closest</span>
<span class="sd">        reference line value is obtained. The difference is stored. Then this</span>
<span class="sd">        differences are cleaned by means of a sigma clipping method that will</span>
<span class="sd">        rule out any outlier or any line that is not well matched. Then, using</span>
<span class="sd">        the sigma clipped differences the Root Mean Square error is calculated.</span>

<span class="sd">        It also creates a plot in the bottom right subplot of the interactive</span>
<span class="sd">        window, showing an scatter plot plus some information regarding the</span>
<span class="sd">        quality of the fit.</span>

<span class="sd">        Args:</span>
<span class="sd">            plots (bool): Whether to create the plot or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            results (list): Contains three elements: rms_error (float),</span>
<span class="sd">            npoints (int), n_rejections (int)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">wavelength_line_centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">wline</span> <span class="ow">in</span> <span class="n">wavelength_line_centers</span><span class="p">:</span>
                <span class="n">closer_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)</span> <span class="o">-</span> <span class="n">wline</span><span class="p">))</span>

                <span class="n">rline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_data</span><span class="o">.</span><span class="n">get_line_list_by_name</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lamp_name</span><span class="p">)[</span><span class="n">closer_index</span><span class="p">]</span>

                <span class="n">rw_difference</span> <span class="o">=</span> <span class="n">wline</span> <span class="o">-</span> <span class="n">rline</span>
                <span class="c1"># print &#39;Difference w - r &#39;, rw_difference, rline</span>
                <span class="n">differences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span> <span class="n">rw_difference</span><span class="p">)</span>

            <span class="n">clipping_sigma</span> <span class="o">=</span> <span class="mf">2.</span>
            <span class="c1"># print(differences)</span>
            <span class="n">clipped_differences</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span>
                                             <span class="n">sigma</span><span class="o">=</span><span class="n">clipping_sigma</span><span class="p">,</span>
                                             <span class="n">iters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                             <span class="n">cenfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

            <span class="n">once_clipped_differences</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">differences</span><span class="p">,</span>
                                                  <span class="n">sigma</span><span class="o">=</span><span class="n">clipping_sigma</span><span class="p">,</span>
                                                  <span class="n">iters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">cenfunc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

            <span class="n">npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">)</span>
            <span class="n">n_rejections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">count_masked</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">)</span>
            <span class="n">square_differences</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">clipped_differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
                    <span class="n">square_differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clipped_differences</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">old_rms_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">old_rms_error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">square_differences</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">square_differences</span><span class="p">))</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RMS Error : </span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4_plots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">ax4_com</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">ax4_rlv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS Error </span><span class="si">{:.3f}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> points (</span><span class="si">{:d}</span><span class="s1"> &#39;</span>
                                   <span class="s1">&#39;rejected)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span><span class="p">,</span>
                                                      <span class="n">npoints</span><span class="p">,</span>
                                                      <span class="n">n_rejections</span><span class="p">))</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">once_clipped_differences</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                  <span class="n">once_clipped_differences</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

                <span class="c1"># self.ax4.set_ylim(- rms_error, 2 * rms_error)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4_rlv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">,</span>
                                                <span class="n">differences</span><span class="p">,</span>
                                                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Rejected Points&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4_com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">axhspan</span><span class="p">(</span><span class="n">clipped_differences</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                                <span class="n">clipped_differences</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                                                <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:.1f}</span><span class="s1"> Sigma&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">clipping_sigma</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4_plots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines_center</span><span class="p">,</span>
                                                  <span class="n">clipped_differences</span><span class="p">,</span>
                                                  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Differences&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">old_rms_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># increment_color = &#39;white&#39;</span>
                    <span class="n">rms_error_difference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span> <span class="o">-</span> <span class="n">old_rms_error</span>

                    <span class="k">if</span> <span class="n">rms_error_difference</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">increment_color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
                    <span class="k">elif</span> <span class="n">rms_error_difference</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">increment_color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">increment_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>

                    <span class="n">message</span> <span class="o">=</span> <span class="s1">r&#39;$\Delta$ RMSE </span><span class="si">{:+.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">rms_error_difference</span><span class="p">)</span>

                    <span class="c1"># self.display_onscreen_message(message=message,</span>
                    <span class="c1">#                               color=increment_color)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span>
                                  <span class="n">message</span><span class="p">,</span>
                                  <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                  <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                                  <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                                  <span class="n">color</span><span class="o">=</span><span class="n">increment_color</span><span class="p">,</span>
                                  <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel Axis (Pixels)&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference (Angstroms)&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rms_error</span><span class="p">,</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">n_rejections</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Solution is still non-existent!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthCalibration.fit_pixel_to_wavelength"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.fit_pixel_to_wavelength">[docs]</a>    <span class="k">def</span> <span class="nf">fit_pixel_to_wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does the fit to find the wavelength solution</span>

<span class="sd">        Once you have four data points on each side (raw and reference or pixel</span>
<span class="sd">        and angstrom) it calculates the fit using a Chebyshev model of third</span>
<span class="sd">        degree. This was chosen because it worked better compared to the rest.</span>
<span class="sd">        There is a slight deviation from linearity in all Goodman data,</span>
<span class="sd">        therefore a linear model could not be used, also is said that a Spline</span>
<span class="sd">        of third degree is &quot;too flexible&quot; which I also experienced and since the</span>
<span class="sd">        deviation from linearity is not extreme it seemed that it was not</span>
<span class="sd">        necessary to implement.</span>

<span class="sd">        This method checks that the data that will be used as input to calculate</span>
<span class="sd">        the fit have the same dimensions and warns the user in case is not.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None (None): An empty return is created to finish the execution of</span>
<span class="sd">            the method when a fit will not be possible</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> \
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>

                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Not enough marks! Minimum 4 each side.&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">):</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> Reference Click is &#39;</span> \
                                       <span class="s1">&#39;missing!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> Reference Clicks are &#39;</span> \
                                       <span class="s1">&#39;missing!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> Raw Click is missing!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">message_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1"> Raw Clicks are missing!.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span><span class="n">message_text</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pixel</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">angstrom</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">)):</span>
                    <span class="n">pixel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_marks_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">angstrom</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_marks_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="n">wavelength_solution</span> <span class="o">=</span> <span class="n">WavelengthFitter</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s1">&#39;chebyshev&#39;</span><span class="p">,</span>
                                                       <span class="n">degree</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="n">wavelength_solution</span><span class="o">.</span><span class="n">ws_fit</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="n">angstrom</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Clicks record is empty&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_onscreen_message</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">&#39;Clicks record is empty&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="WavelengthCalibration.linearize_spectrum"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.linearize_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">linearize_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produces a linearized version of the spectrum</span>

<span class="sd">        Storing wavelength solutions in a FITS header is not simple at all for</span>
<span class="sd">        non-linear solutions therefore is easier for the final user and for the</span>
<span class="sd">        development code to have the spectrum linearized. It first finds a</span>
<span class="sd">        spline representation of the data, then creates a linear wavelength axis</span>
<span class="sd">        (angstrom) and finally it resamples the data from the spline</span>
<span class="sd">        representation to the linear wavelength axis.</span>

<span class="sd">        It also applies a median filter of kernel size three to smooth the</span>
<span class="sd">        linearized spectrum. Sometimes the splines produce funny things when</span>
<span class="sd">        the original data is too steep.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Array): The non-linear spectrum</span>
<span class="sd">            plots (bool): Whether to show the plots or not</span>

<span class="sd">        Returns:</span>
<span class="sd">            linear_data (list): Contains two elements: Linear wavelength axis</span>
<span class="sd">            and the smoothed linearized data itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for data_point in data:</span>
        <span class="c1">#     print(data_point)</span>
        <span class="c1"># print(&#39;data &#39;, data)</span>
        <span class="n">pixel_axis</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="c1"># print(pixel_axis)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span><span class="p">(</span><span class="n">pixel_axis</span><span class="p">)</span>
            <span class="n">new_x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_axis</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">tck</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">linearized_data</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span>
                                                      <span class="n">tck</span><span class="p">,</span>
                                                      <span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">smoothed_linearized_data</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">medfilt</span><span class="p">(</span><span class="n">linearized_data</span><span class="p">)</span>
            <span class="c1"># print(&#39;sl &#39;, smoothed_linearized_data)</span>
            <span class="k">if</span> <span class="n">plots</span><span class="p">:</span>
                <span class="n">fig6</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Wavelength (Angstrom)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (Counts)&#39;</span><span class="p">)</span>
                <span class="n">fig6</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Linearized Data&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span>
                         <span class="n">data</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span>
                         <span class="n">linearized_data</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                         <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linearized Data&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span>
                         <span class="n">smoothed_linearized_data</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Smoothed Linearized Data&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="n">fig7</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pixels&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Angstroms&#39;</span><span class="p">)</span>
                <span class="n">fig7</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="s1">&#39;Wavelength Solution&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Non linear wavelength-axis&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_x_axis</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Linear wavelength-axis&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">linear_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_x_axis</span><span class="p">,</span> <span class="n">smoothed_linearized_data</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">linear_data</span></div>

<div class="viewcode-block" id="WavelengthCalibration.add_wavelength_solution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.add_wavelength_solution">[docs]</a>    <span class="k">def</span> <span class="nf">add_wavelength_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">new_header</span><span class="p">,</span>
                                <span class="n">spectrum</span><span class="p">,</span>
                                <span class="n">original_filename</span><span class="p">,</span>
                                <span class="n">evaluation_comment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add wavelength solution to the new FITS header</span>

<span class="sd">        Defines FITS header keyword values that will represent the wavelength</span>
<span class="sd">        solution in the header so that the image can be read in any other</span>
<span class="sd">        astronomical tool. (e.g. IRAF)</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method also saves the data to a new FITS file, This should be</span>
<span class="sd">            in separated methods to have more control on either process.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_header (object): An Astropy header object</span>
<span class="sd">            spectrum (Array): A numpy array that corresponds to the processed</span>
<span class="sd">            data</span>
<span class="sd">            original_filename (str): Original Image file name</span>
<span class="sd">            evaluation_comment (str): A comment with information regarding the</span>
<span class="sd">            quality of the wavelength solution</span>
<span class="sd">            index (int): If in one 2D image there are more than one target the</span>
<span class="sd">            index represents the target number.</span>

<span class="sd">        Returns:</span>
<span class="sd">            new_header (object): An Astropy header object. Although not</span>
<span class="sd">            necessary since there is no further processing</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">evaluation_comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rms_error</span><span class="p">,</span> <span class="n">n_points</span><span class="p">,</span> <span class="n">n_rejections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_solution</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_comment</span> <span class="o">=</span> <span class="s1">&#39;Lamp Solution RMSE = </span><span class="si">{:.3f}</span><span class="s1"> &#39;</span> \
                                      <span class="s1">&#39;Npoints = </span><span class="si">{:d}</span><span class="s1">, &#39;</span> \
                                      <span class="s1">&#39;NRej = </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rms_error</span><span class="p">,</span>
                                                           <span class="n">n_points</span><span class="p">,</span>
                                                           <span class="n">n_rejections</span><span class="p">)</span>

            <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_comment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evaluation_comment</span>

        <span class="n">new_crpix</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_crval</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">new_crpix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">new_cdelt</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">new_crpix</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">new_crpix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;BANDID1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;spectrum - background none, weights none, &#39;</span> \
                                <span class="s1">&#39;clean no&#39;</span>
        <span class="c1"># new_header[&#39;APNUM1&#39;] = &#39;1 1 1452.06 1454.87&#39;</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;WCSDIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LINEAR  &#39;</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_crval</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_crpix</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cdelt</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;CD1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cdelt</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;LTM1_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;WAT0_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;system=equispec&#39;</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;WAT1_001&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wtype=linear label=Wavelength units=angstroms&#39;</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;DC-FLAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;DCLOG1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;REFSPEC1 = </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_lamp</span><span class="p">)</span>

        <span class="c1"># print(new_header[&#39;APNUM*&#39;])</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f_end</span> <span class="o">=</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_end</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{:d}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># idea</span>
        <span class="c1">#  remove .fits from original_filename</span>
        <span class="c1"># define a base original name</span>
        <span class="c1"># modify in to _1, _2 etc in case there are multitargets</span>
        <span class="c1"># add .fits</span>

        <span class="n">new_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">destiny</span> <span class="o">+</span> \
                       <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">output_prefix</span> <span class="o">+</span> \
                       <span class="n">original_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> \
                       <span class="n">f_end</span>

        <span class="c1">#  print(&#39;spectrum[0]&#39;)</span>
        <span class="c1"># print(spectrum[0])</span>
        <span class="c1"># print(&#39;spectrum[1]&#39;)</span>
        <span class="c1"># print(spectrum[1])</span>
        <span class="c1"># print(len(spectrum))</span>

        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_filename</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_header</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created new file: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_filename</span><span class="p">))</span>
        <span class="c1"># print new_header</span>
        <span class="k">return</span> <span class="n">new_header</span></div>

<div class="viewcode-block" id="WavelengthCalibration.display_onscreen_message"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.display_onscreen_message">[docs]</a>    <span class="k">def</span> <span class="nf">display_onscreen_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses the fourth subplot to display a message</span>

<span class="sd">        Displays a warning message on the bottom right subplot of the</span>
<span class="sd">        interactive window. It is capable to break down the message in more</span>
<span class="sd">        than one line if necessary.</span>

<span class="sd">        Args:</span>
<span class="sd">            message (str): The message to be displayed</span>
<span class="sd">            color (str): Color name for the font&#39;s color</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_message</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">full_message</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">split_message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">line_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># new_line = &#39;&#39;</span>
            <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)):</span>
                <span class="c1"># print(i, len(split_message))</span>
                <span class="n">line_length</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">line_length</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">:</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_message</span><span class="p">[</span><span class="n">e</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                    <span class="c1"># print(new_line, len(new_line))</span>
                    <span class="n">full_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
                    <span class="c1"># new_line = &#39;&#39;</span>
                    <span class="n">line_length</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_message</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_message</span><span class="p">[</span><span class="n">e</span><span class="p">:])</span>
                    <span class="c1"># print(new_line, len(new_line))</span>
                    <span class="n">full_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">full_message</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">,</span>
                              <span class="n">full_message</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                              <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                              <span class="n">transform</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                              <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="WavelengthCalibration.display_help_text"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthCalibration.display_help_text">[docs]</a>    <span class="k">def</span> <span class="nf">display_help_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shows static text on the top right subplot</span>

<span class="sd">        This will print static help text on the top right subplot of the</span>
<span class="sd">        interactive window.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This is really hard to format and having a proper GUI should help</span>
<span class="sd">            to have probably richer formatted text on the screen.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Help&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;F1 or ?:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;Prints Help.&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">,</span> <span class="s1">&#39;F2 or f:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">,</span> <span class="s1">&#39;Fit Wavelength Solution to points&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;collected&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="s1">&#39;F3 or a:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="s1">&#39;Find new lines, use when the solution&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;is already decent.&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="s1">&#39;F4:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="s1">&#39;Evaluate Solution&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;F6 or l:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;Linearize Data&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="s1">&#39;d :&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="s1">&#39;Delete Closest Point&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Ctrl+d:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;Delete all recorded marks.&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Ctrl+z:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;Remove all automatic added points.&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="s1">&#39;Undo what F3 does.&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Middle Button Click:&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="s1">&#39;Finds and records line position&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Enter :&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Close Figure and apply wavelength&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.46</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">,</span>
                      <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="WavelengthSolution"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthSolution">[docs]</a><span class="k">class</span> <span class="nc">WavelengthSolution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains all relevant information of a given wavelength solution</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">solution_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">model_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ref_lamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">eval_comment</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                           <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s1">&#39;log_linear&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="s1">&#39;non_linear&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

        <span class="c1"># if solution_type == &#39;non_linear&#39; and model_name is not None:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ftype_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chebyshev&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="s1">&#39;legendre&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="s1">&#39;cubic_spline&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                           <span class="s1">&#39;linear_spline&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                           <span class="s1">&#39;pixel_coords&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                           <span class="s1">&#39;samples_coords&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                           <span class="kc">None</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution_type</span> <span class="o">=</span> <span class="n">solution_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_order</span> <span class="o">=</span> <span class="n">model_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wsolution</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_lamp</span> <span class="o">=</span> <span class="n">ref_lamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_comment</span> <span class="o">=</span> <span class="n">eval_comment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_spectral_features</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_solution_name</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="WavelengthSolution.set_spectral_features"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthSolution.set_spectral_features">[docs]</a>    <span class="k">def</span> <span class="nf">set_spectral_features</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates dictionary that defines the instrument configuration</span>

<span class="sd">        Both Blue and Red Camera produce slightly different FITS headers being</span>
<span class="sd">        the red camera the one that provides more precise and better</span>
<span class="sd">        information. This method will recognize the camera and create the</span>
<span class="sd">        dictionary accordingly.</span>

<span class="sd">        Args:</span>
<span class="sd">            header:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Header has not been parsed&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Red Camera&#39;</span><span class="p">)</span>
                <span class="n">spectral_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;camera&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;grating&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;GRATING&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;roi&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;filter1&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;filter2&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER2&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;slit&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;instconf&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;INSTCONF&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;wavmode&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;WAVMODE&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;cam_ang&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CAM_ANG&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;grt_ang&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;GRT_ANG&#39;</span><span class="p">]}</span>

                <span class="c1"># for key in dict.keys():</span>
                <span class="c1"># print(key, dict[key])</span>
                <span class="k">return</span> <span class="n">spectral_dict</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Blue Camera&#39;</span><span class="p">)</span>
                <span class="n">spectral_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;camera&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;grating&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;GRATING&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;ccdsum&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CCDSUM&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;filter1&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;filter2&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILTER2&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;slit&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;SLIT&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;serial_bin&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PARAM18&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;parallel_bin&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;PARAM22&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;cam_ang&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CAM_ANG&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;grt_ang&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;GRT_ANG&#39;</span><span class="p">]}</span>

                <span class="c1"># for key in dict.keys():</span>
                <span class="c1"># print(key, dict[key])</span>
                <span class="k">return</span> <span class="n">spectral_dict</span></div>

<div class="viewcode-block" id="WavelengthSolution.check_compatibility"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthSolution.check_compatibility">[docs]</a>    <span class="k">def</span> <span class="nf">check_compatibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks compatibility of new data</span>

<span class="sd">        A wavelength solution is stored as an object (this class). As an</span>
<span class="sd">        attribute of this class there is a dictionary that contains critical</span>
<span class="sd">        parameters of the spectrum with which the wavelength solution was found.</span>
<span class="sd">        In order to apply the same solution to another spectrum its header has</span>
<span class="sd">        to be parsed and then the parameters are compared in a hierarchic way.</span>

<span class="sd">        Args:</span>
<span class="sd">            header (object): FITS header object from astropy.io.fits</span>

<span class="sd">        Returns:</span>
<span class="sd">            True or False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">new_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_spectral_features</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="s1">&#39;camera&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">,</span> <span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="s1">&#39;instconf&#39;</span><span class="p">,</span> <span class="s1">&#39;wavmode&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Keyword: </span><span class="si">{:s}</span><span class="s1"> does not Match&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> - Solution: </span><span class="si">{:s}</span><span class="s1"> - New Data: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">,</span>
                                 <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                 <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cam_ang&#39;</span><span class="p">,</span>  <span class="s1">&#39;grt_ang&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                    <span class="nb">abs</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyword: </span><span class="si">{:s}</span><span class="s1"> Lamp: </span><span class="si">{:s}</span><span class="s1"> Data: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">,</span>
                                  <span class="n">key</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                  <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Solution belong to a different Instrument&#39;</span>
                                 <span class="s1">&#39;Configuration.&#39;</span><span class="p">)</span>

                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     return True</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="s1">&#39;camera&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;blue&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;ccdsum&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;serial_bin&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;parallel_bin&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                    <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyword: </span><span class="si">{:s}</span><span class="s1"> does not Match&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:s}</span><span class="s1"> - Solution: </span><span class="si">{:s}</span><span class="s1"> - New Data: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">,</span>
                                 <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                 <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cam_ang&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;grt_ang&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">-</span>
                                <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Keyword: </span><span class="si">{:s}</span><span class="s1"> Lamp: </span><span class="si">{:s}</span><span class="s1"> Data: </span><span class="si">{:s}</span><span class="s1">&#39;</span><span class="p">,</span>
                                  <span class="n">key</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">spectral_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                                  <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Solution belong to a different Instrument &#39;</span>
                                 <span class="s1">&#39;Configuration.&#39;</span><span class="p">)</span>

                        <span class="k">return</span> <span class="kc">False</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     return True</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Header has not been parsed&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="WavelengthSolution.set_solution_name"><a class="viewcode-back" href="../../goodman_spec.html#goodman_spec.wavelength.WavelengthSolution.set_solution_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_solution_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="n">name_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">grating</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Grating part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;NO GRATING&gt;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Imaging&#39;</span><span class="p">:</span>
                    <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_nogrt&#39;</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;KeyError: Blue Camera&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grating</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">grating</span>
            <span class="c1"># Mode for the grating part of the flat name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;KeyError: Blue Camera&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># it means it is Custom mode</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Custom&#39;</span><span class="p">:</span>
                    <span class="n">grating_frequency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">grating</span><span class="p">))</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;grt_ang&#39;</span><span class="p">])</span>
                    <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cam_ang&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;grt_ang&#39;</span><span class="p">])</span>

                    <span class="n">center_wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">e6</span> <span class="o">/</span> <span class="n">grating_frequency</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">))</span>

                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">center_wavelength</span><span class="p">)</span>

                    <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> \
                                 <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> \
                                 <span class="s1">&#39;_</span><span class="si">{:d}</span><span class="s1">nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">center_wavelength</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;WAVMODE: </span><span class="si">{:s}</span><span class="s1"> not supported&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="c1"># First filter wheel part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&lt;NO FILTER&gt;&#39;</span><span class="p">:</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="c1"># Second filter wheel part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&lt;NO FILTER&gt;&#39;</span><span class="p">:</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span>
        <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z&quot; ]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;slit&#39;</span><span class="p">])</span>

        <span class="n">wsolution_name</span> <span class="o">=</span> <span class="s1">&#39;ws&#39;</span> <span class="o">+</span> <span class="n">name_text</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">wsolution_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wsolution_name</span></div></div>
        <span class="c1"># else:</span>
        <span class="c1">#     log.error(&#39;There is no flat suitable for use&#39;)</span>
        <span class="c1">#     return False</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;This can not be run on its own.&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 1.0b1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon Torres.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>