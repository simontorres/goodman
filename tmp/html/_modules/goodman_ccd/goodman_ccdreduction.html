<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>goodman_ccd.goodman_ccdreduction &#8212; Goodman Pipelines 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for goodman_ccd.goodman_ccdreduction</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># -*- coding: utf8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># PyGoodman CCD Reduction - CCD reductions for Goodman spectroscopic data.</span>

<span class="sd">This script performs CCD reduction for long-slit spectra taken with the</span>
<span class="sd">Goodman High Throughput Spectrograph at SOAR Telescope. The script will</span>
<span class="sd">make (in order):</span>

<span class="sd">- BIAS subtraction</span>
<span class="sd">- TRIMMING including slit edges identification (it does not work for MOS spectroscopy)</span>
<span class="sd">- FLAT correction</span>
<span class="sd">- COSMIC rays rejection (optional)</span>

<span class="sd">Users can add a flag in order to clean up science data from cosmic rays, which</span>
<span class="sd">are removed by using the LACosmic code (P. G. van Dokkum, 2001, PASP, 113, 1420).</span>

<span class="sd">## I/O Data Structure</span>

<span class="sd">This script was designed to make CCD reduction for any spectrograph configuration,</span>
<span class="sd">but the input directory should contain only an unique spectral configuration (binning,</span>
<span class="sd">grating, slit, gain, rdnoise, CCD ROI, etc). The input dir should contain only the</span>
<span class="sd">following frames:</span>

<span class="sd">- BIAS frames</span>
<span class="sd">- FLAT frames  (Flats taken between science exposures will be trimmed and bias subtracted.)</span>
<span class="sd">- ARC frames   (data from focus sequence will not be reduced)</span>
<span class="sd">- SCIENCE and/or STANDARD frames</span>

<span class="sd">Please, inspect you calibration and throw it out the bad ones. The output data has the same</span>
<span class="sd">filename of the input data, but with a prefix &quot;fzh&quot;. It means data has its header updated (h),</span>
<span class="sd">bias subtracted (z) and flat corrected (f). The prefix &quot;c_fzh&quot; means that cosmic ray correction</span>
<span class="sd">was applied.</span>

<span class="sd">## How to use it...</span>

<span class="sd">It can be be executed in terminal running:</span>

<span class="sd">    $ python goodman_ccdreduction.py [options] raw_path red_path</span>

<span class="sd">More information about the options and how to use it can be obtained by using...</span>

<span class="sd">    $ python goodman_ccdreduction.py --help</span>

<span class="sd">or</span>
<span class="sd">    $ python goodman_ccdreduction.py -h</span>

<span class="sd">Documentation for specific functions of the code can be found directly in the corresponding</span>
<span class="sd">function. (To be done...)</span>

<span class="sd">#ToDo</span>

<span class="sd">- Consider internal illumination correction (in fact this will not be done)</span>
<span class="sd">- Disable the flat correction if there is a no grating flat</span>
<span class="sd">- Automatically determine the best input parameters for LACOSMIC</span>

<span class="sd">David Sanmartim (dsanmartim at gemini.edu)</span>
<span class="sd">August 2016</span>

<span class="sd">Thanks to Bruno Quint for all comments and helping.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>

<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="k">import</span> <span class="n">EarthLocation</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="k">import</span> <span class="n">Time</span><span class="p">,</span> <span class="n">TimeDelta</span>
<span class="kn">from</span> <span class="nn">astroplan</span> <span class="k">import</span> <span class="n">Observer</span>
<span class="c1"># from astroplan import get_IERS_A_or_workaround, download_IERS_A</span>

<span class="kn">import</span> <span class="nn">ccdproc</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">ImageFileCollection</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">CCDData</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;David Sanmartim&#39;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s1">&#39;2016-07-15&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;dsanmartim@ctio.noao.edu&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Simon Torres&quot;</span>


<div class="viewcode-block" id="Main"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main">[docs]</a><span class="k">class</span> <span class="nc">Main</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Main class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization of class</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_args</span><span class="p">()</span>

        <span class="c1"># Soar Geodetic Location and other definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observatory</span> <span class="o">=</span> <span class="s1">&#39;SOAR Telescope&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Geodetic_Location</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-70d44m01.11s&#39;</span><span class="p">,</span> <span class="s1">&#39;-30d14m16.41s&#39;</span><span class="p">,</span> <span class="mi">2748</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Geodetic_Location</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Geodetic_Location</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Geodetic_Location</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Soar Telescope on Cerro Pachon, Chile&#39;</span>

        <span class="c1"># Set variables used globally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slit2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ToDo Check if the file already exist before download it</span>
        <span class="c1"># if get_IERS_A_or_workaround() is None:</span>
        <span class="c1">#     download_IERS_A(show_progress=True)</span>

        <span class="c1"># Memory Limit to be used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memlim</span> <span class="o">=</span> <span class="mi">32</span><span class="n">E9</span>
        <span class="c1"># self.memlim = 1E7</span>
        <span class="c1"># For computer with up to 8GB of RAM</span>
        <span class="c1"># self.memlim = 6E6</span>

        <span class="c1"># Taking some args from argparse method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">raw_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">red_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">red_path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;raw_path may not be equal to red_path&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># checking the reduction directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">)</span>

        <span class="c1"># About warnings</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># cleaning up the reduction dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">)</span>

        <span class="c1"># Fixing header and shape of raw data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_header_and_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;h_&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># remove saturated data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">remove_saturated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_saturated_flats</span><span class="p">()</span>

        <span class="c1"># Create image file collection for raw data</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">)</span>

        <span class="c1"># Getting twilight time</span>
        <span class="n">twi_eve</span><span class="p">,</span> <span class="n">twi_mor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_twilight_time</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observatory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timezone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
        <span class="c1"># Create master_flats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_daymaster_flat</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">twi_eve</span><span class="p">,</span> <span class="n">twi_mor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">slit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memlim</span><span class="p">)</span>
        <span class="c1"># sys.exit(0)</span>

        <span class="c1"># Create master bias</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ic</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;BIAS&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_master_bias</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">slit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memlim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No BIAS image detected&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The images will be processed but the results will not be optimal&#39;</span><span class="p">)</span>

        <span class="c1"># Reduce Night Flat frames (if they exist)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_nightflats</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">twi_eve</span><span class="p">,</span> <span class="n">twi_mor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">slit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>

        <span class="c1"># Reduce Arc frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_arc</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">slit</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;fz&#39;</span><span class="p">)</span>

        <span class="c1"># Reduce Sci frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_sci</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">slit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">clean</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;fz&#39;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.get_args"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_args">[docs]</a>    <span class="k">def</span> <span class="nf">get_args</span><span class="p">():</span>
        <span class="c1"># Parsing Arguments ---</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;PyGoodman CCD Reduction - CCD reductions for &quot;</span>
                                                     <span class="s2">&quot;Goodman spectroscopic data&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--clean&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clean cosmic rays from science data.&quot;</span><span class="p">)</span>

        <span class="c1"># removed because is not working properly</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--slit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Find slit edge to make an additional trimming (Maintainer: Not recommended for now).&quot;</span><span class="p">)</span>

        <span class="c1"># remove saturated data</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--remove-saturated&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;remove_saturated&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Remove images above saturation level&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--saturation&#39;</span><span class="p">,</span>
                            <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="mf">55000.</span><span class="p">,</span>
                            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;saturation_limit&#39;</span><span class="p">,</span>
                            <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&lt;Value&gt;&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Saturation limit. Default to 55.000 ADU (counts)&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;raw_path&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;raw_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Full path to raw data (e.g. /home/jamesbond/soardata/).&quot;</span><span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;red_path&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;red_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Full path to reduced data (e.g /home/jamesbond/soardata/RED/).&quot;</span><span class="p">)</span>

        <span class="c1"># parser.add_argument(&#39;--red-camera&#39;, action=&#39;store_true&#39;, default=False, dest=&#39;red_camera&#39;,</span>
        <span class="c1">#                    help=&#39;Enables Goodman Red Camera&#39;)</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">args</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.fit_spline3"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.fit_spline3">[docs]</a>    <span class="k">def</span> <span class="nf">fit_spline3</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nsum</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit a cubic spline to an 1D-array of N pixels.</span>

<span class="sd">        Args:</span>
<span class="sd">            y (1D array like): A 1-D array of monotonically increasing real values</span>
<span class="sd">            order (int): order of t</span>
<span class="sd">            nsum (int): number of array elements to be averaged</span>

<span class="sd">        Returns:</span>
<span class="sd">             f (class): It returns a function</span>

<span class="sd">        Examples:</span>

<span class="sd">        f = fit_spline3(y, order=5, nsum=2)</span>
<span class="sd">        x = np.arange(0,1500,1)</span>
<span class="sd">        ysmooth = f(x)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_resampled</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">nsum</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">%</span> <span class="n">nsum</span><span class="p">,</span> <span class="n">nsum</span><span class="p">)]</span>
        <span class="n">x_resampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">))</span>

        <span class="c1"># Fitting</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="c1"># Return function to be constructed with any other x array</span>
        <span class="k">return</span> <span class="n">f</span></div>

    <span class="c1"># Local Minima and Maxima</span>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.local_minmax"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.local_minmax">[docs]</a>    <span class="k">def</span> <span class="nf">local_minmax</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find local minima-maxima points for a set of non-noisy data</span>

<span class="sd">        Args:</span>
<span class="sd">            data (1D array like): 1D array of non-noisy data</span>
<span class="sd">            nmin (int): number of local minina to be find</span>
<span class="sd">            nmax (int): number of local maxima to be find</span>

<span class="sd">        Returns: It returns a function</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Identifying indices of local minima-maxima points</span>
        <span class="n">id_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># index of local min</span>
        <span class="n">id_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># index of local max</span>

        <span class="c1"># Taking values at min/max points</span>
        <span class="n">list_min</span><span class="p">,</span> <span class="n">list_max</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">id_min</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">id_max</span><span class="p">]</span>

        <span class="c1"># Sorting minima-maxima values (bigger --&gt; lower)</span>
        <span class="n">list_min</span><span class="p">,</span> <span class="n">id_min</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">list_min</span><span class="p">,</span> <span class="n">id_min</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
        <span class="n">list_max</span><span class="p">,</span> <span class="n">id_max</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">list_max</span><span class="p">,</span> <span class="n">id_max</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

        <span class="c1"># Taking the desired number of local minima-maxima points</span>
        <span class="n">list_min</span><span class="p">,</span> <span class="n">list_max</span><span class="p">,</span> <span class="n">id_min</span><span class="p">,</span> <span class="n">id_max</span> <span class="o">=</span> <span class="n">list_min</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nmin</span><span class="p">],</span> <span class="n">list_max</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nmax</span><span class="p">],</span> <span class="n">id_min</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nmin</span><span class="p">],</span> <span class="n">id_max</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nmax</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">list_min</span><span class="p">,</span> <span class="n">list_max</span><span class="p">,</span> <span class="n">id_min</span><span class="p">,</span> <span class="n">id_max</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.clean_path"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.clean_path">[docs]</a>    <span class="k">def</span> <span class="nf">clean_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all FITS files in a directory. It&#39;s not recursive.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.fix_header_and_shape"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.fix_header_and_shape">[docs]</a>    <span class="k">def</span> <span class="nf">fix_header_and_shape</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove/Update some  inconvenient parameters in the header of the Goodman FITS files.</span>

<span class="sd">        Some of these parameters contain non-printable ASCII characters. The output</span>
<span class="sd">        files are created in the output_path. Also convert fits from 3D [1, X, Y] to 2D [X, Y].</span>

<span class="sd">        Args:</span>
<span class="sd">            input_path (str): Location of input data.</span>
<span class="sd">            output_path (str): Location of output data.</span>
<span class="sd">            prefix (str): Prefix to be added in the filename of output data</span>
<span class="sd">            overwrite (bool): If true it will overwrite existing data. Optional.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">_file</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="s1">&#39;*.fits&#39;</span><span class="p">))):</span>

            <span class="n">ccddata</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if not self.args.red_camera:</span>

            <span class="c1"># 3D to 2D</span>
            <span class="k">if</span> <span class="n">ccddata</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">is</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ccddata</span> <span class="o">=</span> <span class="n">ccddata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="c1"># keywords to remove</span>
            <span class="n">key_list_to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PARAM0&#39;</span><span class="p">,</span> <span class="s1">&#39;PARAM61&#39;</span><span class="p">,</span> <span class="s1">&#39;PARAM62&#39;</span><span class="p">,</span> <span class="s1">&#39;PARAM63&#39;</span><span class="p">,</span> <span class="s1">&#39;NAXIS3&#39;</span><span class="p">,</span> <span class="s1">&#39;INSTRUME&#39;</span><span class="p">]</span>

            <span class="c1"># Keyword to be changed (3 --&gt; 2)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;N_PARAM&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_list_to_remove</span><span class="p">)</span>
                <span class="c1"># Specific keywords to be removed</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list_to_remove</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">hdr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">hdr</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">key_error</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">key_error</span><span class="p">)</span>

            <span class="c1"># Removing duplicated keywords</span>
            <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hdr</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
                    <span class="n">hdr</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="n">hdr</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39;Header and Shape fixed.&#39;</span><span class="p">)</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">),</span> <span class="n">ccddata</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span>
                         <span class="n">clobber</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Header of &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has been updated --&gt; &#39;</span> <span class="o">+</span> <span class="n">prefix</span>
                     <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">_file</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done: All headers have been updated.&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.filter_saturated_flats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.filter_saturated_flats">[docs]</a>    <span class="k">def</span> <span class="nf">filter_saturated_flats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove saturated flats</span>

<span class="sd">        This method grabs all the images of OBSTYPE equal FLAT then reads the data and gets the value of its maximum and</span>
<span class="sd">        then if this maximum is larger than the threshold which by default is 55000 the image will be removed from the</span>
<span class="sd">        reduction directory therefore it will not exist for further processing. Note that is not the original image the</span>
<span class="sd">        the one being deleted. The threshold can be changed by parsing the argument --saturation in the command line</span>
<span class="sd">        plus the new value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">red_path</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span>
        <span class="n">ic_pandas</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">flats</span> <span class="o">=</span> <span class="n">ic_pandas</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][</span><span class="n">ic_pandas</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">flat_image</span> <span class="ow">in</span> <span class="n">flats</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">flat_image</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">flat_image</span><span class="p">)</span>
                <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># print(data_max)</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">data_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">saturation_limit</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flat_image</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">flat_image</span> <span class="o">+</span> <span class="s1">&#39; Removed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">%s</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="p">,</span> <span class="n">flat_image</span><span class="p">)</span></div>

<div class="viewcode-block" id="Main.find_slitedge"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.find_slitedge">[docs]</a>    <span class="k">def</span> <span class="nf">find_slitedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ccddata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find slit edge by inspecting signal variation in the spatial direction</span>
<span class="sd">        of flat frames. The spatial direction is assumed to be axis=0 (or y axis</span>
<span class="sd">        in IRAF convention) and data are divided in two regions in which we are</span>
<span class="sd">        looking for slit edges.</span>

<span class="sd">        Args:</span>
<span class="sd">            ccddata (ccdproc.CCDData): The actual data contained in this ccdproc.CCDData object</span>

<span class="sd">        Returns:</span>
<span class="sd">            slit1 (int): Bottom limit in pixel value of slit edge.</span>
<span class="sd">            slit2 (int): Top limit in pixel value of slit edge.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reading and Collapsing flat in the dispersion direction</span>
        <span class="n">flat_collapsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ccddata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ccddata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Excluding 3 first pixels in the spatial direction</span>
        <span class="n">cut</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">c_flat</span> <span class="o">=</span> <span class="n">flat_collapsed</span><span class="p">[</span><span class="n">cut</span><span class="p">:</span><span class="o">-</span><span class="n">cut</span><span class="p">]</span>
        <span class="n">c_lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c_flat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Fitting cubic spline. It&#39;s working very well with order=5, nsum=2</span>
        <span class="n">func_splin3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_spline3</span><span class="p">(</span><span class="n">c_flat</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">nsum</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">smooth_flat</span> <span class="o">=</span> <span class="n">func_splin3</span><span class="p">(</span><span class="n">c_lines</span><span class="p">)</span>

        <span class="c1"># Compute 1st and flat smoothed</span>
        <span class="n">dy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">smooth_flat</span><span class="p">))</span>

        <span class="c1"># Region one: it represent first 40 percent of all data. Region two: ... last 40%</span>
        <span class="n">pixa</span><span class="p">,</span> <span class="n">pixb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_flat</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c_flat</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="n">dy2_one</span><span class="p">,</span> <span class="n">dy2_two</span> <span class="o">=</span> <span class="n">dy2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pixa</span><span class="p">],</span> <span class="n">dy2</span><span class="p">[</span><span class="n">pixb</span><span class="p">:]</span>

        <span class="c1"># Reg. 1: Compute local min/max of the 2nd derivative</span>
        <span class="n">list_min_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">id_min_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_minmax</span><span class="p">(</span><span class="n">dy2_one</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">list_min_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">id_min_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_minmax</span><span class="p">(</span><span class="n">dy2_two</span><span class="p">,</span> <span class="n">nmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Slit edges are the local maxima/minima 1/2 [accounting the cutted pixels]</span>
        <span class="n">slit_1</span><span class="p">,</span> <span class="n">slit_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">id_min_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cut</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">id_min_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pixb</span><span class="p">)</span> <span class="o">+</span> <span class="n">cut</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slit_1</span><span class="p">,</span> <span class="n">slit_2</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.get_twilight_time"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_twilight_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_twilight_time</span><span class="p">(</span><span class="n">image_collection</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">elevation</span><span class="p">,</span> <span class="n">timezone</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get end/start time of evening/morning twilight</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            observatory (str): Observatory name.</span>
<span class="sd">            longitude (str): Geographic longitude in string format.</span>
<span class="sd">            latitude (str): Geographic latitude in string format.</span>
<span class="sd">            elevation (int): Geographic elevation in meters above sea level</span>
<span class="sd">            timezone (str): Time zone.</span>
<span class="sd">            description (str): Observatory description</span>

<span class="sd">        Returns:</span>
<span class="sd">            twilight_evening (str): Evening twilight time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>
<span class="sd">            twilight_morning (str): Morning twilight time in the format &#39;YYYY-MM-DDTHH:MM:SS.SS&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">soar_loc</span> <span class="o">=</span> <span class="n">EarthLocation</span><span class="o">.</span><span class="n">from_geodetic</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">elevation</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ellipsoid</span><span class="o">=</span><span class="s1">&#39;WGS84&#39;</span><span class="p">)</span>

        <span class="n">soar</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">observatory</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">soar_loc</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="n">dateobs_list</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;date-obs&#39;</span><span class="p">)</span>
        <span class="n">time_first_frame</span><span class="p">,</span> <span class="n">time_last_frame</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dateobs_list</span><span class="p">)),</span> <span class="n">Time</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dateobs_list</span><span class="p">))</span>

        <span class="n">twilight_evening</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_evening_astronomical</span><span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">time_first_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>
        <span class="n">twilight_morning</span> <span class="o">=</span> <span class="n">soar</span><span class="o">.</span><span class="n">twilight_morning_astronomical</span><span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">time_last_frame</span><span class="p">),</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isot</span>

        <span class="k">return</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.get_night_flats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_night_flats">[docs]</a>    <span class="k">def</span> <span class="nf">get_night_flats</span><span class="p">(</span><span class="n">image_collection</span><span class="p">,</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Identify flat images taken at night time</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method is not being used!</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            twilight_evening:</span>
<span class="sd">            twilight_morning:</span>

<span class="sd">        Returns:</span>
<span class="sd">            night_flat_list (list): List of flat file names.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="n">start_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_evening</span><span class="p">)</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>
        <span class="n">end_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_morning</span><span class="p">)</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>

        <span class="n">night_condition</span> <span class="o">=</span> <span class="p">((</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&lt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">start_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&gt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">end_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>

        <span class="n">dfobj</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">night_condition</span><span class="p">]</span>
        <span class="n">night_flat_list</span> <span class="o">=</span> <span class="n">dfobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">night_flat_list</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.get_day_flats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_day_flats">[docs]</a>    <span class="k">def</span> <span class="nf">get_day_flats</span><span class="p">(</span><span class="n">image_collection</span><span class="p">,</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get list of flat images taken in day time.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This method is not being used!</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            twilight_evening:</span>
<span class="sd">            twilight_morning:</span>

<span class="sd">        Returns:</span>
<span class="sd">            dayflat_list (list): File names of flat taken during daytime.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="n">start_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_evening</span><span class="p">)</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>
        <span class="n">end_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_morning</span><span class="p">)</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>

        <span class="n">day_condition</span> <span class="o">=</span> <span class="p">((</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&lt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">start_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span> <span class="o">|</span>
                         <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&gt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">end_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>

        <span class="n">dfobj</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">day_condition</span><span class="p">]</span>
        <span class="n">dayflat_list</span> <span class="o">=</span> <span class="n">dfobj</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">dayflat_list</span></div>

<div class="viewcode-block" id="Main.create_daymaster_flat"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.create_daymaster_flat">[docs]</a>    <span class="k">def</span> <span class="nf">create_daymaster_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_collection</span><span class="p">,</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">,</span> <span class="n">slit</span><span class="p">,</span> <span class="n">memory_limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates Master Flat of data taken at daytime</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            twilight_evening:</span>
<span class="sd">            twilight_morning:</span>
<span class="sd">            slit:</span>
<span class="sd">            memory_limit:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Creating dict. of flats. The key values are expected to be: GRATIN_ID and &#39;&lt;NO GRATING&gt;&#39;</span>
        <span class="c1"># if there is flat taken w/o grating</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">grtobj</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;BIAS&#39;</span><span class="p">)]</span>
        <span class="n">grtobj</span> <span class="o">=</span> <span class="n">grtobj</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">grt_list</span> <span class="o">=</span> <span class="n">grtobj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">dic_all_flats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">grt</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grt_list</span><span class="p">):</span>
            <span class="n">start_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_evening</span><span class="p">)</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>
            <span class="n">end_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_morning</span><span class="p">)</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>

            <span class="n">day_condition</span> <span class="o">=</span> <span class="p">((</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&lt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">start_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span> <span class="o">|</span>
                             <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&gt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">end_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>

            <span class="n">dfobj</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">day_condition</span><span class="p">]</span>
            <span class="n">dic_all_flats</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">grt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dfobj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Dict. for flats with grating and without grating</span>
        <span class="n">dic_flat</span> <span class="o">=</span> <span class="p">{</span><span class="n">grt</span><span class="p">:</span> <span class="n">dic_all_flats</span><span class="p">[</span><span class="n">grt</span><span class="p">]</span> <span class="k">for</span> <span class="n">grt</span> <span class="ow">in</span> <span class="n">dic_all_flats</span> <span class="k">if</span> <span class="n">grt</span> <span class="o">!=</span> <span class="s2">&quot;&lt;NO GRATING&gt;&quot;</span><span class="p">}</span>
        <span class="n">dic_flatnogrt</span> <span class="o">=</span> <span class="p">{</span><span class="n">grt</span><span class="p">:</span> <span class="n">dic_all_flats</span><span class="p">[</span><span class="n">grt</span><span class="p">]</span> <span class="k">for</span> <span class="n">grt</span> <span class="ow">in</span> <span class="n">dic_all_flats</span> <span class="k">if</span> <span class="n">grt</span> <span class="o">==</span> <span class="s2">&quot;&lt;NO GRATING&gt;&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dic_flat</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">grt</span> <span class="ow">in</span> <span class="n">dic_flat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combining and trimming flat frames:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">dic_flat</span><span class="p">[</span><span class="n">grt</span><span class="p">]:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>
                    <span class="n">flat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccd</span><span class="p">)</span>

                <span class="c1"># combinning and trimming slit edges</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Flat list length: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flat_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">master_flat</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">flat_list</span><span class="p">,</span>
                                                  <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                                                  <span class="n">mem_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">,</span>
                                                  <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                                  <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="c1"># self.master_flat.append(master_flat)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Flat list empty&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Finding slit edges... </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slit2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_slitedge</span><span class="p">(</span><span class="n">master_flat</span><span class="p">)</span>
                    <span class="n">master_flat</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">master_flat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>
                <span class="c1"># self.master_flat.append(master_flat)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_name</span><span class="p">(</span><span class="n">master_flat</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">get_name_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">master_flat</span>
                <span class="n">master_flat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done: master flat has been created --&gt; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_name</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Flat files have not been found.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dic_flatnogrt</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># No grating flats</span>
            <span class="k">for</span> <span class="n">grt</span> <span class="ow">in</span> <span class="n">dic_flatnogrt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">no_grating_ic</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;filter2&#39;</span><span class="p">]][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">grt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)]</span>
                <span class="n">no_grating_filters_1</span> <span class="o">=</span> <span class="n">no_grating_ic</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="n">no_grating_filters_2</span> <span class="o">=</span> <span class="n">no_grating_ic</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">filter_1</span> <span class="ow">in</span> <span class="n">no_grating_filters_1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">filter_2</span> <span class="ow">in</span> <span class="n">no_grating_filters_2</span><span class="p">:</span>
                        <span class="c1"># print(&quot;filter &quot;, filter_1, filter_2)</span>
                        <span class="n">no_grating_files</span> <span class="o">=</span> <span class="n">no_grating_ic</span><span class="o">.</span><span class="n">file</span><span class="p">[((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filter_1</span><span class="p">)</span> <span class="o">&amp;</span>
                                                               <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">filter_2</span><span class="p">))]</span>
                        <span class="c1"># print(no_grating_files)</span>
                        <span class="n">flatnogrt_list</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combining and trimming flat frame taken without grating:&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">no_grating_files</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                            <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>

                            <span class="n">flatnogrt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccd</span><span class="p">)</span>

                        <span class="c1"># combining and trimming slit edges</span>
                        <span class="n">master_flat_nogrt</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">flatnogrt_list</span><span class="p">,</span>
                                                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                                                            <span class="n">mem_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">,</span>
                                                            <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                            <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                                                            <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">master_flat_nogrt</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>

                        <span class="c1"># self.master_flat.append(master_flat_nogrt)</span>
                        <span class="c1"># filter_string = &#39;&#39;</span>
                        <span class="c1"># if filter_1 != &#39;&lt;NO FILTER&gt;&#39;:</span>
                        <span class="c1">#     filter_string += &#39;_&#39; + filter_1</span>
                        <span class="c1"># if filter_2 != &#39;&lt;NO FILTER&gt;&#39;:</span>
                        <span class="c1">#     filter_string += &#39;_&#39; + filter_2</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_name</span><span class="p">(</span><span class="n">master_flat_nogrt</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">get_name_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">master_flat_nogrt</span>
                        <span class="c1"># print self.master_flat_nogrt_name</span>
                        <span class="n">master_flat_nogrt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;Done: master flat have been created --&gt; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Flat files taken without grating not found or not necessary&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.create_master_bias"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.create_master_bias">[docs]</a>    <span class="k">def</span> <span class="nf">create_master_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_collection</span><span class="p">,</span> <span class="n">slit</span><span class="p">,</span> <span class="n">memory_limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates master bias</span>

<span class="sd">        Notes:</span>
<span class="sd">            It does not discriminate different ROI&#39;s</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            slit (bool): Whether to find slit limits and trim the image.</span>
<span class="sd">            memory_limit (float): Maximum amount of memory to use.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO (simon): Make it able to process different ROIs</span>

        <span class="n">bias_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combining and trimming bias frames:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;BIAS&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
            <span class="c1"># Finding overscan regions... getting from header and assuming it is at the right edge...</span>
            <span class="c1"># over_start = int((ccd.header[&#39;TRIMSEC&#39;].split(&#39;:&#39;))[1].split(&#39;,&#39;)[0]) - 1</span>
            <span class="c1"># over_start += 10 / int(ccd.header[&#39;CCDSUM&#39;][0])</span>
            <span class="c1"># ccd = ccdproc.subtract_overscan(ccd, median=True, overscan_axis=1, overscan=ccd[:, over_start:])</span>
            <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>

            <span class="n">bias_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">bias_list</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">mem_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">,</span> <span class="n">sigma_clip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">sigma_clip_low_thresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">sigma_clip_high_thresh</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>
            <span class="c1"># else:</span>
            <span class="c1"># self.master_bias = self.master_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;master_bias.fits&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Now I obtained bias... subtracting bias from master flat</span>
        <span class="c1"># Testing if master_flats are not empty arrays</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">master_flat_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">master_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">[</span><span class="n">master_flat_name</span><span class="p">]</span>
                <span class="n">fccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="n">master_flat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">)</span>
                <span class="n">fccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed. Bias subtracted. Flat corrected.&quot;</span>
                <span class="n">fccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">master_flat_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">ngccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">)</span>
            <span class="n">ngccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed. Bias subtracted. Flat corrected.&quot;</span>
            <span class="n">ngccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_flat_nogrt_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done: a master bias have been created --&gt; master_bias.fits&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.reduce_nightflats"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.reduce_nightflats">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_nightflats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_collection</span><span class="p">,</span> <span class="n">twilight_evening</span><span class="p">,</span> <span class="n">twilight_morning</span><span class="p">,</span> <span class="n">slit</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            twilight_evening:</span>
<span class="sd">            twilight_morning:</span>
<span class="sd">            slit (bool): Whether to find slit limits and trim the image.</span>
<span class="sd">            prefix (str): Prefix to name new file.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reducing flat frames taken during the night...&#39;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

        <span class="c1"># Night starts/ends 30min beforre/after twilight evening/morning</span>
        <span class="n">start_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_evening</span><span class="p">)</span> <span class="o">-</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>
        <span class="n">end_night</span> <span class="o">=</span> <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">twilight_morning</span><span class="p">)</span> <span class="o">+</span> <span class="n">TimeDelta</span><span class="p">(</span><span class="mf">1800.0</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isot</span>

        <span class="n">night_condition</span> <span class="o">=</span> <span class="p">((</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&gt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">start_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">Time</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date-obs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span><span class="o">.</span><span class="n">jd</span> <span class="o">&lt;</span> <span class="n">Time</span><span class="p">(</span><span class="n">end_night</span><span class="p">)</span><span class="o">.</span><span class="n">jd</span><span class="p">))</span>

        <span class="n">dfobj</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">][(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&lt;NO GRATING&gt;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">night_condition</span><span class="p">]</span>
        <span class="n">nightflat_list</span> <span class="o">=</span> <span class="n">dfobj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nightflat_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nightflat_list</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trimming and bias subtracting frame &#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39; --&gt; &#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed&quot;</span>
                <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">)</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias subtracted.&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias NOT subtracted.&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No bias subtraction!&#39;</span><span class="p">)</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done --&gt; Night flat frames have been reduced.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.reduce_arc"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.reduce_arc">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_arc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_collection</span><span class="p">,</span> <span class="n">slit</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reducing Arc frames...&#39;</span><span class="p">)</span>

        <span class="n">arc_list</span> <span class="o">=</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;COMP&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arc_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">arc_list</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reducing Arc frame &#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39; --&gt; &#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">)</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias subtracted.&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias NOT subtracted.&quot;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No bias subtraction!&#39;</span><span class="p">)</span>
                <span class="n">flat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_name</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flat_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">flat_correct</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">[</span><span class="n">flat_name</span><span class="p">])</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed. Flat corrected.&quot;</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No flat found to process &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done --&gt; Arc frames have been reduced.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.reduce_sci"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.reduce_sci">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_sci</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_collection</span><span class="p">,</span> <span class="n">slit</span><span class="p">,</span> <span class="n">clean</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            image_collection (object): ImageFileCollection object that contains all header information of all images.</span>
<span class="sd">            slit:</span>
<span class="sd">            clean:</span>
<span class="sd">            prefix:</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reducing Sci/Std frames...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">image_collection</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reducing Sci/Std frame &#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39; --&gt; &#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">ccd</span> <span class="o">=</span> <span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_collection</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">)</span>
            <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="n">fits_section</span><span class="o">=</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;TRIMSEC&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">slit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">trim_image</span><span class="p">(</span><span class="n">ccd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slit1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">slit2</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">subtract_bias</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bias</span><span class="p">)</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias subtracted.&quot;</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Data must be of only one kind. Please check your source data.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ValueError: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Bias NOT subtracted.&quot;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No bias subtraction!&#39;</span><span class="p">)</span>
            <span class="c1"># print ccd.header[&#39;filter&#39;], ccd.header[&#39;grating&#39;]</span>

            <span class="n">flat_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_flat_name</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flat_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># print flat_name, ccd.header[&#39;GRATING&#39;]</span>
                <span class="n">ccd</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">flat_correct</span><span class="p">(</span><span class="n">ccd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="p">[</span><span class="n">flat_name</span><span class="p">])</span>
                <span class="c1"># OBS: cosmic ray rejection is working pretty well by defining gain = 1. It&#39;s not working</span>
                <span class="c1"># when we use the real gain of the image. In this case the sky level changes by a factor</span>
                <span class="c1"># equal the gain.</span>
                <span class="c1"># Function to determine the sigfrac and objlim: y = 0.16 * exptime + 1.2</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">0.16</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.2</span>
                <span class="k">if</span> <span class="n">clean</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cleaning cosmic rays... &#39;</span><span class="p">)</span>
                    <span class="n">nccd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">cosmicray_lacosmic</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sigclip</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">sigfrac</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">objlim</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                                                         <span class="n">gain</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">]),</span>
                                                         <span class="n">readnoise</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RDNOISE&#39;</span><span class="p">]),</span>
                                                         <span class="n">satlevel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">sepmed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fsmode</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                                                         <span class="n">psfmodel</span><span class="o">=</span><span class="s1">&#39;gaussy&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cosmic rays have been cleaned &#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39; --&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">nccd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nccd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;GAIN&#39;</span><span class="p">])</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed. Flat corrected.&quot;</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Cosmic rays rejected.&quot;</span>
                    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;c&#39;</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">nccd</span><span class="p">,</span> <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">clean</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">ccd</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HISTORY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Trimmed, Flat corrected.&quot;</span>
                <span class="n">ccd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No flat found to process &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Done: Sci/Std frames have been reduced.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Main.get_flat_name"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_flat_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_flat_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">get_name_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reproduce the name of a suitable master flat and check if exist.</span>

<span class="sd">        Using the header information it construct the name of the master flat. For Custom mode it also reads the</span>
<span class="sd">        GRT_ANG and CAM_ANG values and calculates the center wavelength which will be included in the name after MODE</span>
<span class="sd">        in nanometers.</span>

<span class="sd">        Examples:</span>
<span class="sd">            master_flat_2100_CUSTOM_650nm.fits</span>

<span class="sd">        Args:</span>
<span class="sd">            header (object): FITS header object from astropy.io.fits</span>
<span class="sd">            get_name_only (bool): In order to find the right master flat for an image using its header.</span>

<span class="sd">        Returns:</span>
<span class="sd">            flat_name (str): Name of master flat in the format: &#39;master_flat[_grating][_mode][_filter1][_filter2].fits&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">grating</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Grating part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&lt;NO GRATING&gt;&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Imaging&#39;</span><span class="p">:</span>
                    <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_nogrt&#39;</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;KeyError: Blue Camera&#39;</span><span class="p">)</span>
                <span class="c1"># if slit is no_mask it means is imaging</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cam_targ&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_nogrt&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grating</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">grating</span>
            <span class="c1"># Mode for the grating part of the flat name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;KeyError: Blue Camera&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># it means it is Custom mode</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;wavmode&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;Custom&#39;</span><span class="p">:</span>
                    <span class="n">central_wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_central_wavelength</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">central_wavelength</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;WAVMODE: </span><span class="si">%s</span><span class="s1"> not supported&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="c1"># First filter wheel part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&lt;NO FILTER&gt;&#39;</span><span class="p">:</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
        <span class="c1"># Second filter wheel part of the flat name</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&lt;NO FILTER&gt;&#39;</span><span class="p">:</span>
            <span class="n">name_text</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;filter2&#39;</span><span class="p">]</span>

        <span class="n">flat_name</span> <span class="o">=</span> <span class="s1">&#39;master_flat&#39;</span> <span class="o">+</span> <span class="n">name_text</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

        <span class="k">if</span> <span class="n">flat_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_flat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">get_name_only</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Master flat Name: &#39;</span> <span class="o">+</span> <span class="n">flat_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flat_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;There is no flat suitable for use&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Main.get_central_wavelength"><a class="viewcode-back" href="../../goodman_ccd.html#goodman_ccd.goodman_ccdreduction.Main.get_central_wavelength">[docs]</a>    <span class="k">def</span> <span class="nf">get_central_wavelength</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
        <span class="n">grating_frequency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[a-zA-Z-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;grating&#39;</span><span class="p">]))</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;grt_ang&#39;</span><span class="p">])</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;cam_ang&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;grt_ang&#39;</span><span class="p">])</span>
        <span class="n">center_wavelength</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="n">e6</span> <span class="o">/</span> <span class="n">grating_frequency</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">center_wavelength</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;_</span><span class="si">{:d}</span><span class="s1">nm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">center_wavelength</span><span class="p">)))</span></div></div>


        <span class="c1"># def run(self):</span>

        <span class="c1"># cleaning up the reduction dir</span>
        <span class="c1"># self.clean_path(self.red_path)</span>

        <span class="c1"># Fixing header and shape of raw data</span>
        <span class="c1"># self.fix_header_and_shape(self.raw_path, self.red_path, prefix=&#39;h.&#39;, overwrite=True)</span>

        <span class="c1"># Create image file collection for raw data</span>
        <span class="c1"># ic = ImageFileCollection(self.red_path)</span>

        <span class="c1"># Getting twilight time</span>
        <span class="c1"># twi_eve, twi_mor = self.get_twilight_time(ic, self.observatory, self.longitude, self.latitude,</span>
        <span class="c1">#                                           self.elevation, self.timezone, self.description)</span>
        <span class="c1"># Create master_flats</span>
        <span class="c1"># self.create_daymaster_flat(ic, twi_eve, twi_mor, self.args.slit, self.memlim)</span>

        <span class="c1"># Create master bias</span>
        <span class="c1"># if len(ic.files_filtered(obstype=&#39;BIAS&#39;)) &gt; 0:</span>
        <span class="c1"># self.create_master_bias(ic, self.args.slit, self.memlim)</span>
        <span class="c1"># else:</span>
        <span class="c1"># log.info(&#39;No bias detected&#39;)</span>

        <span class="c1"># Reduce Night Flat frames (if they exist)</span>
        <span class="c1"># self.reduce_nightflats(ic, twi_eve, twi_mor, self.args.slit, prefix=&#39;z&#39;)</span>

        <span class="c1"># Reduce Arc frames</span>
        <span class="c1"># self.reduce_arc(ic, self.args.slit, prefix=&#39;fz&#39;)</span>

        <span class="c1"># Reduce Sci frames</span>
        <span class="c1"># self.reduce_sci(ic, self.args.slit, self.clean, prefix=&#39;fz&#39;)</span>

        <span class="c1"># return</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># # Parsing Arguments ---</span>
    <span class="c1"># parser = argparse.ArgumentParser(description=&quot;PyGoodman CCD Reduction - CCD reductions for &quot;</span>
    <span class="c1">#                                              &quot;Goodman spectroscopic data&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># parser.add_argument(&#39;-c&#39;, &#39;--clean&#39;, action=&#39;store_true&#39;,</span>
    <span class="c1">#                     help=&quot;Clean cosmic rays from science data.&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># parser.add_argument(&#39;-s&#39;, &#39;--slit&#39;, action=&#39;store_true&#39;,</span>
    <span class="c1">#                     help=&quot;Find slit edge to make an additional trimming (recommended).&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># parser.add_argument(&#39;raw_path&#39;, metavar=&#39;raw_path&#39;, type=str, nargs=1,</span>
    <span class="c1">#                     help=&quot;Full path to raw data (e.g. /home/jamesbond/soardata/).&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># parser.add_argument(&#39;red_path&#39;, metavar=&#39;red_path&#39;, type=str, nargs=1,</span>
    <span class="c1">#                     help=&quot;Full path to reduced data (e.g /home/jamesbond/soardata/RED/).&quot;)</span>
    <span class="c1">#</span>
    <span class="c1"># # parser.add_argument(&#39;--red-camera&#39;, action=&#39;store_true&#39;, default=False, dest=&#39;red_camera&#39;,</span>
    <span class="c1"># #                    help=&#39;Enables Goodman Red Camera&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># args = parser.parse_args()</span>

    <span class="n">main</span> <span class="o">=</span> <span class="n">Main</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>

<span class="c1"># else:</span>
<span class="c1">#    print(&#39;goodman_ccdreduction.py is not being executed as main.&#39;)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Goodman Pipelines 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Simon Torres.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>